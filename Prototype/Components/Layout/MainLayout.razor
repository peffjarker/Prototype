@* Components/Layout/MainLayout.razor *@
@using Prototype.Components.Layout
@using Prototype.Components.Layout.Navigation.Sidebar
@using Prototype.Components.Services
@inherits LayoutComponentBase
@implements IDisposable
@inject ISidebarState Sidebar

<TelerikRootComponent>
    <Prototype.Components.Layout.Navigation.NavMenu />

    <div class="ptl-page @(Sidebar.IsCollapsed ? "sidebar-collapsed" : "")">
        <!-- Sidebar -->
        <aside class="ptl-sidebar">
            <!-- Header with dealer selector -->
            <SidebarHeader OnFranchiseChanged="@HandleFranchiseChanged" />

            <!-- Scrollable content area -->
            @if (!Sidebar.IsCollapsed)
            {
                <div class="sidebar-content">
                    <SidebarSections Width="255px"
                                     Sections="@Sidebar.Sections"
                                     SelectedBySection="@Sidebar.SelectedBySection"
                                     OnItemSelected="@HandleItemSelected"
                                     OnFranchiseChanged="@HandleFranchiseChanged" />
                </div>
            }

            <!-- Footer with settings and collapse toggle -->
            <SidebarFooter />
        </aside>

        <!-- Main content area -->
        <main class="ptl-content">
            <article class="content px-4">
                @Body
            </article>
        </main>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>
</TelerikRootComponent>

@code {
    protected override void OnInitialized()
    {
        Sidebar.StateChanged += OnSidebarChanged;
    }

    private void OnSidebarChanged() => InvokeAsync(StateHasChanged);

    private async Task HandleItemSelected(SidebarItem item)
    {
        if (Sidebar.ItemSelectedHandler != null)
            await Sidebar.ItemSelectedHandler(item);
    }

    private async Task HandleFranchiseChanged(string? dealerId)
    {
        // Handle franchise/dealer selection change
        Console.WriteLine($"Dealer changed to: {dealerId ?? "none"}");
        await Task.CompletedTask;
    }

    public void Dispose()
    {
        Sidebar.StateChanged -= OnSidebarChanged;
    }
}

<style>
    html, body {
        overflow: hidden;
        height: 100vh;
        margin: 0;
        padding: 0;
    }

    .ptl-page {
        display: grid;
        grid-template-columns: 260px 1fr;
        height: calc(100vh - 52px);
        transition: grid-template-columns 0.25s ease;
        background-color: var(--app-bg);
    }

        .ptl-page.sidebar-collapsed {
            grid-template-columns: 52px 1fr;
        }

    .ptl-sidebar {
        background-color: var(--nav-bg);
        display: flex;
        flex-direction: column;
        transition: all 0.25s ease;
        overflow: hidden;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0; /* Important for flex children with scroll */
        background-color: var(--nav-bg);
    }

    .ptl-content {
        background-color: var(--app-bg);
        color: var(--text);
        overflow: auto;
        height: 100%;
    }

    .content {
        padding: 1rem;
    }

    #blazor-error-ui {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #ffefef;
        color: #a33;
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--border);
        font-size: 0.9rem;
        display: none;
    }

        #blazor-error-ui .reload {
            margin-right: 1rem;
            text-decoration: underline;
        }

        #blazor-error-ui .dismiss {
            float: right;
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
        }

    /* Scrollbar styling for better appearance integration */
    .sidebar-content::-webkit-scrollbar {
        width: 8px;
    }

    .sidebar-content::-webkit-scrollbar-track {
        background-color: var(--nav-bg);
    }

    .sidebar-content::-webkit-scrollbar-thumb {
        background-color: var(--border);
        border-radius: 4px;
    }

        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background-color: var(--border-strong);
        }

    /* Ensure smooth transitions when appearance changes */
    * {
        transition-property: background-color, color, border-color;
        transition-duration: var(--transition-duration);
        transition-timing-function: ease;
    }

    /* Dark mode support through appearance settings */
    @@media (prefers-color-scheme: dark) {
        /* Dark mode will be handled by appearance-manager.js */
        /* These are fallback values if JS fails to load */
        : root

    {
        --app-bg: #0f172a;
        --nav-bg: #1a1f2e;
        --text: #f1f5f9;
        --border: #2d3748;
    }

    }
</style>
