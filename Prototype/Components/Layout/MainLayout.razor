@* Components/Layout/MainLayout.razor *@
@using Prototype.Components.Layout
@using Prototype.Components.Layout.Navigation.Sidebar
@using Prototype.Components.Services
@inherits LayoutComponentBase
@implements IDisposable
@inject ISidebarState Sidebar

<TelerikRootComponent>
    <Prototype.Components.Layout.Navigation.NavMenu />

    <div class="ptl-page @(Sidebar.IsCollapsed ? "sidebar-collapsed" : "")">
        <!-- Sidebar -->
        <aside class="ptl-sidebar">
            <!-- Header with dealer selector -->
            <SidebarHeader OnFranchiseChanged="@HandleFranchiseChanged" />

            <!-- Scrollable content area -->
            @if (!Sidebar.IsCollapsed)
            {
                <div class="sidebar-content">
                    <SidebarSections Width="255px"
                                     Sections="@Sidebar.Sections"
                                     SelectedBySection="@Sidebar.SelectedBySection"
                                     OnItemSelected="@HandleItemSelected"
                                     OnFranchiseChanged="@HandleFranchiseChanged" />
                </div>
            }

            <!-- Footer with settings and collapse toggle -->
            <SidebarFooter />
        </aside>

        <!-- Main content area -->
        <main class="ptl-content">
            <article class="content px-4">
                @Body
            </article>
        </main>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>
</TelerikRootComponent>

@code {
    protected override void OnInitialized()
    {
        Sidebar.StateChanged += OnSidebarChanged;
    }

    private void OnSidebarChanged() => InvokeAsync(StateHasChanged);

    private async Task HandleItemSelected(SidebarItem item)
    {
        if (Sidebar.ItemSelectedHandler != null)
            await Sidebar.ItemSelectedHandler(item);
    }

    private async Task HandleFranchiseChanged(string? dealerId)
    {
        // Handle franchise/dealer selection change
        Console.WriteLine($"Dealer changed to: {dealerId ?? "none"}");
        await Task.CompletedTask;
    }

    public void Dispose()
    {
        Sidebar.StateChanged -= OnSidebarChanged;
    }
}

<style>
    .ptl-page {
        display: grid;
        grid-template-columns: 260px 1fr;
        height: calc(100vh - 52px);
        transition: grid-template-columns 0.25s ease;
    }

        .ptl-page.sidebar-collapsed {
            grid-template-columns: 52px 1fr;
        }

    .ptl-sidebar {
        border-right: 1px solid #e5e7eb;
        background: #f9fafb;
        display: flex;
        flex-direction: column;
        transition: all 0.25s ease;
        height: 100%;
        overflow: hidden;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0; /* Important for flex children with scroll */
    }

    .ptl-content {
        background: #fff;
        overflow: auto;
        height: 100%;
    }

    .content {
        padding: 1rem;
    }

    #blazor-error-ui {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #ffefef;
        color: #a33;
        padding: 0.75rem 1rem;
        border-top: 1px solid #e5e7eb;
        font-size: 0.9rem;
        display: none;
    }

        #blazor-error-ui .reload {
            margin-right: 1rem;
            text-decoration: underline;
        }

        #blazor-error-ui .dismiss {
            float: right;
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
        }
</style>

<style>
    .ptl-page {
        display: grid;
        grid-template-columns: 260px 1fr;
        height: calc(100vh - 52px);
        transition: grid-template-columns 0.25s ease;
    }

        .ptl-page.sidebar-collapsed {
            grid-template-columns: 52px 1fr;
        }

    .ptl-sidebar {
        border-right: 1px solid #e5e7eb;
        background: #f9fafb;
        display: flex;
        flex-direction: column;
        transition: all 0.25s ease;
        height: 100%;
        overflow: hidden;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0; /* Important for flex children with scroll */
    }

    .ptl-content {
        background: #fff;
        overflow: auto;
        height: 100%;
    }

    .content {
        padding: 1rem;
    }

    #blazor-error-ui {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #ffefef;
        color: #a33;
        padding: 0.75rem 1rem;
        border-top: 1px solid #e5e7eb;
        font-size: 0.9rem;
        display: none;
    }

        #blazor-error-ui .reload {
            margin-right: 1rem;
            text-decoration: underline;
        }

        #blazor-error-ui .dismiss {
            float: right;
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
        }
</style>
