@* Components/Layout/NavMenu.razor *@
@using System
@using System.Linq
@using System.Collections.Generic
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Prototype.Components.SharedComponents.Search
@using Telerik.Blazor
@using Telerik.Blazor.Components
@using Services
@using global::Services
@implements IDisposable
@inject NavigationManager Nav
@inject IUrlState Url

<TelerikAppBar Position="AppBarPosition.Top" Class="appbar">
    <AppBarSection Class="appbar-left">
        <a href="@Url.BuildHref("/")" class="brand" aria-label="Home">
            <img class="brand-logo" src="Cornwell_Tools_logo.png" alt="IBN Logo" />
            <div class="brand-stack">
                <span class="brand-text">IBN</span>
                <span class="brand-sub">Dealer Suite</span>
            </div>
        </a>

        <div class="nav-divider" role="presentation"></div>

        <nav class="primary-nav" aria-label="Primary">
            @foreach (var item in PrimaryMenuItems)
            {
                <button type="button"
                        class="nav-item @GetActiveClass(item.Href)"
                        @onclick="@(() => OnMenuLinkClick(item.Href))"
                        title="@item.Text">
                    <TelerikSvgIcon Icon="@item.Icon" />
                    <span class="nav-label">@item.Text</span>
                </button>
            }
        </nav>
    </AppBarSection>

    <AppBarSection Class="appbar-center">
        <GlobalSearch />
    </AppBarSection>

    <AppBarSection Class="appbar-right">
        <div class="quick-actions" aria-label="Quick actions">
            <button type="button" class="action-btn" title="Help & Documentation" @onclick="NavigateToHelp">
                <TelerikSvgIcon Icon="@SvgIcon.QuestionCircle" />
            </button>

            <button type="button"
                    class="action-btn notification-btn"
                    title="Notifications"
                    @onclick="ToggleNotifications"
                    @onclick:stopPropagation="true">
                <TelerikSvgIcon Icon="@SvgIcon.Bell" />
                @if (_unreadCount > 0)
                {
                    <span class="notification-badge">@(_unreadCount > 9 ? "9+" : _unreadCount.ToString())</span>
                }
            </button>

            <button type="button" class="action-btn" title="Settings" @onclick="NavigateToSettings">
                <TelerikSvgIcon Icon="@SvgIcon.Gear" />
            </button>
        </div>

        <div class="nav-divider" role="presentation"></div>

        <TelerikDropDownButton Class="user-menu" ShowArrowButton="false">
            <DropDownButtonContent>
                <div class="user-menu-trigger" title="Account">
                    <div class="user-avatar large">
                        <span>JP</span>
                    </div>
                </div>
            </DropDownButtonContent>
            <DropDownButtonItems>
                <DropDownButtonItem OnClick="@(() => NavigateToProfile())">
                    <TelerikSvgIcon Icon="@SvgIcon.User" />
                    <span>My Profile</span>
                </DropDownButtonItem>
                <DropDownButtonItem OnClick="@(() => NavigateToAppearance())">
                    <TelerikSvgIcon Icon="@SvgIcon.Palette" />
                    <span>Appearance</span>
                </DropDownButtonItem>
            </DropDownButtonItems>
        </TelerikDropDownButton>
    </AppBarSection>
</TelerikAppBar>

@if (_showNotifications)
{
    <div class="notifications-overlay" @onclick="CloseNotifications"></div>
    <div class="notifications-popover" role="dialog" aria-label="Notifications">
        <div class="notifications-header">
            <h3>Notifications</h3>
            <button type="button" class="mark-read-btn" @onclick="MarkAllAsRead">Mark all read</button>
        </div>
        <div class="notifications-list">
            @if (_notifications.Any())
            {
                @foreach (var notification in _notifications)
                {
                    <div class="notification-item @(notification.IsRead ? "" : "unread")"
                         @onclick="@(() => HandleNotificationClick(notification))">
                        <TelerikSvgIcon Icon="@notification.Icon" Class="@($"notification-icon {notification.IconClass}")" />
                        <div class="notification-content">
                            <p class="notification-title">@notification.Title</p>
                            <span class="notification-time">@notification.TimeAgo</span>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="notifications-empty">
                    <TelerikSvgIcon Icon="@SvgIcon.Bell" />
                    <p>No new notifications</p>
                </div>
            }
        </div>
        <div class="notifications-footer">
            <a href="@Url.BuildHref("/notifications")" @onclick="CloseNotifications">View all notifications</a>
        </div>
    </div>
}

<TelerikDrawer TItem="object"
               @bind-Expanded="drawerOpen"
               Mode="DrawerMode.Overlay"
               Width="300px"
               Class="mobile-drawer">
    <Template>
        <div class="drawer-header">
            <a href="@Url.BuildHref("/")" class="drawer-brand">
                <img class="drawer-logo" src="Cornwell_Tools_logo.png" alt="IBN Logo" />
                <div class="brand-stack">
                    <span class="brand-text">IBN</span>
                    <span class="brand-sub">Dealer Suite</span>
                </div>
            </a>
            <button type="button" class="drawer-close" @onclick="@(() => drawerOpen = false)">
                <TelerikSvgIcon Icon="@SvgIcon.X" />
            </button>
        </div>

        <div class="drawer-user">
            <div class="user-avatar">
                <span>JD</span>
            </div>
            <div class="user-info">
                <div class="user-name">John Doe</div>
                <div class="user-role">Administrator</div>
            </div>
        </div>

        <div class="drawer-search">
            <GlobalSearch />
        </div>

        <div class="drawer-nav">
            <div class="drawer-section-title">Navigation</div>
            @foreach (var item in PrimaryMenuItems)
            {
                <div class="drawer-item @GetActiveClass(item.Href)"
                     @onclick="@(() => OnMobileMenuClick(item.Href))">
                    <TelerikSvgIcon Icon="@item.Icon" />
                    <span>@item.Text</span>
                </div>
            }
        </div>

        <div class="drawer-nav">
            <div class="drawer-section-title">Quick Actions</div>
            <div class="drawer-item" @onclick="@(() => OnMobileMenuClick("/help"))">
                <TelerikSvgIcon Icon="@SvgIcon.QuestionCircle" />
                <span>Help & Documentation</span>
            </div>
            <div class="drawer-item" @onclick="@(() => OnMobileMenuClick("/notifications"))">
                <TelerikSvgIcon Icon="@SvgIcon.Bell" />
                <span>Notifications</span>
                @if (_unreadCount > 0)
                {
                    <span class="drawer-badge">@_unreadCount</span>
                }
            </div>
            <div class="drawer-item" @onclick="@(() => OnMobileMenuClick("/settings"))">
                <TelerikSvgIcon Icon="@SvgIcon.Gear" />
                <span>Settings</span>
            </div>
        </div>

        <div class="drawer-nav">
            <div class="drawer-section-title">Account</div>
            <div class="drawer-item" @onclick="@(() => OnMobileMenuClick("/profile"))">
                <TelerikSvgIcon Icon="@SvgIcon.User" />
                <span>My Profile</span>
            </div>
            <div class="drawer-item" @onclick="@(() => OnMobileMenuClick("/dealership"))">
                <TelerikSvgIcon Icon="@SvgIcon.File" />
                <span>My Dealership</span>
            </div>
            <div class="drawer-item" @onclick="@(() => OnMobileMenuClick("/analytics"))">
                <TelerikSvgIcon Icon="@SvgIcon.ChartLineMarkers" />
                <span>Analytics</span>
            </div>
            <div class="drawer-item sign-out" @onclick="SignOut">
                <TelerikSvgIcon Icon="@SvgIcon.Logout" />
                <span>Sign Out</span>
            </div>
        </div>
    </Template>
    <DrawerContent />
</TelerikDrawer>

@code
{
    private bool drawerOpen = false;
    private bool _showNotifications = false;
    private int _unreadCount = 3;
    private string? currentPath;
    private List<NotificationItem> _notifications = new();

    private readonly List<MenuLink> PrimaryMenuItems =
    [
        new("PO Transfer", "/po-transfer/items-on-order?status=All", SvgIcon.ArrowsSwap),
        new("Product", "/product/webcat?class=All Items", SvgIcon.EditTools),
        new("Tech Credit", "/techcredit/customerinformation?status=All", SvgIcon.Dollar)
    ];

    protected override void OnInitialized()
    {
        currentPath = Nav.ToBaseRelativePath(Nav.Uri);
        Url.Changed += OnUrlChanged;
        LoadNotifications();
    }

    private void OnUrlChanged()
    {
        currentPath = Nav.ToBaseRelativePath(Nav.Uri);
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Url.Changed -= OnUrlChanged;
    }

    private void OnMenuLinkClick(string hrefBase)
    {
        var targetModule = GetModuleFromPath(hrefBase);
        var currentModule = GetModuleFromPath("/" + currentPath?.TrimStart('/'));

        string href;
        if (targetModule != currentModule)
        {
            var preserved = new Dictionary<string, string?>(StringComparer.OrdinalIgnoreCase);
            if (Url.Has("dealer"))
            {
                preserved["dealer"] = Url.Get("dealer");
            }
            href = Url.BuildHref(hrefBase, preserved, preserveCurrentState: false);
        }
        else
        {
            href = Url.BuildHref(hrefBase);
        }

        Nav.NavigateTo(href);
    }

    private void OnMobileMenuClick(string href)
    {
        drawerOpen = false;
        OnMenuLinkClick(href);
    }

    private static string GetModuleFromPath(string path)
    {
        if (string.IsNullOrWhiteSpace(path)) return "";
        var pathOnly = path.Split('?')[0];
        var segments = pathOnly.TrimStart('/').Split('/', StringSplitOptions.RemoveEmptyEntries);
        return segments.Length > 0 ? segments[0].ToLowerInvariant() : "";
    }

    private string GetActiveClass(string href)
        => IsActive(href) ? "is-active" : string.Empty;

    private bool IsActive(string href)
    {
        if (string.IsNullOrWhiteSpace(currentPath)) return href == "/";

        // Compare by module (first path segment)
        var currentModule = GetModuleFromPath("/" + currentPath.TrimStart('/'));
        var hrefModule = GetModuleFromPath(href);

        return !string.IsNullOrEmpty(hrefModule) &&
               string.Equals(currentModule, hrefModule, StringComparison.OrdinalIgnoreCase);
    }

    private void ToggleNotifications() => _showNotifications = !_showNotifications;

    private void CloseNotifications() => _showNotifications = false;

    private void MarkAllAsRead()
    {
        foreach (var n in _notifications) n.IsRead = true;
        _unreadCount = 0;
        StateHasChanged();
    }

    private void HandleNotificationClick(NotificationItem notification)
    {
        notification.IsRead = true;
        _unreadCount = _notifications.Count(n => !n.IsRead);

        if (!string.IsNullOrEmpty(notification.NavigationUrl))
        {
            Nav.NavigateTo(notification.NavigationUrl);
            _showNotifications = false;
        }

        StateHasChanged();
    }

    private void NavigateToHelp() => Nav.NavigateTo(Url.BuildHref("/help"));
    private void NavigateToSettings() => Nav.NavigateTo(Url.BuildHref("/settings"));
    private void NavigateToProfile() => Nav.NavigateTo(Url.BuildHref("/profile"));
    private void NavigateToDealership() => Nav.NavigateTo(Url.BuildHref("/dealership"));
    private void NavigateToAnalytics() => Nav.NavigateTo(Url.BuildHref("/analytics"));
    private void NavigateToAppearance() => Nav.NavigateTo(Url.BuildHref("/settings/appearance"));
    private void NavigateToSecurity() => Nav.NavigateTo(Url.BuildHref("/settings/security"));

    private void SignOut() => Nav.NavigateTo("/auth/signout", forceLoad: true);

    private void LoadNotifications()
    {
        _notifications = new List<NotificationItem>
        {
            new NotificationItem { Id = 1, Title = "New PO #45231 received", TimeAgo = "5 minutes ago", Icon = SvgIcon.Cart,            IsRead = false, NavigationUrl = "/po-transfer/purchase-orders" },
            new NotificationItem { Id = 2, Title = "Invoice #12456 paid",   TimeAgo = "1 hour ago",    Icon = SvgIcon.CheckCircle,     IsRead = false, NavigationUrl = "/invoices/12456" },
            new NotificationItem { Id = 3, Title = "Low inventory alert: 5 items", TimeAgo = "2 hours ago", Icon = SvgIcon.ExclamationCircle, IsRead = false, NavigationUrl = "/product/inventory" }
        };

        _unreadCount = _notifications.Count(n => !n.IsRead);
    }

    public sealed class MenuLink(string text, string href, ISvgIcon icon)
    {
        public string Text { get; } = text;
        public string Href { get; } = href;
        public ISvgIcon Icon { get; } = icon;
    }

    public class NotificationItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
        public string TimeAgo { get; set; } = "";
        public ISvgIcon Icon { get; set; } = SvgIcon.Bell;
        public string IconClass { get; set; } = "";
        public bool IsRead { get; set; }
        public string? NavigationUrl { get; set; }
    }
}