@* Components/Layout/Navigation/Sidebar/Sidebar.razor *@
@using Prototype.Components.Layout.Navigation.Sidebar
@using Services
@using global::Services
@inject IFranchiseService FranchiseService

@if (Sections.Count > 0)
{
    <div class="sidebar-sections" style="--ss-width:@Width;">
        @for (var i = 0; i < Sections.Count; i++)
        {
            var section = Sections[i];
            var sectionKey = section.SectionKey ?? section.Title ?? $"section-{i}";
            var isCollapsed = CollapsedSections.Contains(sectionKey);

            @if (section.IsFranchiseSelector)
            {
                <div class="ss-collapsible-wrapper @(isCollapsed ? "collapsed" : "")">
                    <header class="ss-collapsible-header" @onclick="() => ToggleSection(sectionKey)">
                        <span>Franchise</span>
                        <span class="ss-collapse-icon">▼</span>
                    </header>
                    <div class="ss-collapsible-content">
                        <div class="ss-collapsible-inner">
                            @{
                                var franchises = FranchiseService.GetFranchises();
                                var currentDealer = SelectedBySection.TryGetValue("dealer", out var d) ? d : null;
                            }
                            <FranchiseSelectorSection Franchises="@franchises"
                                                      SelectedDealerId="@currentDealer"
                                                      OnFranchiseChanged="@((dealerId) => HandleFranchiseChange(dealerId))" />
                        </div>
                    </div>
                </div>
                @if (i < Sections.Count - 1)
                {
                    <div class="ss-separator"><div></div></div>
                }
            }
            else
            {
                <div class="ss-collapsible-wrapper @(isCollapsed ? "collapsed" : "")">
                    <section class="ss-section">
                        <header class="ss-collapsible-header" @onclick="() => ToggleSection(sectionKey)">
                            <span>@(string.IsNullOrWhiteSpace(section.Title) ? section.SectionKey : section.Title)</span>
                            <span class="ss-collapse-icon">▼</span>
                        </header>
                        <div class="ss-collapsible-content">
                            <div class="ss-collapsible-inner">
                                @if (section.IsLegend)
                                {
                                    <ul class="ss-legend">
                                        @foreach (var item in section.Items)
                                        {
                                            <li class="ss-legend-item">
                                                <span class="dot" style="background:@(item.ColorHex ?? "#d0d0d0")"></span>
                                                <span class="text">@item.Text</span>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <ul class="ss-list">
                                        @foreach (var item in section.Items)
                                        {
                                            var isSelected = IsSelected(section, item);
                                            <li @key="(section.SectionKey ?? section.Title) + '|' + item.Text"
                                                class="ss-item @(isSelected ? "selected" : null)"
                                                @onclick="() => HandleSelect(section, item)">
                                                @if (!string.IsNullOrWhiteSpace(item.Icon))
                                                {
                                                    <span class="ss-item-icon">@((MarkupString)item.Icon)</span>
                                                }
                                                <span class="ss-item-text">@item.Text</span>
                                            </li>
                                        }
                                    </ul>
                                }
                            </div>
                        </div>
                    </section>
                </div>
                @if (i < Sections.Count - 1)
                {
                    <div class="ss-separator"><div></div></div>
                }
            }
        }
    </div>
}

@code {
    [Parameter] public IReadOnlyList<SidebarSection> Sections { get; set; } = Array.Empty<SidebarSection>();
    [Parameter] public IReadOnlyDictionary<string, string?> SelectedBySection { get; set; } = new Dictionary<string, string?>();
    [Parameter] public EventCallback<SidebarItem> OnItemSelected { get; set; }
    [Parameter] public EventCallback<string?> OnFranchiseChanged { get; set; }
    [Parameter] public string Width { get; set; } = "280px";
    [Parameter] public string HeaderColor { get; set; } = "#0c5ea8";
    [Parameter] public string AccentColor { get; set; } = "#0c5ea8";
    [Parameter] public string BackgroundColor { get; set; } = "#ffffff";

    // Track which sections are collapsed
    private HashSet<string> CollapsedSections { get; set; } = new();

    private void ToggleSection(string sectionKey)
    {
        if (CollapsedSections.Contains(sectionKey))
            CollapsedSections.Remove(sectionKey);
        else
            CollapsedSections.Add(sectionKey);
    }

    private bool IsSelected(SidebarSection section, SidebarItem item)
    {
        var key = section.SectionKey ?? section.Title ?? "";
        if (!SelectedBySection.TryGetValue(key, out var selectedValue))
            return false;
        return string.Equals(item.Key, selectedValue, StringComparison.OrdinalIgnoreCase);
    }

    private async Task HandleSelect(SidebarSection section, SidebarItem item)
    {
        await OnItemSelected.InvokeAsync(item);
    }

    private async Task HandleFranchiseChange(string? dealerId)
    {
        await OnFranchiseChanged.InvokeAsync(dealerId);
    }
}

<style>
    /* Modern sidebar with appearance CSS variables for theme support */
    .sidebar-sections {
        width: var(--ss-width);
        background: var(--page-bg);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        height: 100%;
    }

    /* Collapsible wrapper with subtle spacing */
    .ss-collapsible-wrapper {
        position: relative;
        margin: 0.5rem 0;
    }

        .ss-collapsible-wrapper:first-child {
            margin-top: var(--kendo-spacing-3); /* Add breathing room after header */
        }

    /* Refined collapsible header */
    .ss-collapsible-header {
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.625rem 1rem;
        background: var(--card-bg);
        border-radius: 8px;
        margin: 0 var(--kendo-spacing-2);
        transition: all var(--transition-duration) ease;
        font-weight: 500;
        font-size: 0.8125rem;
        color: var(--primary);
        letter-spacing: 0.015em;
        border: 1px solid var(--border);
        color: var(--text-secondary);
    }

        .ss-collapsible-header:hover {
            background: var(--hover-bg);
            border-color: var(--border-strong);
            box-shadow: var(--shadow-sm);
        }

        .ss-collapsible-header:active {
            background: var(--hover-bg);
            transform: scale(0.995);
        }

    /* Refined collapse icon using SVG-style character */
    .ss-collapse-icon {
        font-size: 0.625rem;
        color: var(--muted);
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        margin-left: auto;
        padding-left: var(--kendo-spacing-3);
        font-weight: 600;
    }

    .ss-collapsible-wrapper.collapsed .ss-collapse-icon {
        transform: rotate(-90deg);
    }

    .ss-collapsible-wrapper:not(.collapsed) .ss-collapse-icon {
        transform: rotate(0deg);
    }

    /* Smooth collapsible animation */
    .ss-collapsible-content {
        display: grid;
        grid-template-rows: 1fr;
        transition: grid-template-rows 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s ease;
        opacity: 1;
    }

    .ss-collapsible-wrapper.collapsed .ss-collapsible-content {
        grid-template-rows: 0fr;
        opacity: 0;
    }

    .ss-collapsible-inner {
        overflow: hidden;
        padding: 0.25rem var(--kendo-spacing-2) var(--kendo-spacing-2);
    }

    /* Section container */
    .ss-section {
        display: flex;
        flex-direction: column;
    }

    /* List with refined spacing */
    .ss-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    /* Modern item styling with appearance variables */
    .ss-item {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        padding: 0.5rem 0.875rem;
        cursor: pointer;
        transition: all var(--transition-duration) ease;
        border-radius: 6px;
        border-left: 2px solid transparent;
        font-size: 0.875rem;
        margin: 0 0.25rem;
        position: relative;
        color: var(--text-secondary);
    }

        .ss-item:hover {
            background: var(--hover-bg);
            border-left-color: var(--border-strong);
            color: var(--text);
        }

        .ss-item.selected {
            background: var(--sel-bg);
            border-left-color: var(--accent);
            color: var(--accent);
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(var(--accent-rgb), 0.1);
        }

            .ss-item.selected::before {
                content: '';
                position: absolute;
                left: 0;
                top: 50%;
                transform: translateY(-50%);
                width: 2px;
                height: 60%;
                background: var(--accent);
                border-radius: 0 2px 2px 0;
            }

    .ss-item-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.125rem;
        height: 1.125rem;
        flex-shrink: 0;
        color: var(--muted);
        transition: color var(--transition-duration) ease;
    }

    .ss-item:hover .ss-item-icon {
        color: var(--text-secondary);
    }

    .ss-item.selected .ss-item-icon {
        color: var(--accent);
    }

    .ss-item-text {
        font-size: 0.875rem;
        line-height: 1.4;
    }

    /* Refined legend styles with appearance variables */
    .ss-legend {
        list-style: none;
        margin: 0;
        padding: var(--kendo-spacing-2) 0.875rem;
    }

    .ss-legend-item {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        padding: 0.375rem 0;
    }

        .ss-legend-item .dot {
            width: 0.625rem;
            height: 0.625rem;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 0 0 2px var(--card-bg);
        }

        .ss-legend-item .text {
            font-size: 0.8125rem;
            color: var(--muted);
            line-height: 1.4;
        }

    /* Subtle separator using appearance variables */
    .ss-separator {
        padding: var(--kendo-spacing-3) 1rem;
    }

        .ss-separator div {
            height: 1px;
            background: linear-gradient(to right, transparent, var(--border) 15%, var(--border) 85%, transparent);
        }

    /* Franchise selector integration */
    .ss-collapsible-wrapper .franchise-selector-section {
        padding: 0;
        background: transparent;
    }

    /* Scrollbar styling for modern look using appearance variables */
    .sidebar-sections::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar-sections::-webkit-scrollbar-track {
        background: transparent;
    }

    .sidebar-sections::-webkit-scrollbar-thumb {
        background: var(--border-strong);
        border-radius: 3px;
    }

        .sidebar-sections::-webkit-scrollbar-thumb:hover {
            background: var(--muted);
        }

    /* Firefox scrollbar */
    .sidebar-sections {
        scrollbar-width: thin;
        scrollbar-color: var(--border-strong) transparent;
    }
</style>
