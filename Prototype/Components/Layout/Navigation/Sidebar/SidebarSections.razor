@* Components/Layout/Navigation/Sidebar/Sidebar.razor *@
@using Prototype.Components.Layout.Navigation.Sidebar
@using Services
@using global::Services
@inject IFranchiseService FranchiseService

@if (Sections.Count > 0)
{
    <div class="sidebar-sections" style="--ss-width:@Width; --ss-header:#@(HeaderColor.TrimStart('#')); --ss-accent:#@(AccentColor.TrimStart('#')); --ss-bg:#@(BackgroundColor.TrimStart('#'));">
        @for (var i = 0; i < Sections.Count; i++)
        {
            var section = Sections[i];
            var sectionKey = section.SectionKey ?? section.Title ?? $"section-{i}";
            var isCollapsed = CollapsedSections.Contains(sectionKey);

            @if (section.IsFranchiseSelector)
            {
                <div class="ss-collapsible-wrapper @(isCollapsed ? "collapsed" : "")">
                    <header class="ss-header ss-collapsible-header" @onclick="() => ToggleSection(sectionKey)">
                        <span>Franchise</span>
                        <span class="ss-collapse-icon">@(isCollapsed ? "▶" : "▼")</span>
                    </header>
                    <div class="ss-collapsible-content">
                        <div class="ss-collapsible-inner">
                            @{
                                var franchises = FranchiseService.GetFranchises();
                                var currentDealer = SelectedBySection.TryGetValue("dealer", out var d) ? d : null;
                            }
                            <FranchiseSelectorSection Franchises="@franchises"
                                                      SelectedDealerId="@currentDealer"
                                                      OnFranchiseChanged="@((dealerId) => HandleFranchiseChange(dealerId))" />
                        </div>
                    </div>
                </div>
                @if (i < Sections.Count - 1)
                {
                    <div class="ss-separator"><div></div></div>
                }
            }
            else
            {
                <div class="ss-collapsible-wrapper @(isCollapsed ? "collapsed" : "")">
                    <section class="ss-section">
                        <header class="ss-header ss-collapsible-header" @onclick="() => ToggleSection(sectionKey)">
                            <span>@(string.IsNullOrWhiteSpace(section.Title) ? section.SectionKey : section.Title)</span>
                            <span class="ss-collapse-icon">@(isCollapsed ? "▶" : "▼")</span>
                        </header>
                        <div class="ss-collapsible-content">
                            <div class="ss-collapsible-inner">
                                @if (section.IsLegend)
                                {
                                    <ul class="ss-legend">
                                        @foreach (var item in section.Items)
                                        {
                                            <li class="ss-legend-item">
                                                <span class="dot" style="background:@(item.ColorHex ?? "#d0d0d0")"></span>
                                                <span class="text">@item.Text</span>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <ul class="ss-list">
                                        @foreach (var item in section.Items)
                                        {
                                            var isSelected = IsSelected(section, item);
                                            <li @key="(section.SectionKey ?? section.Title) + '|' + item.Text"
                                                class="ss-item @(isSelected ? "selected" : null)"
                                                @onclick="() => HandleSelect(section, item)">
                                                @if (!string.IsNullOrWhiteSpace(item.Icon))
                                                {
                                                    <span class="ss-item-icon">@((MarkupString)item.Icon)</span>
                                                }
                                                <span class="ss-item-text">@item.Text</span>
                                            </li>
                                        }
                                    </ul>
                                }
                            </div>
                        </div>
                    </section>
                </div>
                @if (i < Sections.Count - 1)
                {
                    <div class="ss-separator"><div></div></div>
                }
            }
        }
    </div>
}

@code {
    [Parameter] public IReadOnlyList<SidebarSection> Sections { get; set; } = Array.Empty<SidebarSection>();
    [Parameter] public IReadOnlyDictionary<string, string?> SelectedBySection { get; set; } = new Dictionary<string, string?>();
    [Parameter] public EventCallback<SidebarItem> OnItemSelected { get; set; }
    [Parameter] public EventCallback<string?> OnFranchiseChanged { get; set; }
    [Parameter] public string Width { get; set; } = "280px";
    [Parameter] public string HeaderColor { get; set; } = "#0c5ea8";
    [Parameter] public string AccentColor { get; set; } = "#0c5ea8";
    [Parameter] public string BackgroundColor { get; set; } = "#ffffff";

    // Track which sections are collapsed
    private HashSet<string> CollapsedSections { get; set; } = new();

    private void ToggleSection(string sectionKey)
    {
        if (CollapsedSections.Contains(sectionKey))
            CollapsedSections.Remove(sectionKey);
        else
            CollapsedSections.Add(sectionKey);
    }

    private bool IsSelected(SidebarSection section, SidebarItem item)
    {
        var key = section.SectionKey ?? section.Title ?? "";
        if (!SelectedBySection.TryGetValue(key, out var selectedValue))
            return false;
        return string.Equals(item.Key, selectedValue, StringComparison.OrdinalIgnoreCase);
    }

    private async Task HandleSelect(SidebarSection section, SidebarItem item)
    {
        await OnItemSelected.InvokeAsync(item);
    }

    private async Task HandleFranchiseChange(string? dealerId)
    {
        await OnFranchiseChanged.InvokeAsync(dealerId);
    }
}

<style>
    /* Existing sidebar styles */
    .sidebar-sections {
        width: var(--ss-width);
        background: var(--ss-bg);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        height: 100%;
    }

    /* Collapsible wrapper */
    .ss-collapsible-wrapper {
        position: relative;
    }

    /* Collapsible header - make it clickable */
    .ss-collapsible-header {
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background-color 0.15s ease;
    }

        .ss-collapsible-header:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .ss-collapsible-header:active {
            background-color: rgba(0, 0, 0, 0.05);
        }

    /* Collapse icon */
    .ss-collapse-icon {
        font-size: 0.7rem;
        color: #64748b;
        transition: transform 0.2s ease;
        margin-left: auto;
        padding-left: 0.5rem;
    }

    .ss-collapsible-wrapper.collapsed .ss-collapse-icon {
        transform: rotate(0deg);
    }

    .ss-collapsible-wrapper:not(.collapsed) .ss-collapse-icon {
        transform: rotate(0deg);
    }

    /* Collapsible content with animation */
    .ss-collapsible-content {
        display: grid;
        grid-template-rows: 1fr;
        transition: grid-template-rows 0.3s ease, opacity 0.2s ease;
        opacity: 1;
    }

    .ss-collapsible-wrapper.collapsed .ss-collapsible-content {
        grid-template-rows: 0fr;
        opacity: 0;
    }

    .ss-collapsible-inner {
        overflow: hidden;
    }

    /* Section header styling */
    .ss-header {
        background: var(--ss-header);
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
        padding: 0.75rem 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .ss-section {
        display: flex;
        flex-direction: column;
    }

    /* List styles */
    .ss-list {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .ss-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        cursor: pointer;
        transition: background-color 0.15s ease;
        border-left: 3px solid transparent;
    }

        .ss-item:hover {
            background-color: #f8fafc;
        }

        .ss-item.selected {
            background-color: #e0f2fe;
            border-left-color: var(--ss-accent);
        }

    .ss-item-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.25rem;
        height: 1.25rem;
        flex-shrink: 0;
    }

    .ss-item-text {
        font-size: 0.875rem;
        color: #374151;
        line-height: 1.4;
    }

    /* Legend styles */
    .ss-legend {
        list-style: none;
        margin: 0;
        padding: 0.5rem 1rem;
    }

    .ss-legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0;
    }

        .ss-legend-item .dot {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .ss-legend-item .text {
            font-size: 0.8125rem;
            color: #6b7280;
            line-height: 1.4;
        }

    /* Separator */
    .ss-separator {
        padding: 0.5rem 1rem;
    }

        .ss-separator div {
            height: 1px;
            background: linear-gradient(to right, transparent, #e5e7eb 20%, #e5e7eb 80%, transparent);
        }

    /* Ensure franchise selector section doesn't have double padding */
    .ss-collapsible-wrapper .franchise-selector-section {
        padding: 0;
    }
</style>