@* Components/Layout/Navigation/Sidebar/Sidebar.razor *@
@using Prototype.Components.Layout.Navigation.Sidebar
@using Services
@using global::Services
@inject IFranchiseService FranchiseService

@if (Sections.Count > 0)
{
    <div class="sidebar-sections" style="--ss-width:@Width;">
        @for (var i = 0; i < Sections.Count; i++)
        {
            var section = Sections[i];
            var sectionKey = section.SectionKey ?? section.Title ?? $"section-{i}";
            var isCollapsed = CollapsedSections.Contains(sectionKey);

            @if (section.IsFranchiseSelector)
            {
                <div class="ss-collapsible-wrapper @(isCollapsed ? "collapsed" : "")">
                    <header class="ss-collapsible-header" @onclick="() => ToggleSection(sectionKey)">
                        <span>Franchise</span>
                        <span class="ss-collapse-icon">▼</span>
                    </header>
                    <div class="ss-collapsible-content">
                        <div class="ss-collapsible-inner">
                            @{
                                var franchises = FranchiseService.GetFranchises();
                                var currentDealer = SelectedBySection.TryGetValue("dealer", out var d) ? d : null;
                            }
                            <FranchiseSelectorSection Franchises="@franchises"
                                                      SelectedDealerId="@currentDealer"
                                                      OnFranchiseChanged="@((dealerId) => HandleFranchiseChange(dealerId))" />
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="ss-collapsible-wrapper @(isCollapsed ? "collapsed" : "")">
                    <section class="ss-section">
                        <header class="ss-collapsible-header" @onclick="() => ToggleSection(sectionKey)">
                            <span>@(string.IsNullOrWhiteSpace(section.Title) ? section.SectionKey : section.Title)</span>
                            <span class="ss-collapse-icon">▼</span>
                        </header>
                        <div class="ss-collapsible-content">
                            <div class="ss-collapsible-inner">
                                @if (section.IsLegend)
                                {
                                    <ul class="ss-legend">
                                        @foreach (var item in section.Items)
                                        {
                                            <li class="ss-legend-item">
                                                <span class="dot" style="background:@(item.ColorHex ?? "#d0d0d0")"></span>
                                                <span class="text">@item.Text</span>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <ul class="ss-list">
                                        @foreach (var item in section.Items)
                                        {
                                            var isSelected = IsSelected(section, item);
                                            <li @key="(section.SectionKey ?? section.Title) + '|' + item.Text"
                                                class="ss-item @(isSelected ? "selected" : null)"
                                                @onclick="() => HandleSelect(section, item)">
                                                @if (!string.IsNullOrWhiteSpace(item.Icon))
                                                {
                                                    <span class="ss-item-icon">@((MarkupString)item.Icon)</span>
                                                }
                                                <span class="ss-item-text">@item.Text</span>
                                            </li>
                                        }
                                    </ul>
                                }
                            </div>
                        </div>
                    </section>
                </div>
            }
        }
    </div>
}

@code {
    [Parameter] public IReadOnlyList<SidebarSection> Sections { get; set; } = Array.Empty<SidebarSection>();
    [Parameter] public IReadOnlyDictionary<string, string?> SelectedBySection { get; set; } = new Dictionary<string, string?>();
    [Parameter] public EventCallback<SidebarItem> OnItemSelected { get; set; }
    [Parameter] public EventCallback<string?> OnFranchiseChanged { get; set; }
    [Parameter] public string Width { get; set; } = "280px";
    [Parameter] public string HeaderColor { get; set; } = "#0c5ea8";
    [Parameter] public string AccentColor { get; set; } = "#0c5ea8";
    [Parameter] public string BackgroundColor { get; set; } = "#ffffff";

    // Track which sections are collapsed
    private HashSet<string> CollapsedSections { get; set; } = new();

    private void ToggleSection(string sectionKey)
    {
        if (CollapsedSections.Contains(sectionKey))
            CollapsedSections.Remove(sectionKey);
        else
            CollapsedSections.Add(sectionKey);
    }

    private bool IsSelected(SidebarSection section, SidebarItem item)
    {
        var key = section.SectionKey ?? section.Title ?? "";
        if (!SelectedBySection.TryGetValue(key, out var selectedValue))
            return false;
        return string.Equals(item.Key, selectedValue, StringComparison.OrdinalIgnoreCase);
    }

    private async Task HandleSelect(SidebarSection section, SidebarItem item)
    {
        await OnItemSelected.InvokeAsync(item);
    }

    private async Task HandleFranchiseChange(string? dealerId)
    {
        await OnFranchiseChanged.InvokeAsync(dealerId);
    }
}

<style>
    /* Clean, minimal sidebar matching Webcat styling */
    .sidebar-sections {
        width: var(--ss-width);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1 1 auto;
        min-height: 0; /* Critical for flex scrolling */
        /* background: #ffffff; */
    }

    /* Collapsible wrapper - minimal spacing */
    .ss-collapsible-wrapper {
        position: relative;
        margin: 0;
    }

        .ss-collapsible-wrapper:first-child {
            margin-top: 0.5rem;
        }

    /* Clean collapsible header - subtle and minimal */
    .ss-collapsible-header {
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 1rem;
        background: transparent;
        border-radius: 0;
        margin: 0;
        transition: background-color 0.15s ease;
        font-weight: 500;
        font-size: 0.8125rem;
        color: var(--muted);
        letter-spacing: 0.01em;
        border: none;
        border-bottom: 1px solid var(--nav-border);
    }

        .ss-collapsible-header:hover {
            /* background: #f8f9fa; */
        }

        .ss-collapsible-header:active {
            /* background: #e9ecef; */
        }

    /* Minimal collapse icon */
    .ss-collapse-icon {
        font-size: 0.625rem;
        color: var(--muted);
        transition: transform 0.2s ease;
        margin-left: auto;
        padding-left: 0.75rem;
        font-weight: 600;
    }

    .ss-collapsible-wrapper.collapsed .ss-collapse-icon {
        transform: rotate(-90deg);
    }

    .ss-collapsible-wrapper:not(.collapsed) .ss-collapse-icon {
        transform: rotate(0deg);
    }

    /* Smooth collapsible animation */
    .ss-collapsible-content {
        display: grid;
        grid-template-rows: 1fr;
        transition: grid-template-rows 0.25s ease, opacity 0.2s ease;
        opacity: 1;
    }

    .ss-collapsible-wrapper.collapsed .ss-collapsible-content {
        grid-template-rows: 0fr;
        opacity: 0;
    }

    .ss-collapsible-inner {
        overflow: hidden;
        padding: 0;
    }

    /* Section container */
    .ss-section {
        display: flex;
        flex-direction: column;
    }

    /* List - clean and compact like Webcat */
    .ss-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    /* Clean item styling matching Webcat image */
    .ss-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: background-color 0.1s ease;
        border-radius: 0;
        border-left: 3px solid transparent;
        font-size: 0.875rem;
        margin: 0;
        position: relative;
        color: var(--muted);
        /* border-bottom: 1px solid #f1f3f5; */
    }

        .ss-item:hover {
            background: #f8f9fa;
        }

        .ss-item.selected {
            background-color: color-mix(in srgb, var(--accent) 10%, transparent);
            border-left-color: var(--accent);
            color: var(--muted);
            font-weight: 400;
        }

    .ss-item-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1rem;
        height: 1rem;
        flex-shrink: 0;
        color: #868e96;
        transition: none;
    }

    .ss-item.selected .ss-item-icon {
        color: #495057;
    }

    .ss-item-text {
        font-size: 0.875rem;
        line-height: 1.4;
        flex: 1;
        padding-left: 8px;
        color: var(--muted);
    }

    /* Legend styles - keeping these similar but cleaner */
    .ss-legend {
        list-style: none;
        margin: 0;
        padding: 0.75rem 1rem;
    }

    .ss-legend-item {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        padding: 0.375rem 0;
    }

        .ss-legend-item .dot {
            width: 0.625rem;
            height: 0.625rem;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: none;
        }

        .ss-legend-item .text {
            font-size: 0.8125rem;
            color: #6c757d;
            line-height: 1.4;
        }

    /* Very subtle separator */
    .ss-separator {
        padding: 0.5rem 1rem;
    }

        .ss-separator div {
            height: 1px;
            background: #e9ecef;
        }

    /* Franchise selector integration */
    .ss-collapsible-wrapper .franchise-selector-section {
        padding: 0;
        background: transparent;
    }

    /* Minimal scrollbar styling */
    .sidebar-sections::-webkit-scrollbar {
        width: 8px;
    }

    .sidebar-sections::-webkit-scrollbar-track {
        background: transparent;
    }

    .sidebar-sections::-webkit-scrollbar-thumb {
        background: #ced4da;
        border-radius: 4px;
    }

        .sidebar-sections::-webkit-scrollbar-thumb:hover {
            background: #adb5bd;
        }

    /* Firefox scrollbar */
    .sidebar-sections {
        scrollbar-width: thin;
        scrollbar-color: #ced4da transparent;
    }
</style>
