@page "/product/prices"

@using Microsoft.AspNetCore.WebUtilities
@using Prototype.Components.Layout.Navigation.Sidebar
@using Prototype.Components.Pages.Product.Prices
@using Prototype.Components.SharedComponents
@using Prototype.Pages.Product
@using Telerik.Blazor
@using Telerik.Blazor.Components
@using static Prototype.Components.Pages.Product.Prices.PricesSeedData

@inherits PageWithSidebarBase

@inject IJSRuntime JS

<div class="wrap">
    <header class="header">
        <h3 class="title">View/Change Prices</h3>
    </header>

    <!-- Items List & Detail -->
    <section class="card items-section">
        <div class="items-layout">
            <!-- Items List -->
            <ItemList Items="@DisplayedItems"
                      SelectedItem="@Params.SelectedItem"
                      OnItemClick="@SelectItem" />

            <!-- Item Detail -->
            <div class="item-detail">
                @if (SelectedItemObject != null)
                {
                    <div class="pricing-detail">
                        <!-- Item Pricing Header -->
                        <div class="pricing-header-section">
                            <h4>Item Pricing</h4>

                            <div class="field">
                                <label>Item</label>
                                <input readonly value="@SelectedItemObject.Item" />
                            </div>

                            <div class="field">
                                <label>Description</label>
                                <input readonly value="@SelectedItemObject.Description" class="full-width" />
                            </div>

                            <div class="field-row">
                                <div class="field">
                                    <label>List Price</label>
                                    <input readonly value="@SelectedItemObject.ListPrice.ToString("C")" />
                                </div>
                                <div class="field">
                                    <label>Discount</label>
                                    <input readonly value="@SelectedItemObject.Discount" />
                                </div>
                            </div>

                            <div class="field-row">
                                <div class="field">
                                    <label>Category</label>
                                    <input readonly value="@SelectedItemObject.Category" />
                                </div>
                                <div class="field">
                                    <label>Subcategory</label>
                                    <input readonly value="@SelectedItemObject.Subcategory" />
                                </div>
                            </div>

                            <div class="field checkbox-field">
                                <label>
                                    <input type="checkbox" checked="@SelectedItemObject.TaxExempt" disabled />
                                    Tax Exempt
                                </label>
                            </div>
                        </div>

                        <!-- Price History Grid -->
                        <div class="price-history-section">
                            <TelerikGrid Data="@SelectedItemObject.PriceHistory"
                                         Pageable="false"
                                         Sortable="true"
                                         Height="300px"
                                         Class="price-grid">
                                <GridColumns>
                                    <GridColumn Field="@nameof(PriceHistoryEntry.Effective)" Title="Effective" Width="200px">
                                        <Template>
                                            @{
                                                var entry = (PriceHistoryEntry)context;
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <span>@entry.Effective.ToString("MM/dd/yyyy")</span>
                                                    @if (entry.HasCalendar)
                                                    {
                                                        <span style="color: #6c757d; font-size: 0.875em;">📅</span>
                                                    }
                                                </div>
                                            }
                                        </Template>
                                    </GridColumn>
                                    <GridColumn Field="@nameof(PriceHistoryEntry.LocalList)" Title="Local List" Width="150px" TextAlign="@ColumnTextAlign.Right">
                                        <Template>
                                            @{
                                                var entry = (PriceHistoryEntry)context;
                                                @entry.LocalList.ToString("C")
                                            }
                                        </Template>
                                    </GridColumn>
                                    <GridColumn Field="@nameof(PriceHistoryEntry.Disc)" Title="Disc" Width="120px" TextAlign="@ColumnTextAlign.Center" />
                                </GridColumns>
                            </TelerikGrid>
                        </div>

                        <!-- Promotions Grid -->
                        <div class="promotions-section">
                            <TelerikGrid Data="@SelectedItemObject.Promotions"
                                         Pageable="false"
                                         Sortable="true"
                                         Height="200px"
                                         Class="promo-grid">
                                <GridColumns>
                                    <GridColumn Field="@nameof(PromotionEntry.Year)" Title="Year" Width="120px" />
                                    <GridColumn Field="@nameof(PromotionEntry.Month)" Title="Month" Width="120px" />
                                    <GridColumn Field="@nameof(PromotionEntry.PromoList)" Title="Promo List" Width="150px" TextAlign="@ColumnTextAlign.Right">
                                        <Template>
                                            @{
                                                var promo = (PromotionEntry)context;
                                                @(promo.PromoList?.ToString("C") ?? "")
                                            }
                                        </Template>
                                    </GridColumn>
                                    <GridColumn Field="@nameof(PromotionEntry.PromoType)" Title="Promo Type" />
                                </GridColumns>
                            </TelerikGrid>
                        </div>
                    </div>
                }
                else
                {
                    <div class="detail-empty">
                        <p>Select an item to view pricing details</p>
                    </div>
                }
            </div>
        </div>
    </section>
</div>

@code {
    // Centralized parameters
    private PricesParameters Params = new();

    // Local UI state (not in URL)
    private string SearchText = "";

    // ============================================================
    // Page contract & URL bindings
    // ============================================================
    protected override string BasePath => "/product/prices";

    protected override IReadOnlyDictionary<string, string?> Scalars => Params.ToScalars();

    protected override IReadOnlyCollection<string> MultiValues => Array.Empty<string>();

    protected override void ReadFromUrl()
    {
        // Read raw values from URL
        Params = PricesParameters.FromUrl(Url);

        // Select first item if none selected
        if (string.IsNullOrEmpty(Params.SelectedItem))
        {
            Params.SelectedItem = DisplayedItems.FirstOrDefault()?.Item;
        }
    }

    // ============================================================
    // Sidebar facets
    // ============================================================
    protected override IEnumerable<Facet> Facets()
    {
        yield return new Facet(
            Key: "option",
            Title: "Option",
            Options: () => new[]
            {
                new FacetOption("Webcat", "Webcat",
                    Href: AppendPreserved(Url.BuildHref("/product/webcat",
                        new Dictionary<string, string?> { ["class"] = "All Items" }))),

                new FacetOption("Set Maintenance", "Set Maintenance",
                    Href: AppendPreserved(Url.BuildHref("/product/set-maintenance",
                        new Dictionary<string, string?> { ["class"] = "All Items" }))),

                new FacetOption("View/Change Prices", "View/Change Prices",
                    Href: AppendPreserved(Url.BuildHref("/product/prices",
                        new Dictionary<string, string?> { ["class"] = "All Items" })))
            }
        );

        yield return CommonFacets.ClassFacet;

        yield return CommonFacets.ItemLegend;
    }

    // ============================================================
    // Lifecycle
    // ============================================================
    protected override void OnInitialized()
    {
        SeedData();
        base.OnInitialized();
    }

    // ============================================================
    // Data & Filtering
    // ============================================================
    private List<PricingItem> AllItems = new();

    private List<PricingItem> DisplayedItems
    {
        get
        {
            var items = AllItems.AsEnumerable();

            if (Params.Class != "All Items")
                items = items.Where(x => x.Class == Params.Class);

            return items.ToList();
        }
    }

    private PricingItem? SelectedItemObject =>
        DisplayedItems.FirstOrDefault(x => x.Item == Params.SelectedItem);

    // ============================================================
    // Actions
    // ============================================================
    private void SelectItem(string itemNumber)
    {
        Params.SelectedItem = itemNumber;
        NavigateWithPageState();
    }

    private string GetItemStatusClass(PricingItem item)
    {
        var classes = new List<string>();
        if (item.IsDiscontinued) classes.Add("item-discontinued");
        if (item.IsPriceConfirm) classes.Add("item-price");
        if (item.IsDropShip) classes.Add("item-ds");
        return string.Join(" ", classes);
    }

    // ============================================================
    // Data seeding
    // ============================================================
    private void SeedData()
    {
        AllItems = PricesSeedData.GetItems();
    }
}