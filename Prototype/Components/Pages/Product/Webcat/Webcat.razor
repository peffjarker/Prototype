@page "/product/webcat"

@using System.Linq
@using Microsoft.AspNetCore.WebUtilities
@using Prototype.Components.Layout.Navigation.Sidebar
@using Prototype.Components.Pages.Product.Webcat
@using Prototype.Components.SharedComponents
@using Prototype.Pages.Product
@using Telerik.Blazor
@using Telerik.Blazor.Components
@using static Prototype.Components.Pages.Product.Webcat.WebcatSeedData

@inherits PageWithSidebarBase

@inject IJSRuntime JS

<div class="wrap">
    <header class="header">
        <h3 class="title">Webcat - Item Availability</h3>
    </header>

    <!-- Filter Panel -->
    <WebcatFilterPanel Params="@Params"
                       ParamsChanged="@OnFilterPanelChanged"
                       OnClear="@ClearFilters"
                       FilteredCount="@FilteredItems.Count"
                       TotalCount="@AllItems.Count"
                       Categories="@Categories"
                       Subcategories="@SubcategoriesForSelectedCategory"
                       Brands="@Brands"
                       ShipFromLocations="@ShipFromLocations" />

    <!-- Items List & Detail -->
    <section class="card items-section">
        <div class="items-layout">
            <!-- Items List -->
            <ItemList Items="@DisplayedItems"
                      SelectedItem="@Params.SelectedItem"
                      OnItemClick="@SelectItem" />

            <!-- Item Detail -->
            <div class="item-detail">
                @if (SelectedItemObject != null)
                {
                    <div class="detail-header">
                        <h4>@SelectedItemObject.Item - @SelectedItemObject.Description</h4>
                    </div>

                    <div class="detail-grid">
                        <div class="detail-section">
                            <div class="field-row">
                                <div class="field">
                                    <label>Item:</label>
                                    <input readonly value="@SelectedItemObject.Item" />
                                </div>
                                <div class="field">
                                    <label>Discount:</label>
                                    <select disabled>
                                        <option>@SelectedItemObject.Discount</option>
                                    </select>
                                </div>
                            </div>

                            <div class="field">
                                <label>Description:</label>
                                <input readonly value="@SelectedItemObject.Description" />
                            </div>

                            <div class="field-row">
                                <div class="field">
                                    <label>List Price:</label>
                                    <input readonly value="@SelectedItemObject.ListPrice.ToString("C")" />
                                </div>
                                <div class="field checkbox-field">
                                    <label>Drop Ship:</label>
                                    <input type="checkbox" checked="@SelectedItemObject.IsDropShip" disabled />
                                </div>
                            </div>

                            <div class="field-row">
                                <div class="field">
                                    <label>Warranty:</label>
                                    <input readonly value="@SelectedItemObject.Warranty" />
                                </div>
                                <div class="field">
                                    <label>Action:</label>
                                    <input readonly value="@SelectedItemObject.Action" />
                                </div>
                            </div>

                            <div class="field-row">
                                <div class="field">
                                    <label>Status:</label>
                                    <input readonly value="@SelectedItemObject.Status" />
                                </div>
                                <div class="field">
                                    <label>Category:</label>
                                    <input readonly value="@SelectedItemObject.Category" />
                                </div>
                            </div>

                            <div class="field-row">
                                <div class="field">
                                    <label>Class:</label>
                                    <input readonly value="@SelectedItemObject.Class" />
                                </div>
                                <div class="field">
                                    <label>Subcategory:</label>
                                    <input readonly value="@SelectedItemObject.Subcategory" />
                                </div>
                            </div>

                            <div class="field-row">
                                <div class="field">
                                    <label>Ship From:</label>
                                    <input readonly value="@SelectedItemObject.ShipFrom" />
                                </div>
                                <div class="field">
                                    <label>Brand:</label>
                                    <input readonly value="@SelectedItemObject.Brand" />
                                </div>
                            </div>

                            <div class="field-row">
                                <div class="field">
                                    <label>Replaced by:</label>
                                    <input readonly value="@SelectedItemObject.ReplacedBy" />
                                </div>
                                <div class="field">
                                    <label>Supplier:</label>
                                    <input readonly value="@SelectedItemObject.Supplier" />
                                </div>
                            </div>

                            <div class="field-row">
                                <div class="field">
                                    <label>Buy Qty:</label>
                                    <input readonly value="@SelectedItemObject.BuyQty" />
                                </div>
                                <div class="field">
                                    <label>Sell Qty:</label>
                                    <input readonly value="@SelectedItemObject.SellQty" />
                                </div>
                            </div>
                        </div>

                        <!-- Inventory Summary -->
                        <InventorySummaryBar OnHand="@SelectedItemObject.OnHand"
                                             Pending="@SelectedItemObject.Pending"
                                             OnOrder="@SelectedItemObject.OnOrder"
                                             Alloc="@SelectedItemObject.Alloc"
                                             BKO="@SelectedItemObject.BKO"
                                             InTransit="@SelectedItemObject.InTransit"
                                             Needs="@SelectedItemObject.Needs"
                                             Interests="@SelectedItemObject.Interests" />

                        <!-- Pricing Info -->
                        <div class="pricing-section">
                            <div class="pricing-header">Effective Pricing</div>
                            <div class="pricing-grid">
                                <div class="pricing-row">
                                    <span class="pricing-label">Effective:</span>
                                    <span class="pricing-value">@SelectedItemObject.EffectiveDate?.ToString("MM/dd/yyyy")</span>
                                </div>
                                <div class="pricing-row">
                                    <span class="pricing-label">Local List:</span>
                                    <span class="pricing-value">@SelectedItemObject.LocalListPrice.ToString("C")</span>
                                </div>
                                <div class="pricing-row">
                                    <span class="pricing-label">Discount:</span>
                                    <span class="pricing-value">@SelectedItemObject.Discount</span>
                                </div>
                            </div>
                        </div>

                        <!-- Other Inventory Section -->
                        <div class="other-inventory-section">
                            <button class="collapsible-header @(ShowOtherInventory ? "expanded" : "")"
                                    @onclick="() => ShowOtherInventory = !ShowOtherInventory">
                                <span class="chevron">@(ShowOtherInventory ? "▼" : "▶")</span>
                                Other Inventory
                            </button>

                            @if (ShowOtherInventory)
                            {
                                <div class="other-inventory-content">
                                    <div class="inventory-warehouse-section">
                                        <div class="field-row" style="align-items: end; margin-bottom: 1rem;">
                                            <div class="field">
                                                <label>Warehouse</label>
                                                <select @bind="SelectedWarehouse">
                                                    @foreach (var wh in Warehouses)
                                                    {
                                                        <option value="@wh">@wh</option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="field">
                                                <label>Quantity</label>
                                                <input readonly value="@GetWarehouseQuantity(SelectedWarehouse)" />
                                            </div>
                                        </div>

                                        <div class="field-row" style="margin-bottom: 1rem;">
                                            <div class="field">
                                                <label>Stock In Date</label>
                                                <input readonly value="@GetWarehouseStockDate(SelectedWarehouse)" />
                                            </div>
                                            <div class="field">
                                                <label>As Of</label>
                                                <input readonly value="about 13 hours ago" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="shared-dealers-section">
                                        <div class="shared-dealers-header">
                                            <strong>Shared Dealer</strong>
                                            <strong>Quantity</strong>
                                        </div>
                                        @foreach (var dealer in SharedDealers)
                                        {
                                            <div class="shared-dealer-row">
                                                <span>@dealer.Name</span>
                                                <span>@dealer.Quantity</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Catalog Text -->
                        <div class="catalog-section">
                            <label>Catalog Text:</label>
                            <textarea readonly rows="8">@SelectedItemObject.CatalogText</textarea>
                        </div>
                    </div>
                }
                else
                {
                    <div class="detail-empty">
                        <p>Select an item to view details</p>
                    </div>
                }
            </div>
        </div>
    </section>
</div>

@code {
    // Enable franchise selector in sidebar
    protected override bool ShowFranchiseSelector => true;

    // Centralized parameters
    private WebcatParameters Params = new();

    // Local UI state (not in URL)
    private string SearchText = "";
    private bool ShowOtherInventory = false;
    private string SelectedWarehouse = "Cornwell";

    // ============================================================
    // Page contract & URL bindings
    // ============================================================
    protected override string BasePath => "/product/webcat";

    protected override IReadOnlyDictionary<string, string?> Scalars => Params.ToScalars();

    protected override IReadOnlyCollection<string> MultiValues => Array.Empty<string>();

    protected override void ReadFromUrl()
    {
        // Read raw values from URL
        var rawParams = WebcatParameters.FromUrl(Url);

        // No dependency validation needed for this page - just use the raw params
        Params = rawParams;

        // Validate subcategory against current category
        Params.ValidateSubcategory(SubcategoriesForSelectedCategory);

        // Select first item if none selected
        if (string.IsNullOrEmpty(Params.SelectedItem))
        {
            Params.SelectedItem = DisplayedItems.FirstOrDefault()?.Item;
        }
    }

    // ============================================================
    // Sidebar facets
    // ============================================================
    protected override IEnumerable<Facet> Facets()
    {
        yield return new Facet(
            Key: "option",
            Title: "Option",
            Options: () => new[]
            {
                new FacetOption("Webcat", "Webcat",
                    Href: AppendPreserved(Url.BuildHref("/product/webcat",
                        new Dictionary<string, string?> { ["class"] = "All Items" }))),

                new FacetOption("Set Maintenance", "Set Maintenance",
                    Href: AppendPreserved(Url.BuildHref("/product/set-maintenance",
                        new Dictionary<string, string?> { ["class"] = "All Items" }))),

                new FacetOption("View/Change Prices", "View/Change Prices",
                    Href: AppendPreserved(Url.BuildHref("/product/prices",
                        new Dictionary<string, string?> { ["class"] = "All Items" })))
            }
        );

        yield return CommonFacets.ClassFacet;

        yield return CommonFacets.ItemLegend;
    }

    // ============================================================
    // Lifecycle
    // ============================================================
    protected override void OnInitialized()
    {
        SeedData();
        base.OnInitialized();
    }

    // ============================================================
    // Data & Filtering
    // ============================================================
    private List<WebcatItem> AllItems = new();

    private readonly string[] Categories = new[] { "Drive Tools", "Hand Tools", "Power Tools", "Storage", "Diagnostics" };

    // Dynamic, data-driven subcategories for the currently selected Category
    private IReadOnlyList<string> SubcategoriesForSelectedCategory =>
        string.IsNullOrEmpty(Params.Category)
            ? Array.Empty<string>()
            : AllItems
                .Where(x => string.Equals(x.Category, Params.Category, StringComparison.OrdinalIgnoreCase))
                .Select(x => x.Subcategory)
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .OrderBy(s => s)
                .ToList();

    public readonly IReadOnlyList<string> Brands = new[]
    {
        "Bosch",
        "Cornwell Quality Tools",
        "DeWalt",
        "Fluke",
        "Generic",
        "Knipex",
        "Makita",
        "Mechanix Wear",
        "Milwaukee"
    };

    private readonly string[] ShipFromLocations = new[] { "CQT", "1DC", "2DC", "3DC" };
    private string[] Warehouses => new[] { "Cornwell", "1DC", "2DC", "3DC" };

    private List<WebcatItem> FilteredItems
    {
        get
        {
            var query = AllItems.AsEnumerable();

            if (Params.Class != "All Items")
                query = query.Where(x => x.Class == Params.Class);

            if (!string.IsNullOrEmpty(Params.Category))
                query = query.Where(x => x.Category == Params.Category);

            if (!string.IsNullOrEmpty(Params.Subcategory))
                query = query.Where(x => x.Subcategory == Params.Subcategory);

            if (!string.IsNullOrEmpty(Params.Brand))
                query = query.Where(x => x.Brand == Params.Brand);

            if (!string.IsNullOrEmpty(Params.ShipFrom))
                query = query.Where(x => x.ShipFrom == Params.ShipFrom);

            if (!Params.DisplayDiscontinued)
                query = query.Where(x => !x.IsDiscontinued);

            if (Params.OnlyShowInventory)
                query = query.Where(x => x.OnHand > 0);

            return query.ToList();
        }
    }

    private List<WebcatItem> DisplayedItems
    {
        get
        {
            var items = FilteredItems;

            if (!string.IsNullOrEmpty(SearchText))
            {
                var search = SearchText.ToLower();
                items = items.Where(x =>
                    x.Item.ToLower().Contains(search) ||
                    x.Description.ToLower().Contains(search)
                ).ToList();
            }

            return items;
        }
    }

    private WebcatItem? SelectedItemObject =>
        DisplayedItems.FirstOrDefault(x => x.Item == Params.SelectedItem);

    // ============================================================
    // Other Inventory Data
    // ============================================================
    private sealed class SharedDealer
    {
        public string Name { get; set; } = "";
        public int Quantity { get; set; }
    }

    private List<SharedDealer> SharedDealers => new()
    {
        new SharedDealer { Name = "Donald D. Bricker", Quantity = 0 },
        new SharedDealer { Name = "Shawn M. Lewis", Quantity = 0 },
        new SharedDealer { Name = "Donald W. Muffley", Quantity = 0 }
    };

    private int GetWarehouseQuantity(string warehouse) => 0;
    private string GetWarehouseStockDate(string warehouse) => "";

    // ============================================================
    // Actions
    // ============================================================
    private void SelectItem(string itemNumber)
    {
        Params.SelectedItem = itemNumber;
        NavigateWithPageState();
    }

    private void OnFilterPanelChanged(WebcatParameters updatedParams)
    {
        // Update params from filter panel
        Params = updatedParams;

        // Validate subcategory against current category
        Params.ValidateSubcategory(SubcategoriesForSelectedCategory);

        // Reset item selection when filters change
        Params.SelectedItem = DisplayedItems.FirstOrDefault()?.Item;

        // Push URL state
        NavigateWithPageState();
    }

    private void OnCategoryChanged()
    {
        // When category changes, validate and potentially clear subcategory
        Params.ValidateSubcategory(SubcategoriesForSelectedCategory);
        OnFilterChanged();
    }

    private void OnFilterChanged()
    {
        // Reset item selection when filters change
        Params.SelectedItem = DisplayedItems.FirstOrDefault()?.Item;

        // Push URL state
        NavigateWithPageState();
    }

    private void ClearFilters()
    {
        Params.Class = "All Items";
        Params.Category = null;
        Params.Subcategory = null;
        Params.Brand = null;
        Params.ShipFrom = null;
        Params.DisplayDiscontinued = false;
        Params.OnlyShowInventory = false;
        SearchText = "";

        Params.SelectedItem = DisplayedItems.FirstOrDefault()?.Item;
        NavigateWithPageState(replace: true);
    }

    private string GetItemStatusClass(WebcatItem item)
    {
        var classes = new List<string>();
        if (item.IsDiscontinued) classes.Add("item-discontinued");
        if (item.IsPriceConfirm) classes.Add("item-price");
        if (item.IsDropShip) classes.Add("item-ds");
        return string.Join(" ", classes);
    }

    // ============================================================
    // Data seeding
    // ============================================================
    private void SeedData()
    {
        AllItems = WebcatSeedData.GetItems();
    }
}