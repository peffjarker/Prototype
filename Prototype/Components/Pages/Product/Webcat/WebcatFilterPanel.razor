@using Prototype.Components.Pages.Product.Webcat
@using Prototype.Pages.Product

<section class="card filter-panel">
    <div class="filter-grid">
        <div class="field">
            <label for="filter-class">Class:</label>
            <select id="filter-class" @bind="LocalParams.Class" @bind:after="OnFilterChanged">
                <option value="All Items">All Items</option>
                <option value="CQT Stock">CQT Stock</option>
                <option value="Local Only">Local Only</option>
            </select>
        </div>

        <div class="field">
            <label for="filter-category">Category:</label>
            <select id="filter-category" @bind="LocalParams.Category" @bind:after="OnCategoryChanged">
                <option value="">All Categories</option>
                @foreach (var cat in Categories)
                {
                    <option value="@cat">@cat</option>
                }
            </select>
        </div>

        <div class="field">
            <label for="filter-subcategory">Subcategory:</label>
            <select id="filter-subcategory"
                    @bind="LocalParams.Subcategory"
                    @bind:after="OnFilterChanged"
                    disabled="@string.IsNullOrEmpty(LocalParams.Category)">
                <option value="">All Subcategories</option>
                @foreach (var sub in Subcategories)
                {
                    <option value="@sub">@sub</option>
                }
            </select>
        </div>

        <div class="field">
            <label for="filter-brand">Brand:</label>
            <select id="filter-brand" @bind="LocalParams.Brand" @bind:after="OnFilterChanged">
                <option value="">All Brands</option>
                @foreach (var brand in Brands)
                {
                    <option value="@brand">@brand</option>
                }
            </select>
        </div>

        <div class="field">
            <label for="filter-shipfrom">Ship From:</label>
            <select id="filter-shipfrom" @bind="LocalParams.ShipFrom" @bind:after="OnFilterChanged">
                <option value="">All Locations</option>
                @foreach (var loc in ShipFromLocations)
                {
                    <option value="@loc">@loc</option>
                }
            </select>
        </div>

        <div class="field checkbox-group">
            <div class="checkbox-field">
                <label for="filter-discontinued">
                    <input id="filter-discontinued" type="checkbox" @bind="LocalParams.DisplayDiscontinued" @bind:after="OnFilterChanged" />
                    Display Discontinued
                </label>
            </div>

            <div class="checkbox-field">
                <label for="filter-inventory">
                    <input id="filter-inventory" type="checkbox" @bind="LocalParams.OnlyShowInventory" @bind:after="OnFilterChanged" />
                    Only Show Items with Inventory
                </label>
            </div>
        </div>
    </div>

    <div class="filter-actions">
        <button class="btn" @onclick="HandleClearFilters">Clear Filters</button>
        <span class="filter-summary">
            Showing @FilteredCount of @TotalCount items
        </span>
    </div>
</section>

@code {
    [Parameter, EditorRequired] public WebcatParameters Params { get; set; } = null!;
    [Parameter] public EventCallback<WebcatParameters> ParamsChanged { get; set; }
    [Parameter] public EventCallback OnClear { get; set; }
    
    [Parameter] public int FilteredCount { get; set; }
    [Parameter] public int TotalCount { get; set; }

    [Parameter] public IReadOnlyList<string> Categories { get; set; } = Array.Empty<string>();
    [Parameter] public IReadOnlyList<string> Subcategories { get; set; } = Array.Empty<string>();
    [Parameter] public IReadOnlyList<string> Brands { get; set; } = Array.Empty<string>();
    [Parameter] public IReadOnlyList<string> ShipFromLocations { get; set; } = Array.Empty<string>();

    // Local copy to allow two-way binding without modifying parent's reference directly
    private WebcatParameters LocalParams = new();

    protected override void OnParametersSet()
    {
        // Create a copy of the parameters for local binding
        LocalParams = Params.Clone();
    }

    private async Task OnCategoryChanged()
    {
        // Notify parent about category change so it can update subcategories
        await ParamsChanged.InvokeAsync(LocalParams);
    }

    private async Task OnFilterChanged()
    {
        await ParamsChanged.InvokeAsync(LocalParams);
    }

    private async Task HandleClearFilters()
    {
        await OnClear.InvokeAsync();
    }
}
