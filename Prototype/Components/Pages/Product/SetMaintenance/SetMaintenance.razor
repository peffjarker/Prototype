@page "/product/set-maintenance"

@using Microsoft.AspNetCore.WebUtilities
@using Prototype.Components.Layout.Navigation.Sidebar
@using Prototype.Components.Pages.Product.SetMaintenance
@using Prototype.Components.SharedComponents
@using Prototype.Pages.Product
@using Telerik.Blazor
@using Telerik.Blazor.Components
@using static Prototype.Components.Pages.Product.SetMaintenance.SetMaintenanceSeedData

@inherits PageWithSidebarBase

@inject IJSRuntime JS

<div class="wrap">
    <header class="header">
        <h3 class="title">Set Maintenance</h3>
    </header>

    <!-- Items List & Detail -->
    <section class="card items-section">
        <div class="items-layout">
            <!-- Items List -->
            <ItemList Items="@DisplayedItems"
                      SelectedItem="@Params.SelectedItem"
                      OnItemClick="@SelectItem" />

            <!-- Item Detail -->
            <div class="item-detail">
                @if (SelectedItemObject != null)
                {
                    <div class="set-maintenance-detail">
                        <!-- Header Section -->
                        <div class="detail-header-section">
                            <div class="field-group">
                                <div class="field">
                                    <label>Item</label>
                                    <input readonly value="@SelectedItemObject.Item" />
                                </div>
                            </div>

                            <div class="field-group">
                                <div class="field">
                                    <label>Description</label>
                                    <input readonly value="@SelectedItemObject.Description" class="full-width" />
                                </div>
                            </div>

                            <div class="field-row">
                                <div class="field">
                                    <label>List Price</label>
                                    <input readonly value="@SelectedItemObject.ListPrice.ToString("C")" />
                                </div>
                                <div class="field">
                                    <label>Discount</label>
                                    <input readonly value="@SelectedItemObject.Discount" />
                                </div>
                            </div>
                        </div>

                        <!-- Inventory Summary Bar -->
                        <InventorySummaryBar OnHand="@SelectedItemObject.OnHand"
                                             Pending="@SelectedItemObject.Pending"
                                             OnOrder="@SelectedItemObject.OnOrder"
                                             Alloc="@SelectedItemObject.Alloc"
                                             BKO="@SelectedItemObject.BKO"
                                             InTransit="@SelectedItemObject.InTransit"
                                             Needs="@SelectedItemObject.Needs"
                                             Interests="@SelectedItemObject.Interests" />

                        <!-- Components Grid -->
                        <div class="components-section">
                            <TelerikGrid Data="@SelectedItemObject.Components"
                                         Pageable="false"
                                         Sortable="true"
                                         FilterMode="@GridFilterMode.FilterRow"
                                         Resizable="true"
                                         Height="400px">
                                <GridColumns>
                                    <GridColumn Field="@nameof(SetComponent.Component)" Title="Component" Width="140px" />
                                    <GridColumn Field="@nameof(SetComponent.Description)" Title="Description" />
                                    <GridColumn Field="@nameof(SetComponent.AdjQty)" Title="Adj Qty" Width="120px" TextAlign="@ColumnTextAlign.Right" />
                                    <GridColumn Field="@nameof(SetComponent.OnHand)" Title="On Hand" Width="120px" TextAlign="@ColumnTextAlign.Right" />
                                    <GridColumn Field="@nameof(SetComponent.PrintLabel)" Title="Print Label" Width="120px" TextAlign="@ColumnTextAlign.Center">
                                        <Template>
                                            @{
                                                var component = (SetComponent)context;
                                                <input type="checkbox" checked="@component.PrintLabel" disabled />
                                            }
                                        </Template>
                                    </GridColumn>
                                </GridColumns>
                            </TelerikGrid>
                        </div>
                    </div>
                }
                else
                {
                    <div class="detail-empty">
                        <p>Select an item to view set maintenance details</p>
                    </div>
                }
            </div>
        </div>
    </section>
</div>

@code {
    // Enable franchise selector in sidebar
    protected override bool ShowFranchiseSelector => true;

    // Centralized parameters
    private SetMaintenanceParameters Params = new();

    // Local UI state (not in URL)
    private string SearchText = "";

    // ============================================================
    // Page contract & URL bindings
    // ============================================================
    protected override string BasePath => "/product/set-maintenance";

    protected override IReadOnlyDictionary<string, string?> Scalars => Params.ToScalars();

    protected override IReadOnlyCollection<string> MultiValues => Array.Empty<string>();

    protected override void ReadFromUrl()
    {
        // Read raw values from URL
        Params = SetMaintenanceParameters.FromUrl(Url);

        // Select first item if none selected
        if (string.IsNullOrEmpty(Params.SelectedItem))
        {
            Params.SelectedItem = DisplayedItems.FirstOrDefault()?.Item;
        }
    }

    // ============================================================
    // Sidebar facets
    // ============================================================
    protected override IEnumerable<Facet> Facets()
    {
        yield return new Facet(
            Key: "option",
            Title: "Option",
            Options: () => new[]
            {
                new FacetOption("Webcat", "Webcat",
                    Href: AppendPreserved(Url.BuildHref("/product/webcat",
                        new Dictionary<string, string?> { ["class"] = "All Items" }))),

                new FacetOption("Set Maintenance", "Set Maintenance",
                    Href: AppendPreserved(Url.BuildHref("/product/set-maintenance",
                        new Dictionary<string, string?> { ["class"] = "All Items" }))),

                new FacetOption("View/Change Prices", "View/Change Prices",
                    Href: AppendPreserved(Url.BuildHref("/product/prices",
                        new Dictionary<string, string?> { ["class"] = "All Items" })))
            }
        );

        yield return CommonFacets.ClassFacet;

        yield return CommonFacets.ItemLegend;
    }

    // ============================================================
    // Lifecycle
    // ============================================================
    protected override void OnInitialized()
    {
        SeedData();
        base.OnInitialized();
    }

    // ============================================================
    // Data & Filtering
    // ============================================================
    private List<SetMaintenanceItem> AllItems = new();

    private List<SetMaintenanceItem> DisplayedItems
    {
        get
        {
            var items = AllItems.AsEnumerable();

            if (Params.Class != "All Items")
                items = items.Where(x => x.Class == Params.Class);

            if (!string.IsNullOrEmpty(SearchText))
            {
                var search = SearchText.ToLower();
                items = items.Where(x =>
                    x.Item.ToLower().Contains(search) ||
                    x.Description.ToLower().Contains(search)
                );
            }

            return items.ToList();
        }
    }

    private SetMaintenanceItem? SelectedItemObject =>
        DisplayedItems.FirstOrDefault(x => x.Item == Params.SelectedItem);

    // ============================================================
    // Actions
    // ============================================================
    private void SelectItem(string itemNumber)
    {
        Params.SelectedItem = itemNumber;
        NavigateWithPageState();
    }

    private string GetItemStatusClass(SetMaintenanceItem item)
    {
        var classes = new List<string>();
        if (item.IsDiscontinued) classes.Add("item-discontinued");
        if (item.IsPriceConfirm) classes.Add("item-price");
        if (item.IsDropShip) classes.Add("item-ds");
        return string.Join(" ", classes);
    }

    // ============================================================
    // Data seeding
    // ============================================================
    private void SeedData()
    {
        AllItems = SetMaintenanceSeedData.GetItems();
    }
}