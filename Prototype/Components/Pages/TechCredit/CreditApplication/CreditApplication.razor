@page "/techcredit/creditapplication"

@using Microsoft.AspNetCore.WebUtilities
@using Prototype.Components.Layout.Navigation.Sidebar
@using Prototype.Components.Pages.Collections.CreditApplication
@using Prototype.Pages.Collections
@using Telerik.Blazor
@using Telerik.Blazor.Components
@using static Prototype.Components.Pages.Collections.CreditApplication.CreditApplicationSeedData

@inherits PageWithSidebarBase

@inject IJSRuntime JS

<div class="wrap">
    <header class="header">
        <h3 class="title">Customer Information</h3>
    </header>

    <section class="card credit-app-layout">
        <div class="customers-panel">
            <!-- Customer List -->
            <div class="customer-list">
                @foreach (var customer in FilteredCustomers)
                {
                    <button class="customer-item @(customer.BorrowerId == Params.SelectedCustomer ? "selected" : "")"
                            @onclick="() => SelectCustomer(customer.BorrowerId)">
                        @customer.CustomerName
                    </button>
                }
            </div>
        </div>

        <div class="detail-panel">
            @if (SelectedApplication != null)
            {
                var app = SelectedApplication;

                <div class="form-layout">
                    <!-- Main Form Area -->
                    <div class="form-main">
                        <!-- Customer Information -->
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-field">
                                    <label>First Name <span class="required">*</span></label>
                                    <input readonly value="@app.FirstName" />
                                </div>
                                <div class="form-field small">
                                    <label>MI</label>
                                    <input readonly value="@app.MiddleInitial" />
                                </div>
                                <div class="form-field">
                                    <label>Last Name <span class="required">*</span></label>
                                    <input readonly value="@app.LastName" />
                                </div>
                                <div class="form-field small">
                                    <label>Suff</label>
                                    <input readonly value="@app.Suffix" />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-field">
                                    <label>SSN <span class="required">*</span></label>
                                    <div class="ssn-inputs">
                                        <input readonly value="@GetSSNPart(app.SSN, 0)" style="width: 60px;" />
                                        <span>-</span>
                                        <input readonly value="@GetSSNPart(app.SSN, 1)" style="width: 50px;" />
                                        <span>-</span>
                                        <input readonly value="@GetSSNPart(app.SSN, 2)" style="width: 70px;" />
                                    </div>
                                </div>
                                <div class="form-field">
                                    <label>DOB <span class="required">*</span></label>
                                    <div class="dob-inputs">
                                        <input readonly value="@app.DOB.Month.ToString("00")" style="width: 50px;" />
                                        <span>/</span>
                                        <input readonly value="@app.DOB.Day.ToString("00")" style="width: 50px;" />
                                        <span>/</span>
                                        <input readonly value="@app.DOB.Year" style="width: 70px;" />
                                    </div>
                                </div>
                                <div class="form-field">
                                    <label>Profile</label>
                                    <input readonly value="@app.Profile" />
                                </div>
                            </div>
                        </div>

                        <!-- Home Address -->
                        <div class="form-section">
                            <h4>Home Address</h4>
                            <div class="form-row">
                                <div class="form-field full-width">
                                    <label>Address 1 <span class="required">*</span></label>
                                    <input readonly value="@app.Address1" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field full-width">
                                    <label>Address 2</label>
                                    <input readonly value="@app.Address2" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>City <span class="required">*</span></label>
                                    <input readonly value="@app.City" />
                                </div>
                                <div class="form-field small">
                                    <label>State <span class="required">*</span></label>
                                    <input readonly value="@app.State" />
                                </div>
                                <div class="form-field">
                                    <label>Zip <span class="required">*</span></label>
                                    <input readonly value="@app.Zip" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field phone-group">
                                    <label>Phone <span class="required">**</span></label>
                                    <div class="phone-inputs">
                                        <input readonly value="@GetPhonePart(app.Phone, 0)" style="width: 60px;" />
                                        <span>-</span>
                                        <input readonly value="@GetPhonePart(app.Phone, 1)" style="width: 60px;" />
                                        <span>-</span>
                                        <input readonly value="@GetPhonePart(app.Phone, 2)" style="width: 70px;" />
                                    </div>
                                </div>
                                <div class="form-field small">
                                    <label>Ext.</label>
                                    <input readonly value="@app.Extension" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field phone-group">
                                    <label>Cell Phone <span class="required">**</span></label>
                                    <div class="phone-inputs">
                                        <input readonly value="@GetPhonePart(app.CellPhone, 0)" style="width: 60px;" />
                                        <span>-</span>
                                        <input readonly value="@GetPhonePart(app.CellPhone, 1)" style="width: 60px;" />
                                        <span>-</span>
                                        <input readonly value="@GetPhonePart(app.CellPhone, 2)" style="width: 70px;" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field full-width">
                                    <label>Email</label>
                                    <input readonly value="@app.Email" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>
                                        <input type="checkbox" checked="@app.MailingAddressSame" disabled />
                                        <span style="margin-left: 0.5rem; font-style: italic;">Mailing Address Same As Home</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>Time at Residence <span class="required">*</span></label>
                                    <div class="time-inputs">
                                        <input readonly value="@app.TimeAtResidenceYears" style="width: 60px;" />
                                        <span>Years</span>
                                        <input readonly value="@app.TimeAtResidenceMonths" style="width: 60px;" />
                                        <span>Months</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nearest Relative -->
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-field">
                                    <label>Nearest Relative <span class="required">*</span></label>
                                    <div style="font-size: 0.75rem; color: #6c757d; font-style: italic;">(Not Living With Applicant)</div>
                                    <input readonly value="@app.NearestRelative" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field phone-group">
                                    <label>Relative Phone <span class="required">*</span></label>
                                    <div class="phone-inputs">
                                        <input readonly value="@GetPhonePart(app.RelativePhone, 0)" style="width: 60px;" />
                                        <span>-</span>
                                        <input readonly value="@GetPhonePart(app.RelativePhone, 1)" style="width: 60px;" />
                                        <span>-</span>
                                        <input readonly value="@GetPhonePart(app.RelativePhone, 2)" style="width: 70px;" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Required Notes -->
                        <div class="form-notes">
                            <div><span class="required">(*)</span> Indicates required entry</div>
                            <div><span class="required">(**)</span> Indicates at least one entry</div>
                        </div>
                    </div>

                    <!-- Right Sidebar -->
                    <div class="form-sidebar">
                        <!-- Employer Information -->
                        <div class="sidebar-section">
                            <h4>Employer Information</h4>
                            <div class="form-field">
                                <label>Employer Name <span class="required">*</span></label>
                                <input readonly value="@app.EmployerName" />
                            </div>
                            <div class="form-field">
                                <label>Occupation <span class="required">*</span></label>
                                <input readonly value="@app.Occupation" />
                            </div>
                            <div class="form-field">
                                <label>Employer Address 1 <span class="required">*</span></label>
                                <input readonly value="@app.EmployerAddress1" />
                            </div>
                            <div class="form-field">
                                <label>Employer Address 2</label>
                                <input readonly value="@app.EmployerAddress2" />
                            </div>
                            <div class="form-field">
                                <label>City <span class="required">*</span></label>
                                <input readonly value="@app.EmployerCity" />
                            </div>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>State <span class="required">*</span></label>
                                    <input readonly value="@app.EmployerState" style="width: 80px;" />
                                </div>
                                <div class="form-field">
                                    <label>Zip <span class="required">*</span></label>
                                    <input readonly value="@app.EmployerZip" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field phone-group">
                                    <label>Phone <span class="required">*</span></label>
                                    <div class="phone-inputs">
                                        <input readonly value="@GetPhonePart(app.EmployerPhone, 0)" style="width: 50px;" />
                                        <span>-</span>
                                        <input readonly value="@GetPhonePart(app.EmployerPhone, 1)" style="width: 50px;" />
                                        <span>-</span>
                                        <input readonly value="@GetPhonePart(app.EmployerPhone, 2)" style="width: 60px;" />
                                    </div>
                                </div>
                            </div>
                            <div class="form-field">
                                <label>Ext.</label>
                                <input readonly value="@app.EmployerExtension" />
                            </div>
                            <div class="form-field">
                                <label>Time at Employer <span class="required">*</span></label>
                                <div class="time-inputs">
                                    <input readonly value="@app.TimeAtEmployerYears" style="width: 50px;" />
                                    <span>Years</span>
                                    <input readonly value="@app.TimeAtEmployerMonths" style="width: 50px;" />
                                    <span>Months</span>
                                </div>
                            </div>
                        </div>

                        <!-- Application Status -->
                        <div class="sidebar-section app-status">
                            <div class="form-field">
                                <label>Borrower ID</label>
                                <input readonly value="@app.BorrowerId" />
                            </div>
                            <div class="form-field">
                                <label>CTC App ID</label>
                                <input readonly value="@app.CTCAppId" />
                            </div>
                            <div class="form-field">
                                <label>Application Date</label>
                                <input readonly value="@app.ApplicationDate.ToString("MM/dd/yyyy")" />
                            </div>
                            <div class="form-field">
                                <label>Decision</label>
                                <input readonly value="@app.Decision"
                                       class="@GetDecisionClass(app.Decision)" />
                            </div>
                            <div class="form-field">
                                <label>Credit Limit</label>
                                <input readonly value="@app.CreditLimit.ToString("C")" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Primary"
                                   OnClick="@PrintApplication">
                        Print Application
                    </TelerikButton>
                    <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Warning"
                                   OnClick="@NewApplication">
                        New Application
                    </TelerikButton>
                </div>
            }
            else
            {
                <div class="detail-empty">
                    <p>Select a customer to view credit application</p>
                </div>
            }
        </div>
    </section>
</div>

@code {
    // Enable franchise selector in sidebar
    protected override bool ShowFranchiseSelector => true;

    // Centralized parameters
    private CreditApplicationParameters Params = new();

    // ============================================================
    // Page contract & URL bindings
    // ============================================================
    protected override string BasePath => "/techcredit/creditapplication";

    protected override IReadOnlyDictionary<string, string?> Scalars => Params.ToScalars();

    protected override IReadOnlyCollection<string> MultiValues => Array.Empty<string>();

    protected override void ReadFromUrl()
    {
        Params = CreditApplicationParameters.FromUrl(Url);

        if (string.IsNullOrEmpty(Params.SelectedCustomer))
        {
            Params.SelectedCustomer = FilteredCustomers.FirstOrDefault()?.BorrowerId;
        }
    }

    // ============================================================
    // Sidebar facets
    // ============================================================
    protected override IEnumerable<Facet> Facets()
    {
        yield return new Facet(
            Key: "option",
            Title: "Option",
            Options: () => new[]
            {
                new FacetOption("Customer Information", "Customer Information",
                    Href: Url.BuildHref("/techcredit/customerinformation",
                        new Dictionary<string, string?> { ["status"] = "All" })),
                new FacetOption("Credit Application", "Credit Application",
                    Href: Url.BuildHref("/techcredit/creditapplication",
                        new Dictionary<string, string?> { ["status"] = "All" })),
                new FacetOption("Sales Authorizations", "Sales Authorizations",
                    Href: Url.BuildHref("/techcredit/salesauthorizations",
                        new Dictionary<string, string?> { ["status"] = "All" })),
            }
        );

        yield return new Facet(
            Key: "status",
            Title: "Customer Status",
            Options: () => new[]
            {
                new FacetOption("All", "All"),
                new FacetOption("TC Borrowers", "TC Borrowers"),
                new FacetOption("TC Past Due", "TC Past Due")
            }
        );
    }

    // ============================================================
    // Lifecycle
    // ============================================================
    protected override void OnInitialized()
    {
        AllApplications = CreditApplicationSeedData.GetApplications();
        base.OnInitialized();
    }

    // ============================================================
    // Data & Filtering
    // ============================================================
    private List<CreditApp> AllApplications = new();

    private List<CreditApp> FilteredCustomers
    {
        get
        {
            var apps = AllApplications.AsEnumerable();

            apps = Params.CustomerStatus switch
            {
                "TC Borrowers" => apps.Where(a => a.IsTCBorrower),
                "TC Past Due" => apps.Where(a => a.IsPastDue),
                _ => apps
            };

            return apps.ToList();
        }
    }

    private CreditApp? SelectedApplication =>
        FilteredCustomers.FirstOrDefault(a => a.BorrowerId == Params.SelectedCustomer);

    // ============================================================
    // Actions
    // ============================================================
    private void SelectCustomer(string borrowerId)
    {
        Params.SelectedCustomer = borrowerId;
        NavigateWithPageState();
    }

    private void PrintApplication()
    {
        Console.WriteLine($"Print application for: {SelectedApplication?.CustomerName}");
    }

    private void NewApplication()
    {
        Console.WriteLine("Create new application");
    }

    // ============================================================
    // Helper Methods
    // ============================================================
    private string GetSSNPart(string ssn, int part)
    {
        var parts = ssn.Split('-');
        return parts.Length > part ? parts[part] : "";
    }

    private string GetPhonePart(string phone, int part)
    {
        var digits = new string(phone.Where(char.IsDigit).ToArray());
        return part switch
        {
            0 => digits.Length >= 3 ? digits[..3] : "",
            1 => digits.Length >= 6 ? digits.Substring(3, 3) : "",
            2 => digits.Length >= 10 ? digits.Substring(6, 4) : "",
            _ => ""
        };
    }

    private string GetDecisionClass(string decision)
    {
        return decision?.ToLower() switch
        {
            "approved" => "decision-approved",
            "expired" => "decision-expired",
            "denied" => "decision-denied",
            _ => ""
        };
    }
}

