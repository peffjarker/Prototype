@page "/techcredit/payments"
@inherits PageWithSidebarBase
@using Prototype.Components.SharedComponents.Sidepanel
@using Prototype.Pages.Collections
@using Prototype.Components.Pages.Collections.TechCredit
@using Services
@using global::Services
@using static Prototype.Components.Pages.Collections.TechCredit.TechCreditPaymentsSeedData
@inject SidePanelService SidePanel
@inject IJSRuntime JS

<PageTitle>TechCredit Payments</PageTitle>

<div class="techcredit-payments-page" data-density="@_currentDensity" data-display-mode="@_displayMode">
    <div class="page-header">
        <div class="header-main">
            <div class="header-left">
                <h3 class="title">TechCredit Payments</h3>
            </div>

            <!-- Tabs (only show in tabbed mode AND when density is not compact) -->
            @if (_displayMode == "tabbed" && _currentDensity != "compact")
            {
                <div class="view-selector">
                    <button class="view-tab @(_view == "PastDue" ? "active" : "")"
                            @onclick='() => ChangeView("PastDue")'>
                        <span class="k-icon k-i-warning"></span>
                        Past Due (@_pastDueCount)
                    </button>
                    <button class="view-tab @(_view == "Scheduled" ? "active" : "")"
                            @onclick='() => ChangeView("Scheduled")'>
                        <span class="k-icon k-i-calendar"></span>
                        Scheduled (@_scheduledPayments.Count)
                    </button>
                    <button class="view-tab @(_view == "History" ? "active" : "")"
                            @onclick='() => ChangeView("History")'>
                        <span class="k-icon k-i-file-txt"></span>
                        History
                    </button>
                    <button class="view-tab @(_view == "Remitted" ? "active" : "")"
                            @onclick='() => ChangeView("Remitted")'>
                        <span class="k-icon k-i-check-circle"></span>
                        Remitted (@_remittedPayments.Count)
                    </button>
                </div>
            }
        </div>

        <div class="header-stats">
            <div class="stat-card stat-danger">
                <div class="stat-label">Total Past Due</div>
                <div class="stat-value">@_totalPastDue.ToString("C2")</div>
                <div class="stat-sublabel">@_pastDueCount accounts</div>
            </div>
            <div class="stat-card stat-warning">
                <div class="stat-label">Due This Week</div>
                <div class="stat-value">@_dueThisWeek.ToString("C2")</div>
                <div class="stat-sublabel">@_dueThisWeekCount payments</div>
            </div>
            <div class="stat-card stat-success">
                <div class="stat-label">Collected Today</div>
                <div class="stat-value">@_collectedToday.ToString("C2")</div>
                <div class="stat-sublabel">@_collectedTodayCount payments</div>
            </div>
            <div class="stat-card stat-info">
                <div class="stat-label">Scheduled Next 30 Days</div>
                <div class="stat-value">@_scheduledNext30Days.ToString("C2")</div>
                <div class="stat-sublabel">@_scheduledNext30DaysCount payments</div>
            </div>
        </div>
    </div>

    <div class="toolbar-section">
        <div class="toolbar-left">
            @* Top-level action buttons remain only for non-compact densities.
               Compact density will show actions inside section headers. *@
            @if (_currentDensity != "compact")
            {
                @if ((_displayMode == "tabbed" && _view == "PastDue") || _displayMode != "tabbed")
                {
                    <TelerikButton Icon="@SvgIcon.MyspaceBox"
                                   OnClick="@SendReminders"
                                   ThemeColor="@ThemeConstants.Button.ThemeColor.Primary"
                                   Enabled="@(_selectedPayments.Any())">
                        Send Reminders (@_selectedPayments.Count())
                    </TelerikButton>
                }

                <TelerikButton Icon="@SvgIcon.FileExcel"
                               OnClick="@ExportToExcel"
                               ThemeColor="@ThemeConstants.Button.ThemeColor.Success">
                    Export
                </TelerikButton>

                <TelerikButton Icon="@SvgIcon.Print"
                               OnClick="@PrintPayments"
                               ThemeColor="@ThemeConstants.Button.ThemeColor.Base">
                    Print
                </TelerikButton>
            }
        </div>

        <div class="toolbar-right">
            @if (_currentDensity != "compact")
            {
                @if ((_displayMode == "tabbed" && _view == "History") || _displayMode != "tabbed")
                {
                    <div class="date-range-filter">
                        <label>History Range:</label>
                        <TelerikDateRangePicker @bind-StartValue="@_startDate"
                                                @bind-EndValue="@_endDate"
                                                OnChange="@OnDateRangeChanged">
                        </TelerikDateRangePicker>
                    </div>
                }
            }
        </div>
    </div>

    @* ---------- RENDERING ---------- *@
    @if (_displayMode == "tabbed" && _currentDensity != "compact")
    {
        <!-- MODE 1: ORIGINAL TABBED VIEW (non-compact densities) -->
        @if (_view == "PastDue")
        {
            @RenderPastDueGrid()
        }
        else if (_view == "Scheduled")
        {
            @RenderScheduledGrid()
        }
        else if (_view == "History")
        {
            @RenderHistoryGrid()
        }
        else if (_view == "Remitted")
        {
            @RenderRemittedGrid()
        }
    }
    else if (_displayMode == "tabbed" && _currentDensity == "compact")
    {
        <!-- COMPACT: tabbed selected, but show collapsible headers inside the page; actions moved into section headers -->
        <div class="data-section compact-past-due-section">
            <div class="section-title">
                <div class="section-title-content" @onclick="@(() => _showPastDue = !_showPastDue)">
                    <span class="k-icon @(_showPastDue ? "k-i-arrow-chevron-down" : "k-i-arrow-chevron-right")"></span>
                    <span class="k-icon k-i-warning"></span>
                    <h2>Past Due (@_pastDueCount)</h2>
                </div>

                <div class="section-actions">
                    <TelerikButton Icon="@SvgIcon.MyspaceBox"
                                   OnClick="@SendReminders"
                                   Size="@ThemeConstants.Button.Size.Small"
                                   ThemeColor="@ThemeConstants.Button.ThemeColor.Primary"
                                   Enabled="@(_selectedPayments.Any())"
                                   Title="Send Reminders">
                        Send
                    </TelerikButton>

                    <TelerikButton Icon="@SvgIcon.FileExcel"
                                   OnClick="@ExportToExcel"
                                   Size="@ThemeConstants.Button.Size.Small"
                                   ThemeColor="@ThemeConstants.Button.ThemeColor.Success"
                                   Title="Export">
                    </TelerikButton>

                    <TelerikButton Icon="@SvgIcon.Print"
                                   OnClick="@PrintPayments"
                                   Size="@ThemeConstants.Button.Size.Small"
                                   ThemeColor="@ThemeConstants.Button.ThemeColor.Base"
                                   Title="Print">
                    </TelerikButton>
                </div>
            </div>

            @if (_showPastDue)
            {
                @RenderPastDueGrid()
            }
        </div>

        <div class="data-section compact-scheduled-section">
            <div class="section-title">
                <div class="section-title-content" @onclick="@(() => _showScheduled = !_showScheduled)">
                    <span class="k-icon @(_showScheduled ? "k-i-arrow-chevron-down" : "k-i-arrow-chevron-right")"></span>
                    <span class="k-icon k-i-calendar"></span>
                    <h2>Scheduled Payments (@_scheduledPayments.Count)</h2>
                </div>

                <div class="section-actions">
                    <TelerikButton Icon="@SvgIcon.FileExcel"
                                   OnClick="@ExportToExcel"
                                   Size="@ThemeConstants.Button.Size.Small"
                                   ThemeColor="@ThemeConstants.Button.ThemeColor.Success"
                                   Title="Export">
                    </TelerikButton>

                    <TelerikButton Icon="@SvgIcon.Print"
                                   OnClick="@PrintPayments"
                                   Size="@ThemeConstants.Button.Size.Small"
                                   ThemeColor="@ThemeConstants.Button.ThemeColor.Base"
                                   Title="Print">
                    </TelerikButton>
                </div>
            </div>

            @if (_showScheduled)
            {
                @RenderScheduledGrid()
            }
        </div>

        <div class="data-section compact-history-section">
            <div class="section-title">
                <div class="section-title-content" @onclick="@(() => _showHistory = !_showHistory)">
                    <span class="k-icon @(_showHistory ? "k-i-arrow-chevron-down" : "k-i-arrow-chevron-right")"></span>
                    <span class="k-icon k-i-file-txt"></span>
                    <h2>Payment History (@_paymentHistory.Count)</h2>
                </div>

                <div class="section-actions">
                    <div class="compact-date-range">
                        <label class="compact-history-label">History Range:</label>
                        <TelerikDateRangePicker @bind-StartValue="@_startDate"
                                                @bind-EndValue="@_endDate"
                                                Size="@ThemeConstants.Calendar.Size.Small"
                                                OnChange="@OnDateRangeChanged">
                        </TelerikDateRangePicker>
                    </div>

                    <TelerikButton Icon="@SvgIcon.FileExcel"
                                   OnClick="@ExportToExcel"
                                   Size="@ThemeConstants.Button.Size.Small"
                                   ThemeColor="@ThemeConstants.Button.ThemeColor.Success"
                                   Title="Export">
                    </TelerikButton>

                    <TelerikButton Icon="@SvgIcon.Print"
                                   OnClick="@PrintPayments"
                                   Size="@ThemeConstants.Button.Size.Small"
                                   ThemeColor="@ThemeConstants.Button.ThemeColor.Base"
                                   Title="Print">
                    </TelerikButton>
                </div>
            </div>

            @if (_showHistory)
            {
                @RenderHistoryGrid()
            }
        </div>

        <div class="data-section compact-remitted-section">
            <div class="section-title">
                <div class="section-title-content" @onclick="@(() => _showRemitted = !_showRemitted)">
                    <span class="k-icon @(_showRemitted ? "k-i-arrow-chevron-down" : "k-i-arrow-chevron-right")"></span>
                    <span class="k-icon k-i-check-circle"></span>
                    <h2>Remitted Payments (@_remittedPayments.Count)</h2>
                </div>

                <div class="section-actions">
                    <TelerikButton Icon="@SvgIcon.FileExcel"
                                   OnClick="@ExportToExcel"
                                   Size="@ThemeConstants.Button.Size.Small"
                                   ThemeColor="@ThemeConstants.Button.ThemeColor.Success"
                                   Title="Export">
                    </TelerikButton>

                    <TelerikButton Icon="@SvgIcon.Print"
                                   OnClick="@PrintPayments"
                                   Size="@ThemeConstants.Button.Size.Small"
                                   ThemeColor="@ThemeConstants.Button.ThemeColor.Base"
                                   Title="Print">
                    </TelerikButton>
                </div>
            </div>

            @if (_showRemitted)
            {
                @RenderRemittedGrid()
            }
        </div>
    }
    else if (_displayMode == "sections")
    {
        <!-- MODE 2: COLLAPSIBLE SECTIONS VIEW (unchanged) -->
        <div class="data-section past-due-section">
            <div class="section-title" @onclick="@(() => _showPastDue = !_showPastDue)">
                <div class="section-title-content">
                    <span class="k-icon @(_showPastDue ? "k-i-arrow-chevron-down" : "k-i-arrow-chevron-right")"></span>
                    <span class="k-icon k-i-warning"></span>
                    <h2>Past Due (@_pastDueCount)</h2>
                </div>
            </div>
            @if (_showPastDue)
            {
                @RenderPastDueGrid()
            }
        </div>

        <div class="data-section scheduled-section">
            <div class="section-title" @onclick="@(() => _showScheduled = !_showScheduled)">
                <div class="section-title-content">
                    <span class="k-icon @(_showScheduled ? "k-i-arrow-chevron-down" : "k-i-arrow-chevron-right")"></span>
                    <span class="k-icon k-i-calendar"></span>
                    <h2>Scheduled Payments (@_scheduledPayments.Count)</h2>
                </div>
            </div>
            @if (_showScheduled)
            {
                @RenderScheduledGrid()
            }
        </div>

        <div class="data-section history-section">
            <div class="section-title" @onclick="@(() => _showHistory = !_showHistory)">
                <div class="section-title-content">
                    <span class="k-icon @(_showHistory ? "k-i-arrow-chevron-down" : "k-i-arrow-chevron-right")"></span>
                    <span class="k-icon k-i-file-txt"></span>
                    <h2>Payment History (@_paymentHistory.Count)</h2>
                </div>
            </div>
            @if (_showHistory)
            {
                @RenderHistoryGrid()
            }
        </div>

        <div class="data-section remitted-section">
            <div class="section-title" @onclick="@(() => _showRemitted = !_showRemitted)">
                <div class="section-title-content">
                    <span class="k-icon @(_showRemitted ? "k-i-arrow-chevron-down" : "k-i-arrow-chevron-right")"></span>
                    <span class="k-icon k-i-check-circle"></span>
                    <h2>Remitted Payments (@_remittedPayments.Count)</h2>
                </div>
            </div>
            @if (_showRemitted)
            {
                @RenderRemittedGrid()
            }
        </div>
    }
    else if (_displayMode == "alldata")
    {
        <!-- MODE 3: ALL DATA VIEW (everything expanded, no collapsing) -->
        <div class="data-section past-due-section">
            <div class="section-title-static">
                <span class="k-icon k-i-warning"></span>
                <h2>Past Due (@_pastDueCount)</h2>
            </div>
            @RenderPastDueGrid()
        </div>

        <div class="data-section scheduled-section">
            <div class="section-title-static">
                <span class="k-icon k-i-calendar"></span>
                <h2>Scheduled Payments (@_scheduledPayments.Count)</h2>
            </div>
            @RenderScheduledGrid()
        </div>

        <div class="data-section history-section">
            <div class="section-title-static">
                <span class="k-icon k-i-file-txt"></span>
                <h2>Payment History (@_paymentHistory.Count)</h2>
            </div>
            @RenderHistoryGrid()
        </div>

        <div class="data-section remitted-section">
            <div class="section-title-static">
                <span class="k-icon k-i-check-circle"></span>
                <h2>Remitted Payments (@_remittedPayments.Count)</h2>
            </div>
            @RenderRemittedGrid()
        </div>
    }
</div>

@code {
    // ===== Display Mode =====
    private string _displayMode = "tabbed"; // tabbed, sections, alldata

    // ===== View State (for tabbed mode) =====
    private string _view = "PastDue";
    private string _status = "All";
    private string _currentDensity = "comfortable";

    // Section visibility (for sections mode and compact tabbed)
    private bool _showPastDue = true;
    private bool _showScheduled = true;
    private bool _showHistory = false;
    private bool _showRemitted = false;

    // Centralized parameters
    private TechCreditPaymentParameters Params = new();

    // ============================================================
    // Page contract & URL bindings
    // ============================================================
    protected override IReadOnlyDictionary<string, string?> Scalars => Params.ToScalars();

    protected override IReadOnlyCollection<string> MultiValues => Array.Empty<string>();

    protected override void ReadFromUrl()
    {
        // Read raw values from URL
        var rawParams = TechCreditPaymentParameters.FromUrl(Url);

        // Validate option parameter - must be a valid TechCredit option
        var validOptions = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "Customer Information",
            "Credit Application",
            "Sales Authorizations",
            "WCS",
            "Payments"
        };

        // If the option from URL is not a valid TechCredit option, use default for this page
        if (!validOptions.Contains(rawParams.Option))
        {
            rawParams.Option = "Payments"; // Default for this page
        }

        Params = rawParams;
    }

    // ===== Required PageWithSidebarBase Implementations =====

    protected override string BasePath => "/techcredit/payments";

    protected override IEnumerable<Facet> Facets()
    {
        yield return new Facet(
            Key: "option",
            Title: "Option",
            Options: () => new[]
            {
            new FacetOption("Customer Information", "Customer Information",
                Href: Url.BuildHref("/techcredit/customerinformation",
                    new Dictionary<string, string?> { ["status"] = "All" })),

            new FacetOption("Credit Application", "Credit Application",
                Href: Url.BuildHref("/techcredit/creditapplication",
                    new Dictionary<string, string?> { ["status"] = "All" })),

            new FacetOption("Sales Authorizations", "Sales Authorizations",
                Href: Url.BuildHref("/techcredit/salesauthorizations",
                    new Dictionary<string, string?> { ["status"] = "All" })),

            new FacetOption("WCS", "WCS",
                Href: Url.BuildHref("/techcredit/wcs",
                    new Dictionary<string, string?>())),

            new FacetOption("Payments", "Payments",
                Href: Url.BuildHref("/techcredit/payments",
                    new Dictionary<string, string?> { ["view"] = "PastDue" }))
            }
        );
    }

    // ===== Page Data =====

    private List<PaymentRecord> _pastDuePayments = new();
    private List<PaymentRecord> _scheduledPayments = new();
    private List<PaymentRecord> _paymentHistory = new();
    private List<PaymentRecord> _remittedPayments = new();
    private IEnumerable<PaymentRecord> _selectedPayments = new List<PaymentRecord>();

    // Statistics
    private decimal _totalPastDue = 0m;
    private int _pastDueCount = 0;
    private decimal _dueThisWeek = 0m;
    private int _dueThisWeekCount = 0;
    private decimal _collectedToday = 0m;
    private int _collectedTodayCount = 0;
    private decimal _scheduledNext30Days = 0m;
    private int _scheduledNext30DaysCount = 0;

    // Date range for history
    private DateTime? _startDate = DateTime.Today.AddMonths(-1);
    private DateTime? _endDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadPaymentsAsync();
        CalculateStatistics();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadDensityAsync();
            StateHasChanged();
        }
    }

    private async Task LoadDensityAsync()
    {
        try
        {
            var densityJson = await JS.InvokeAsync<string>("localStorage.getItem", "ibn-density");
            if (!string.IsNullOrEmpty(densityJson))
            {
                _currentDensity = System.Text.Json.JsonSerializer.Deserialize<string>(densityJson) ?? "comfortable";
            }

            // If compact density, optionally collapse the history by default to keep header area small
            if (_currentDensity == "compact")
            {
                // keep PastDue and Scheduled expanded ï¿½ history collapsed by default (you can change)
                _showPastDue = true;
                _showScheduled = true;
                _showHistory = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading density: {ex.Message}");
            _currentDensity = "comfortable";
        }
    }

    private void SetDisplayMode(string mode)
    {
        _displayMode = mode;
        Url.Update(new Dictionary<string, string?> { ["mode"] = mode });
    }

    private async Task LoadPaymentsAsync()
    {
        var allPayments = TechCreditPaymentsSeedData.GetPayments();

        _pastDuePayments = allPayments
            .Where(p => p.IsPastDue && p.PastDueAmount > 0)
            .OrderByDescending(p => p.DaysOverdue)
            .ToList();

        _scheduledPayments = allPayments
            .Where(p => p.ScheduledDate.HasValue && p.ScheduledDate.Value >= DateTime.Today)
            .OrderBy(p => p.ScheduledDate)
            .ToList();

        _paymentHistory = allPayments
            .Where(p => p.PaymentDate.HasValue &&
                       p.PaymentDate.Value >= _startDate &&
                       p.PaymentDate.Value <= _endDate &&
                       p.PaymentStatus != "Remitted")
            .OrderByDescending(p => p.PaymentDate)
            .ToList();

        _remittedPayments = allPayments
            .Where(p => p.PaymentStatus == "Remitted" &&
                       p.PaymentDate.HasValue &&
                       p.PaymentDate.Value >= _startDate &&
                       p.PaymentDate.Value <= _endDate)
            .OrderByDescending(p => p.RemittedDate)
            .ToList();

        await Task.CompletedTask;
    }

    private void CalculateStatistics()
    {
        _totalPastDue = _pastDuePayments.Sum(p => p.PastDueAmount);
        _pastDueCount = _pastDuePayments.Count;

        var weekFromNow = DateTime.Today.AddDays(7);
        var dueThisWeek = _scheduledPayments
            .Where(p => p.ScheduledDate.HasValue && p.ScheduledDate.Value <= weekFromNow)
            .ToList();
        _dueThisWeek = dueThisWeek.Sum(p => p.AmountDue);
        _dueThisWeekCount = dueThisWeek.Count;

        var todaysPayments = _paymentHistory
            .Where(p => p.PaymentDate.HasValue && p.PaymentDate.Value.Date == DateTime.Today)
            .ToList();
        _collectedToday = todaysPayments.Sum(p => p.AmountPaid);
        _collectedTodayCount = todaysPayments.Count;

        var next30Days = DateTime.Today.AddDays(30);
        var scheduled30 = _scheduledPayments
            .Where(p => p.ScheduledDate.HasValue && p.ScheduledDate.Value <= next30Days)
            .ToList();
        _scheduledNext30Days = scheduled30.Sum(p => p.AmountDue);
        _scheduledNext30DaysCount = scheduled30.Count;
    }

    private void ChangeView(string view)
    {
        _view = view;
        Url.Update(new Dictionary<string, string?> { ["view"] = view });
    }

    private async Task OnDateRangeChanged()
    {
        await LoadPaymentsAsync();
    }

    private void OnPaymentRowClick(GridRowClickEventArgs args)
    {
        var payment = (PaymentRecord)args.Item;
        OpenPaymentSidebar(payment);
    }

    private void OpenPaymentSidebar(PaymentRecord payment)
    {
        SidePanel.OnPaymentActionCompleted += RefreshData;
        SidePanel.OpenPaymentPanel(payment, PaymentSidePanelMode.Details);
    }

    private async Task RefreshData()
    {
        await LoadPaymentsAsync();
        CalculateStatistics();
        StateHasChanged();
    }

    private void RecordPayment(PaymentRecord payment)
    {
        SidePanel.OnPaymentActionCompleted += RefreshData;
        SidePanel.OpenPaymentPanel(payment, PaymentSidePanelMode.RecordPayment);
    }

    private void LogContact(PaymentRecord payment)
    {
        SidePanel.OnPaymentActionCompleted += RefreshData;
        SidePanel.OpenPaymentPanel(payment, PaymentSidePanelMode.LogContact);
    }

    private async Task SendReminders()
    {
        await Task.CompletedTask;
    }

    private async Task ExportToExcel()
    {
        await Task.CompletedTask;
    }

    private async Task PrintPayments()
    {
        await Task.CompletedTask;
    }

    private async Task PrintReceipt(PaymentRecord payment)
    {
        await Task.CompletedTask;
    }

    private string GetOverdueSeverity(int daysOverdue)
    {
        if (daysOverdue >= 30) return "critical";
        if (daysOverdue >= 14) return "high";
        if (daysOverdue >= 7) return "medium";
        return "low";
    }

    private string GetStatusBadgeClass(string status)
    {
        return status?.ToLower() switch
        {
            "completed" => "success",
            "pending" => "warning",
            "failed" => "danger",
            "reversed" => "secondary",
            _ => "info"
        };
    }

    // ===== Density-Aware Sizing =====

    private string GetGridHeight()
    {
        return _currentDensity switch
        {
            "compact" => "350px",
            "spacious" => "550px",
            _ => "450px"
        };
    }

    private int GetPageSize()
    {
        return _currentDensity switch
        {
            "compact" => 15,
            "spacious" => 10,
            _ => 12
        };
    }

    private string GetCheckboxWidth()
    {
        return _currentDensity switch
        {
            "compact" => "40px",
            "spacious" => "60px",
            _ => "50px"
        };
    }

    private string GetColumnWidth(string type)
    {
        return type switch
        {
            "name" => _currentDensity == "compact" ? "150px" : _currentDensity == "spacious" ? "250px" : "200px",
            "id" => _currentDensity == "compact" ? "100px" : _currentDensity == "spacious" ? "150px" : "130px",
            "days" => _currentDensity == "compact" ? "80px" : _currentDensity == "spacious" ? "120px" : "100px",
            "currency" => _currentDensity == "compact" ? "100px" : _currentDensity == "spacious" ? "140px" : "120px",
            "date" => _currentDensity == "compact" ? "100px" : _currentDensity == "spacious" ? "150px" : "130px",
            "text" => _currentDensity == "compact" ? "90px" : _currentDensity == "spacious" ? "130px" : "110px",
            "phone" => _currentDensity == "compact" ? "110px" : _currentDensity == "spacious" ? "160px" : "140px",
            "small" => _currentDensity == "compact" ? "70px" : _currentDensity == "spacious" ? "110px" : "100px",
            "actions" => _currentDensity == "compact" ? "100px" : _currentDensity == "spacious" ? "180px" : "150px",
            "actions-small" => _currentDensity == "compact" ? "70px" : _currentDensity == "spacious" ? "110px" : "90px",
            "reference" => _currentDensity == "compact" ? "100px" : _currentDensity == "spacious" ? "150px" : "130px",
            "status" => _currentDensity == "compact" ? "90px" : _currentDensity == "spacious" ? "130px" : "110px",
            _ => "120px"
        };
    }

    // ===== Grid Rendering Methods =====

    private RenderFragment RenderPastDueGrid() => __builder =>
    {
        <div class="grid-container">
            <TelerikGrid Data="@_pastDuePayments"
                         Height="@GetGridHeight()"
                         Pageable="true"
                         PageSize="@GetPageSize()"
                         Sortable="true"
                         FilterMode="GridFilterMode.FilterRow"
                         Resizable="true"
                         Reorderable="true"
                         SelectionMode="GridSelectionMode.Multiple"
                         @bind-SelectedItems="@_selectedPayments"
                         OnRowClick="@OnPaymentRowClick">
                <GridColumns>
                    <GridCheckboxColumn Width="@GetCheckboxWidth()" />
                    <GridColumn Field="@nameof(PaymentRecord.CustomerName)" Title="Customer" Width="@GetColumnWidth("name")" />
                    <GridColumn Field="@nameof(PaymentRecord.BorrowerId)" Title="Borrower ID" Width="@GetColumnWidth("id")" />
                    <GridColumn Field="@nameof(PaymentRecord.DaysOverdue)" Title="Days Late" Width="@GetColumnWidth("days")">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <span class="days-overdue days-@GetOverdueSeverity(payment.DaysOverdue)">
                                    @payment.DaysOverdue days
                                </span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(PaymentRecord.AmountDue)" Title="Amount Due" Width="@GetColumnWidth("currency")" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.PastDueAmount)" Title="Past Due" Width="@GetColumnWidth("currency")" DisplayFormat="{0:C2}">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <span class="past-due-amount">@payment.PastDueAmount.ToString("C2")</span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(PaymentRecord.LastPaymentDate)" Title="Last Payment" Width="@GetColumnWidth("date")" DisplayFormat="{0:MM/dd/yyyy}" />
                    <GridColumn Field="@nameof(PaymentRecord.LastPaymentAmount)" Title="Last Pmt Amt" Width="@GetColumnWidth("currency")" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.PaymentFrequency)" Title="Frequency" Width="@GetColumnWidth("text")" />
                    <GridColumn Field="@nameof(PaymentRecord.CurrentBalance)" Title="Balance" Width="@GetColumnWidth("currency")" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.Phone)" Title="Phone" Width="@GetColumnWidth("phone")" />
                    <GridColumn Field="@nameof(PaymentRecord.ContactAttempts)" Title="Attempts" Width="@GetColumnWidth("small")" />
                    <GridColumn Title="Actions" Width="@GetColumnWidth("actions")">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <div class="action-buttons">
                                    <TelerikButton Icon="@SvgIcon.Dollar"
                                                   OnClick="@(() => RecordPayment(payment))"
                                                   Size="@ThemeConstants.Button.Size.Small"
                                                   Title="Record Payment">
                                    </TelerikButton>
                                    <TelerikButton Icon="@SvgIcon.TabletSolid"
                                                   OnClick="@(() => LogContact(payment))"
                                                   Size="@ThemeConstants.Button.Size.Small"
                                                   Title="Log Contact">
                                    </TelerikButton>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </TelerikGrid>
        </div>
    };

    private RenderFragment RenderScheduledGrid() => __builder =>
    {
        <div class="grid-container">
            <TelerikGrid Data="@_scheduledPayments"
                         Height="@GetGridHeight()"
                         Pageable="true"
                         PageSize="@GetPageSize()"
                         Sortable="true"
                         FilterMode="GridFilterMode.FilterRow"
                         Resizable="true"
                         Reorderable="true"
                         SelectionMode="GridSelectionMode.Single"
                         @bind-SelectedItems="@_selectedPayments"
                         OnRowClick="@OnPaymentRowClick">
                <GridColumns>
                    <GridColumn Field="@nameof(PaymentRecord.ScheduledDate)" Title="Scheduled Date" Width="@GetColumnWidth("date")" DisplayFormat="{0:MM/dd/yyyy}">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                var daysUntil = (payment.ScheduledDate.GetValueOrDefault() - DateTime.Today).Days;
                                <span class="scheduled-date @(daysUntil <= 7 ? "due-soon" : "")">
                                    @payment.ScheduledDate?.ToString("MM/dd/yyyy")
                                    @if (daysUntil <= 7)
                                    {
                                        <span class="days-badge">@daysUntil days</span>
                                    }
                                </span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(PaymentRecord.CustomerName)" Title="Customer" Width="@GetColumnWidth("name")" />
                    <GridColumn Field="@nameof(PaymentRecord.BorrowerId)" Title="Borrower ID" Width="@GetColumnWidth("id")" />
                    <GridColumn Field="@nameof(PaymentRecord.AmountDue)" Title="Amount Due" Width="@GetColumnWidth("currency")" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.CurrentBalance)" Title="Balance" Width="@GetColumnWidth("currency")" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.PaymentFrequency)" Title="Frequency" Width="@GetColumnWidth("text")" />
                    <GridColumn Field="@nameof(PaymentRecord.PaymentMethod)" Title="Method" Width="@GetColumnWidth("text")" />
                    <GridColumn Field="@nameof(PaymentRecord.Phone)" Title="Phone" Width="@GetColumnWidth("phone")" />
                    <GridColumn Title="Actions" Width="@GetColumnWidth("actions")">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <div class="action-buttons">
                                    <TelerikButton Icon="@SvgIcon.Dollar"
                                                   OnClick="@(() => RecordPayment(payment))"
                                                   Size="@ThemeConstants.Button.Size.Small"
                                                   Title="Record Payment">
                                    </TelerikButton>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </TelerikGrid>
        </div>
    };

    private RenderFragment RenderHistoryGrid() => __builder =>
    {
        <div class="grid-container">
            <TelerikGrid Data="@_paymentHistory"
                         Height="@GetGridHeight()"
                         Pageable="true"
                         PageSize="@GetPageSize()"
                         Sortable="true"
                         FilterMode="GridFilterMode.FilterRow"
                         Resizable="true"
                         Reorderable="true"
                         SelectionMode="GridSelectionMode.Single"
                         @bind-SelectedItems="@_selectedPayments"
                         OnRowClick="@OnPaymentRowClick">
                <GridColumns>
                    <GridColumn Field="@nameof(PaymentRecord.PaymentDate)" Title="Payment Date" Width="@GetColumnWidth("date")" DisplayFormat="{0:MM/dd/yyyy}" />
                    <GridColumn Field="@nameof(PaymentRecord.CustomerName)" Title="Customer" Width="@GetColumnWidth("name")" />
                    <GridColumn Field="@nameof(PaymentRecord.BorrowerId)" Title="Borrower ID" Width="@GetColumnWidth("id")" />
                    <GridColumn Field="@nameof(PaymentRecord.AmountPaid)" Title="Amount Paid" Width="@GetColumnWidth("currency")" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.PaymentMethod)" Title="Method" Width="@GetColumnWidth("text")" />
                    <GridColumn Field="@nameof(PaymentRecord.ReferenceNumber)" Title="Reference #" Width="@GetColumnWidth("reference")" />
                    <GridColumn Field="@nameof(PaymentRecord.PaymentStatus)" Title="Status" Width="@GetColumnWidth("status")">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <span class="badge badge-@GetStatusBadgeClass(payment.PaymentStatus)">
                                    @payment.PaymentStatus
                                </span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(PaymentRecord.CurrentBalance)" Title="Balance After" Width="@GetColumnWidth("currency")" DisplayFormat="{0:C2}" />
                    <GridColumn Title="Actions" Width="@GetColumnWidth("actions-small")">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <div class="action-buttons">
                                    <TelerikButton Icon="@SvgIcon.Print"
                                                   OnClick="@(() => PrintReceipt(payment))"
                                                   Size="@ThemeConstants.Button.Size.Small"
                                                   Title="Print Receipt">
                                    </TelerikButton>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </TelerikGrid>
        </div>
    };

    private RenderFragment RenderRemittedGrid() => __builder =>
    {
        <div class="grid-container">
            <TelerikGrid Data="@_remittedPayments"
                         Height="@GetGridHeight()"
                         Pageable="true"
                         PageSize="@GetPageSize()"
                         Sortable="true"
                         FilterMode="GridFilterMode.FilterRow"
                         Resizable="true"
                         Reorderable="true"
                         SelectionMode="GridSelectionMode.Single"
                         @bind-SelectedItems="@_selectedPayments"
                         OnRowClick="@OnPaymentRowClick">
                <GridColumns>
                    <GridColumn Field="@nameof(PaymentRecord.RemittedDate)" Title="Remitted Date" Width="@GetColumnWidth("date")" DisplayFormat="{0:MM/dd/yyyy}" />
                    <GridColumn Field="@nameof(PaymentRecord.PaymentDate)" Title="Payment Date" Width="@GetColumnWidth("date")" DisplayFormat="{0:MM/dd/yyyy}" />
                    <GridColumn Field="@nameof(PaymentRecord.CustomerName)" Title="Customer" Width="@GetColumnWidth("name")" />
                    <GridColumn Field="@nameof(PaymentRecord.BorrowerId)" Title="Borrower ID" Width="@GetColumnWidth("id")" />
                    <GridColumn Field="@nameof(PaymentRecord.RemittedAmount)" Title="Remitted Amount" Width="@GetColumnWidth("currency")" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.PaymentMethod)" Title="Method" Width="@GetColumnWidth("text")" />
                    <GridColumn Field="@nameof(PaymentRecord.ReferenceNumber)" Title="Reference #" Width="@GetColumnWidth("reference")" />
                    <GridColumn Field="@nameof(PaymentRecord.RemittedBatchNumber)" Title="Batch #" Width="@GetColumnWidth("reference")" />
                    <GridColumn Field="@nameof(PaymentRecord.RemittedTo)" Title="Remitted To" Width="@GetColumnWidth("text")" />
                    <GridColumn Field="@nameof(PaymentRecord.CurrentBalance)" Title="Balance After" Width="@GetColumnWidth("currency")" DisplayFormat="{0:C2}" />
                    <GridColumn Title="Actions" Width="@GetColumnWidth("actions-small")">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <div class="action-buttons">
                                    <TelerikButton Icon="@SvgIcon.Print"
                                                   OnClick="@(() => PrintReceipt(payment))"
                                                   Size="@ThemeConstants.Button.Size.Small"
                                                   Title="Print Receipt">
                                    </TelerikButton>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </TelerikGrid>
        </div>
    };

    public override void Dispose()
    {
        SidePanel.OnPaymentActionCompleted -= RefreshData;
        base.Dispose();
    }
}
