@page "/techcredit/payments"
@inherits PageWithSidebarBase
@using Prototype.Components.SharedComponents.Sidepanel
@using Prototype.Pages.Collections
@using Prototype.Components.Pages.Collections.TechCredit
@using Services
@using global::Services
@using static Prototype.Components.Pages.Collections.TechCredit.TechCreditPaymentsSeedData
@inject SidePanelService SidePanel

<PageTitle>TechCredit Payments</PageTitle>

<div class="techcredit-payments-page">
    <div class="page-header">
        <div class="header-main">
            <h1>TechCredit Payments</h1>
            <div class="view-selector">
                <button class="view-tab @(_view == "PastDue" ? "active" : "")"
                        @onclick='() => ChangeView("PastDue")'>
                    <span class="k-icon k-i-warning"></span>
                    Past Due (@_pastDueCount)
                </button>
                <button class="view-tab @(_view == "Scheduled" ? "active" : "")"
                        @onclick='() => ChangeView("Scheduled")'>
                    <span class="k-icon k-i-calendar"></span>
                    Scheduled (@_scheduledPayments.Count)
                </button>
                <button class="view-tab @(_view == "History" ? "active" : "")"
                        @onclick='() => ChangeView("History")'>
                    <span class="k-icon k-i-file-txt"></span>
                    History
                </button>
            </div>
        </div>
        <div class="header-stats">
            <div class="stat-card stat-danger">
                <div class="stat-label">Total Past Due</div>
                <div class="stat-value">@_totalPastDue.ToString("C2")</div>
                <div class="stat-sublabel">@_pastDueCount accounts</div>
            </div>
            <div class="stat-card stat-warning">
                <div class="stat-label">Due This Week</div>
                <div class="stat-value">@_dueThisWeek.ToString("C2")</div>
                <div class="stat-sublabel">@_dueThisWeekCount payments</div>
            </div>
            <div class="stat-card stat-success">
                <div class="stat-label">Collected Today</div>
                <div class="stat-value">@_collectedToday.ToString("C2")</div>
                <div class="stat-sublabel">@_collectedTodayCount payments</div>
            </div>
            <div class="stat-card stat-info">
                <div class="stat-label">Scheduled Next 30 Days</div>
                <div class="stat-value">@_scheduledNext30Days.ToString("C2")</div>
                <div class="stat-sublabel">@_scheduledNext30DaysCount payments</div>
            </div>
        </div>
    </div>

    <div class="toolbar-section">
        <div class="toolbar-left">
            <TelerikButton Icon="@SvgIcon.RecycleSolid"
                           OnClick="@RefreshData"
                           ThemeColor="@ThemeConstants.Button.ThemeColor.Base">
                Refresh
            </TelerikButton>

            @if (_view == "PastDue")
            {
                <TelerikButton Icon="@SvgIcon.MyspaceBox"
                               OnClick="@SendReminders"
                               ThemeColor="@ThemeConstants.Button.ThemeColor.Primary"
                               Enabled="@(_selectedPayments.Any())">
                    Send Reminders (@_selectedPayments.Count())
                </TelerikButton>
            }

            <TelerikButton Icon="@SvgIcon.FileExcel"
                           OnClick="@ExportToExcel"
                           ThemeColor="@ThemeConstants.Button.ThemeColor.Success">
                Export
            </TelerikButton>

            <TelerikButton Icon="@SvgIcon.Print"
                           OnClick="@PrintPayments"
                           ThemeColor="@ThemeConstants.Button.ThemeColor.Base">
                Print
            </TelerikButton>
        </div>

        <div class="toolbar-right">
            @if (_view == "History")
            {
                <div class="date-range-filter">
                    <label>Date Range:</label>
                    <TelerikDateRangePicker @bind-StartValue="@_startDate"
                                            @bind-EndValue="@_endDate"
                                            OnChange="@OnDateRangeChanged">
                    </TelerikDateRangePicker>
                </div>
            }
        </div>
    </div>

    @if (_view == "PastDue")
    {
        <div class="grid-container">
            <TelerikGrid Data="@_pastDuePayments"
                         Height="calc(100vh - 380px)"
                         Pageable="true"
                         PageSize="25"
                         Sortable="true"
                         FilterMode="GridFilterMode.FilterRow"
                         Resizable="true"
                         Reorderable="true"
                         SelectionMode="GridSelectionMode.Multiple"
                         @bind-SelectedItems="@_selectedPayments"
                         OnRowClick="@OnPaymentRowClick">
                <GridColumns>
                    <GridCheckboxColumn Width="50px" />
                    <GridColumn Field="@nameof(PaymentRecord.CustomerName)" Title="Customer" Width="200px" />
                    <GridColumn Field="@nameof(PaymentRecord.BorrowerId)" Title="Borrower ID" Width="130px" />
                    <GridColumn Field="@nameof(PaymentRecord.DaysOverdue)" Title="Days Late" Width="100px">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <span class="days-overdue days-@GetOverdueSeverity(payment.DaysOverdue)">
                                    @payment.DaysOverdue days
                                </span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(PaymentRecord.AmountDue)" Title="Amount Due" Width="120px" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.PastDueAmount)" Title="Past Due" Width="120px" DisplayFormat="{0:C2}">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <span class="past-due-amount">@payment.PastDueAmount.ToString("C2")</span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(PaymentRecord.LastPaymentDate)" Title="Last Payment" Width="130px" DisplayFormat="{0:MM/dd/yyyy}" />
                    <GridColumn Field="@nameof(PaymentRecord.LastPaymentAmount)" Title="Last Pmt Amt" Width="130px" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.PaymentFrequency)" Title="Frequency" Width="110px" />
                    <GridColumn Field="@nameof(PaymentRecord.CurrentBalance)" Title="Balance" Width="120px" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.Phone)" Title="Phone" Width="140px" />
                    <GridColumn Field="@nameof(PaymentRecord.ContactAttempts)" Title="Attempts" Width="100px" />
                    <GridColumn Title="Actions" Width="150px">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <div class="action-buttons">
                                    <TelerikButton Icon="@SvgIcon.Dollar"
                                                   OnClick="@(() => RecordPayment(payment))"
                                                   Size="@ThemeConstants.Button.Size.Small"
                                                   Title="Record Payment">
                                    </TelerikButton>
                                    <TelerikButton Icon="@SvgIcon.TabletSolid"
                                                   OnClick="@(() => LogContact(payment))"
                                                   Size="@ThemeConstants.Button.Size.Small"
                                                   Title="Log Contact">
                                    </TelerikButton>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </TelerikGrid>
        </div>
    }
    else if (_view == "Scheduled")
    {
        <div class="grid-container">
            <TelerikGrid Data="@_scheduledPayments"
                         Height="calc(100vh - 380px)"
                         Pageable="true"
                         PageSize="25"
                         Sortable="true"
                         FilterMode="GridFilterMode.FilterRow"
                         Resizable="true"
                         Reorderable="true"
                         SelectionMode="GridSelectionMode.Single"
                         @bind-SelectedItems="@_selectedPayments"
                         OnRowClick="@OnPaymentRowClick">
                <GridColumns>
                    <GridColumn Field="@nameof(PaymentRecord.ScheduledDate)" Title="Scheduled Date" Width="140px" DisplayFormat="{0:MM/dd/yyyy}">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                var daysUntil = (payment.ScheduledDate.GetValueOrDefault() - DateTime.Today).Days;
                                <span class="scheduled-date @(daysUntil <= 7 ? "due-soon" : "")">
                                    @payment.ScheduledDate?.ToString("MM/dd/yyyy")
                                    @if (daysUntil <= 7)
                                    {
                                        <span class="days-badge">@daysUntil days</span>
                                    }
                                </span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(PaymentRecord.CustomerName)" Title="Customer" Width="200px" />
                    <GridColumn Field="@nameof(PaymentRecord.BorrowerId)" Title="Borrower ID" Width="130px" />
                    <GridColumn Field="@nameof(PaymentRecord.AmountDue)" Title="Amount Due" Width="120px" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.PaymentMethod)" Title="Method" Width="120px" />
                    <GridColumn Field="@nameof(PaymentRecord.PaymentFrequency)" Title="Frequency" Width="110px" />
                    <GridColumn Field="@nameof(PaymentRecord.CurrentBalance)" Title="Balance" Width="120px" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.Phone)" Title="Phone" Width="140px" />
                    <GridColumn Title="Actions" Width="120px">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <div class="action-buttons">
                                    <TelerikButton Icon="@SvgIcon.Dollar"
                                                   OnClick="@(() => RecordPayment(payment))"
                                                   Size="@ThemeConstants.Button.Size.Small"
                                                   Title="Record Payment">
                                    </TelerikButton>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </TelerikGrid>
        </div>
    }
    else if (_view == "History")
    {
        <div class="grid-container">
            <TelerikGrid Data="@_paymentHistory"
                         Height="calc(100vh - 380px)"
                         Pageable="true"
                         PageSize="25"
                         Sortable="true"
                         FilterMode="GridFilterMode.FilterRow"
                         Resizable="true"
                         Reorderable="true"
                         SelectionMode="GridSelectionMode.Single"
                         @bind-SelectedItems="@_selectedPayments"
                         OnRowClick="@OnPaymentRowClick">
                <GridColumns>
                    <GridColumn Field="@nameof(PaymentRecord.PaymentDate)" Title="Payment Date" Width="140px" DisplayFormat="{0:MM/dd/yyyy}" />
                    <GridColumn Field="@nameof(PaymentRecord.CustomerName)" Title="Customer" Width="200px" />
                    <GridColumn Field="@nameof(PaymentRecord.BorrowerId)" Title="Borrower ID" Width="130px" />
                    <GridColumn Field="@nameof(PaymentRecord.AmountPaid)" Title="Amount Paid" Width="120px" DisplayFormat="{0:C2}" />
                    <GridColumn Field="@nameof(PaymentRecord.PaymentMethod)" Title="Method" Width="120px" />
                    <GridColumn Field="@nameof(PaymentRecord.PaymentStatus)" Title="Status" Width="100px">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <span class="badge badge-@GetStatusBadgeClass(payment.PaymentStatus)">
                                    @payment.PaymentStatus
                                </span>
                            }
                        </Template>
                    </GridColumn>
                    <GridColumn Field="@nameof(PaymentRecord.ProcessedBy)" Title="Processed By" Width="140px" />
                    <GridColumn Title="Actions" Width="100px">
                        <Template>
                            @{
                                var payment = (PaymentRecord)context;
                                <div class="action-buttons">
                                    <TelerikButton Icon="@SvgIcon.Print"
                                                   OnClick="@(() => PrintReceipt(payment))"
                                                   Size="@ThemeConstants.Button.Size.Small"
                                                   Title="Print Receipt">
                                    </TelerikButton>
                                </div>
                            }
                        </Template>
                    </GridColumn>
                </GridColumns>
            </TelerikGrid>
        </div>
    }
</div>

<!-- Side Panel for Payment Preview -->
<SidePanel IsOpen="@SidePanel.IsOpen"
           IsOpenChanged="@((value) => { if (!value) SidePanel.Close(); })"
           Title="@GetSidePanelTitle()">
    @if (SidePanel.ContentType == Prototype.Components.Services.SidePanelContentType.Payment)
    {
        <PaymentSidePanelContent />
    }
</SidePanel>

@code {
    // ===== Required by PageWithSidebarBase =====

    protected override string BasePath => "/techcredit/payments";

    protected override IEnumerable<Facet> Facets()
    {
        return new[]
        {
            new Facet(
                Key: "option",
                Title: "Option",
                Options: () => new[]
                {
                    new FacetOption("Customer Information", "Customer Information", Href: AppendPreserved("/techcredit/customerinformation")),
                    new FacetOption("Credit Application", "Credit Application", Href: AppendPreserved("/techcredit/creditapplication")),
                    new FacetOption("Sales Authorizations", "Sales Authorizations", Href: AppendPreserved("/techcredit/salesauthorizations")),
                    new FacetOption("WCS", "WCS", Href: AppendPreserved("/techcredit/wcs")),
                    new FacetOption("Payments", "Payments", Href: AppendPreserved("/techcredit/payments"))
                }
            ),
            new Facet(
                Key: "status",
                Title: "Customer Status",
                Options: () => new[]
                {
                    new FacetOption("All", "All"),
                    new FacetOption("TC Borrowers", "TC Borrowers"),
                    new FacetOption("TC Past Due", "TC Past Due")
                }
            )
        };
    }

    private string _view = "PastDue";
    private string _status = "All";

    protected override IReadOnlyDictionary<string, string?> Scalars => new Dictionary<string, string?>
    {
        ["view"] = _view,
        ["status"] = _status
    };

    protected override IReadOnlyCollection<string> MultiValues => Array.Empty<string>();

    protected override void ReadFromUrl()
    {
        _view = Url.Get("view") ?? "PastDue";
        _status = Url.Get("status") ?? "All";
    }

    // ===== Page Data =====

    private List<PaymentRecord> _pastDuePayments = new();
    private List<PaymentRecord> _scheduledPayments = new();
    private List<PaymentRecord> _paymentHistory = new();
    private IEnumerable<PaymentRecord> _selectedPayments = new List<PaymentRecord>();

    // Statistics
    private decimal _totalPastDue = 0m;
    private int _pastDueCount = 0;
    private decimal _dueThisWeek = 0m;
    private int _dueThisWeekCount = 0;
    private decimal _collectedToday = 0m;
    private int _collectedTodayCount = 0;
    private decimal _scheduledNext30Days = 0m;
    private int _scheduledNext30DaysCount = 0;

    // Date range for history
    private DateTime? _startDate = DateTime.Today.AddMonths(-1);
    private DateTime? _endDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync(); // This handles sidebar setup
        await LoadPaymentsAsync();
        CalculateStatistics();
    }

    private async Task LoadPaymentsAsync()
    {
        var allPayments = TechCreditPaymentsSeedData.GetPayments();

        _pastDuePayments = allPayments
            .Where(p => p.IsPastDue && p.PastDueAmount > 0)
            .OrderByDescending(p => p.DaysOverdue)
            .ToList();

        _scheduledPayments = allPayments
            .Where(p => p.ScheduledDate.HasValue && p.ScheduledDate.Value >= DateTime.Today)
            .OrderBy(p => p.ScheduledDate)
            .ToList();

        _paymentHistory = allPayments
            .Where(p => p.PaymentDate.HasValue &&
                       p.PaymentDate.Value >= _startDate &&
                       p.PaymentDate.Value <= _endDate)
            .OrderByDescending(p => p.PaymentDate)
            .ToList();

        await Task.CompletedTask;
    }

    private void CalculateStatistics()
    {
        _totalPastDue = _pastDuePayments.Sum(p => p.PastDueAmount);
        _pastDueCount = _pastDuePayments.Count;

        var weekFromNow = DateTime.Today.AddDays(7);
        var dueThisWeek = _scheduledPayments
            .Where(p => p.ScheduledDate.HasValue && p.ScheduledDate.Value <= weekFromNow)
            .ToList();
        _dueThisWeek = dueThisWeek.Sum(p => p.AmountDue);
        _dueThisWeekCount = dueThisWeek.Count;

        var todaysPayments = _paymentHistory
            .Where(p => p.PaymentDate.HasValue && p.PaymentDate.Value.Date == DateTime.Today)
            .ToList();
        _collectedToday = todaysPayments.Sum(p => p.AmountPaid);
        _collectedTodayCount = todaysPayments.Count;

        var next30Days = DateTime.Today.AddDays(30);
        var scheduled30 = _scheduledPayments
            .Where(p => p.ScheduledDate.HasValue && p.ScheduledDate.Value <= next30Days)
            .ToList();
        _scheduledNext30Days = scheduled30.Sum(p => p.AmountDue);
        _scheduledNext30DaysCount = scheduled30.Count;
    }

    private void ChangeView(string view)
    {
        _view = view;
        Url.Update(new Dictionary<string, string?> { ["view"] = view });
    }

    private async Task OnDateRangeChanged()
    {
        await LoadPaymentsAsync();
    }

    private void OnPaymentRowClick(GridRowClickEventArgs args)
    {
        var payment = (PaymentRecord)args.Item;
        OpenPaymentSidebar(payment);
    }

    private void OpenPaymentSidebar(PaymentRecord payment)
    {
        SidePanel.OnPaymentActionCompleted += RefreshData;
        SidePanel.OpenPaymentPanel(payment, PaymentSidePanelMode.Details);
    }

    private async Task RefreshData()
    {
        await LoadPaymentsAsync();
        CalculateStatistics();
        StateHasChanged();
    }

    private void RecordPayment(PaymentRecord payment)
    {
        SidePanel.OnPaymentActionCompleted += RefreshData;
        SidePanel.OpenPaymentPanel(payment, PaymentSidePanelMode.RecordPayment);
    }

    private void LogContact(PaymentRecord payment)
    {
        SidePanel.OnPaymentActionCompleted += RefreshData;
        SidePanel.OpenPaymentPanel(payment, PaymentSidePanelMode.LogContact);
    }

    private async Task SendReminders()
    {
        await Task.CompletedTask;
    }

    private async Task ExportToExcel()
    {
        await Task.CompletedTask;
    }

    private async Task PrintPayments()
    {
        await Task.CompletedTask;
    }

    private async Task PrintReceipt(PaymentRecord payment)
    {
        await Task.CompletedTask;
    }

    private string GetOverdueSeverity(int daysOverdue)
    {
        if (daysOverdue >= 30) return "critical";
        if (daysOverdue >= 14) return "high";
        if (daysOverdue >= 7) return "medium";
        return "low";
    }

    private string GetStatusBadgeClass(string status)
    {
        return status?.ToLower() switch
        {
            "completed" => "success",
            "pending" => "warning",
            "failed" => "danger",
            "reversed" => "secondary",
            _ => "info"
        };
    }

    private string GetSidePanelTitle()
    {
        return SidePanel.PaymentMode switch
        {
            PaymentSidePanelMode.Details => "Payment Details",
            PaymentSidePanelMode.RecordPayment => "Record Payment",
            PaymentSidePanelMode.LogContact => "Log Contact",
            _ => "Payment"
        };
    }

    public override void Dispose()
    {
        SidePanel.OnPaymentActionCompleted -= RefreshData;
        base.Dispose();
    }
}
