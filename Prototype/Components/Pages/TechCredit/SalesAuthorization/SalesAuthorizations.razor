@page "/techcredit/salesauthorizations"
@attribute [Authorize(Policy = AppPolicies.TechCredit)]

@using Microsoft.AspNetCore.WebUtilities
@using Prototype.Components.Layout.Navigation.Sidebar
@using Prototype.Components.Pages.Collections.SalesAuthorizations
@using Prototype.Components.SharedComponents
@using Prototype.Pages.Collections
@using Telerik.Blazor
@using Telerik.Blazor.Components
@using static Prototype.Components.Pages.Collections.SalesAuthorizations.SalesAuthorizationsSeedData

@inherits PageWithSidebarBase

@inject IJSRuntime JS

<div class="wrap">
    <header class="header">
        <h3 class="title">Sales Authorizations</h3>
    </header>

    <section class="card sales-auth-layout">
        <!-- Use shared customer list component -->
        <TechCreditCustomerList TCustomer="SalesAuth"
                                Customers="@FilteredCustomers"
                                SelectedCustomerId="@Params.SelectedCustomer"
                                GetCustomerId="@(c => c.CustomerId)"
                                GetCustomerName="@(c => c.CustomerName)"
                                OnCustomerSelected="@SelectCustomer" />

        <div class="detail-panel">
            @if (SelectedAuthorization != null)
            {
                var auth = SelectedAuthorization;

                <!-- Customer Header -->
                <div class="customer-header">
                    <div class="header-field">
                        <label>Phone</label>
                        <input readonly value="@auth.Phone" />
                    </div>
                    <div class="header-field">
                        <label>Customer Profile</label>
                        <input readonly value="@auth.CustomerProfile" />
                    </div>
                    <div class="header-field">
                        <label>Borrower ID</label>
                        <input readonly value="@auth.CustomerId" />
                    </div>
                </div>

                <!-- Sales Authorization Recap -->
                <div class="recap-section">
                    <div class="recap-header">
                        <h4>Sales Authorization Recap</h4>
                    </div>

                    <div class="recap-layout">
                        <!-- Blue Ribbon Sale Column -->
                        <div class="blue-ribbon-column">
                            <div class="section-title">Blue Ribbon Sale</div>

                            <div class="form-field">
                                <label>A1. This Sale</label>
                                <input readonly value="@auth.ThisSale.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>A2. Rollover Amount</label>
                                <input readonly value="@auth.RolloverAmount.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>B. Less Trade In</label>
                                <input readonly value="@auth.LessTradeIn.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>C. Sales Tax</label>
                                <input readonly value="@auth.SalesTax.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>E. Admin Fee</label>
                                <input readonly value="@auth.AdminFee.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>F. Previous Balance</label>
                                <input readonly value="@auth.PreviousBalance.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>G. New CTC Balance</label>
                                <input readonly value="@auth.NewCTCBalance.ToString("C")" class="highlight-field" />
                            </div>
                        </div>

                        <!-- Auth Details Column -->
                        <div class="auth-details-column">
                            <div class="form-field">
                                <label>IBN Sales Auth #</label>
                                <input readonly value="@auth.IBNSalesAuthNumber" />
                            </div>

                            <div class="form-field">
                                <label>Date</label>
                                <input readonly value="@auth.IBNDate.ToString("MM/dd/yyyy")" />
                            </div>

                            <div class="spacer"></div>

                            <div class="form-field">
                                <label>CQT Sales Auth #</label>
                                <input readonly value="@auth.CQTSalesAuthNumber" />
                            </div>

                            <div class="form-field">
                                <label>D. Net Sale</label>
                                <input readonly value="@auth.NetSale.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>Date</label>
                                <input readonly value="@auth.CQTDate.ToString("MM/dd/yyyy")" />
                            </div>
                        </div>
                    </div>

                    <!-- Payment Details Row -->
                    <div class="payment-details">
                        <div class="form-field">
                            <label>Weekly Pay Amt</label>
                            <input readonly value="@auth.WeeklyPayAmt.ToString("C")" />
                        </div>
                        <div class="form-field">
                            <label>Monthly Pay Amt</label>
                            <input readonly value="@auth.MonthlyPayAmt.ToString("C")" />
                        </div>
                        <div class="form-field">
                            <label>First Payment</label>
                            <input readonly value="@auth.FirstPayment.ToString("MM/dd/yyyy")" />
                        </div>
                        <div class="form-field">
                            <label>APR</label>
                            <input readonly value="@(auth.APR.ToString("F2") + "%")" />
                        </div>
                    </div>
                </div>

                <!-- Authorization History Grid -->
                <div class="history-section">
                    <div class="history-header">
                        <div class="history-tabs">
                            <button class="history-tab @(Params.HistoryView == "recap" ? "active" : "")"
                                    @onclick='() => SetHistoryView("recap")'>
                                Sales Authorization Recap
                            </button>
                            <button class="history-tab @(Params.HistoryView == "grid" ? "active" : "")"
                                    @onclick='() => SetHistoryView("grid")'>
                                Sales Authorizations
                            </button>
                        </div>
                        <div class="grid-controls">
                            <span class="status-badge status-@auth.Status.ToLower()">@auth.Status</span>
                            <div class="why-pmt-info">
                                <span class="label">Weekly Pmt</span>
                                <span class="value">@auth.WhyPmt</span>
                            </div>
                        </div>
                    </div>

                    @if (Params.HistoryView == "recap")
                    {
                        <!-- Items Grid -->
                        <TelerikGrid Data="@auth.Items"
                                     Pageable="false"
                                     Sortable="true"
                                     Height="300px">
                            <GridColumns>
                                <GridColumn Field="@nameof(SalesAuthItem.ItemId)" Title="Item ID" Width="150px" />
                                <GridColumn Field="@nameof(SalesAuthItem.Description)" Title="Description" />
                                <GridColumn Field="@nameof(SalesAuthItem.Qty)" Title="Qty" Width="100px" TextAlign="@ColumnTextAlign.Right" />
                                <GridColumn Field="@nameof(SalesAuthItem.Price)" Title="Price" Width="120px" TextAlign="@ColumnTextAlign.Right">
                                    <Template>
                                        @{
                                            var item = (SalesAuthItem)context;
                                            <span>@item.Price.ToString("C")</span>
                                        }
                                    </Template>
                                    <FooterTemplate>
                                        <strong>Total: @auth.Items.Sum(i => i.Price * i.Qty).ToString("C")</strong>
                                    </FooterTemplate>
                                </GridColumn>
                            </GridColumns>
                        </TelerikGrid>
                    }
                    else
                    {
                        <!-- Authorization History Grid -->
                        <TelerikGrid Data="@GetAuthorizationHistory(auth.CustomerId)"
                                     Pageable="true"
                                     PageSize="10"
                                     Sortable="true"
                                     Height="300px">
                            <GridColumns>
                                <GridColumn Field="@nameof(AuthorizationHistory.Date)" Title="Date" Width="130px" DisplayFormat="{0:MM/dd/yyyy}" />
                                <GridColumn Field="@nameof(AuthorizationHistory.Status)" Title="Status" Width="120px">
                                    <Template>
                                        @{
                                            var hist = (AuthorizationHistory)context;
                                            <span class="status-badge status-@hist.Status.ToLower()">@hist.Status</span>
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(AuthorizationHistory.IBNSalesAuthNumber)" Title="IBN Sales Auth #" Width="150px" />
                                <GridColumn Field="@nameof(AuthorizationHistory.SaleAmt)" Title="Sale Amt" Width="120px" TextAlign="@ColumnTextAlign.Right">
                                    <Template>
                                        @{
                                            var hist = (AuthorizationHistory)context;
                                            <span>@hist.SaleAmt.ToString("C")</span>
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(AuthorizationHistory.Rollover)" Title="Rollover" Width="120px" TextAlign="@ColumnTextAlign.Right">
                                    <Template>
                                        @{
                                            var hist = (AuthorizationHistory)context;
                                            <span>@hist.Rollover.ToString("C")</span>
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(AuthorizationHistory.Tax)" Title="Tax" Width="100px" TextAlign="@ColumnTextAlign.Right">
                                    <Template>
                                        @{
                                            var hist = (AuthorizationHistory)context;
                                            <span>@hist.Tax.ToString("C")</span>
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(AuthorizationHistory.Total)" Title="Total" Width="120px" TextAlign="@ColumnTextAlign.Right">
                                    <Template>
                                        @{
                                            var hist = (AuthorizationHistory)context;
                                            <span>@hist.Total.ToString("C")</span>
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(AuthorizationHistory.WhyPmt)" Title="Weekly Pmt" Width="100px" TextAlign="@ColumnTextAlign.Right" />
                            </GridColumns>
                        </TelerikGrid>
                    }
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Primary"
                                   OnClick="@PrintAuthorization">
                        Print
                    </TelerikButton>
                    <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Secondary"
                                   OnClick="@ReverseSale"
                                   Enabled="@(auth.Status == "Processed")">
                        Reverse Sale
                    </TelerikButton>
                </div>
            }
            else
            {
                <div class="detail-empty">
                    <p>Select a customer to view sales authorizations</p>
                </div>
            }
        </div>
    </section>
</div>

@code {
    // Centralized parameters
    private SalesAuthorizationsParameters Params = new();

    // ============================================================
    // Page contract & URL bindings
    // ============================================================
    protected override string BasePath => "/techcredit/salesauthorizations";

    protected override IReadOnlyDictionary<string, string?> Scalars => Params.ToScalars();

    protected override IReadOnlyCollection<string> MultiValues => Array.Empty<string>();

    protected override void ReadFromUrl()
    {
        var rawParams = SalesAuthorizationsParameters.FromUrl(Url);

        // Validate option parameter - must be a valid TechCredit option
        var validOptions = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "Customer Information",
            "Credit Application",
            "Sales Authorizations",
            "WCS",
            "Payments"
        };

        // If the option from URL is not a valid TechCredit option, use default for this page
        if (!validOptions.Contains(rawParams.Option))
        {
            rawParams.Option = "Sales Authorizations"; // Default for this page
        }

        Params = rawParams;

        if (string.IsNullOrEmpty(Params.SelectedCustomer))
        {
            Params.SelectedCustomer = FilteredCustomers.FirstOrDefault()?.CustomerId;
        }

        if (string.IsNullOrEmpty(Params.HistoryView))
        {
            Params.HistoryView = "recap";
        }
    }

    // ============================================================
    // Sidebar facets
    // ============================================================
    protected override IEnumerable<Facet> Facets()
    {
        yield return new Facet(
            Key: "option",
            Title: "Option",
            Options: () => new[]
            {
        new FacetOption("Customer Information", "Customer Information",
            Href: Url.BuildHref("/techcredit/customerinformation",
                new Dictionary<string, string?> { ["status"] = "All", ["customer"] = Params.SelectedCustomer })),

        new FacetOption("Credit Application", "Credit Application",
            Href: Url.BuildHref("/techcredit/creditapplication",
                new Dictionary<string, string?> { ["status"] = "All", ["customer"] = Params.SelectedCustomer })),

        new FacetOption("Sales Authorizations", "Sales Authorizations",
            Href: Url.BuildHref("/techcredit/salesauthorizations",
                new Dictionary<string, string?> { ["status"] = "All", ["customer"] = Params.SelectedCustomer })),

        new FacetOption("WCS", "WCS",
            Href: Url.BuildHref("/techcredit/wcs",
                new Dictionary<string, string?>())),

        new FacetOption("Payments", "Payments",
            Href: Url.BuildHref("/techcredit/payments",
                new Dictionary<string, string?> { ["view"] = "PastDue" }))
            }
        );

        yield return new Facet(
            Key: "status",
            Title: "Customer Status",
            Options: () => new[]
            {
                new FacetOption("All", "All"),
                new FacetOption("TC Borrowers", "TC Borrowers"),
                new FacetOption("TC Past Due", "TC Past Due")
            }
        );
    }

    // ============================================================
    // Lifecycle
    // ============================================================
    protected override void OnInitialized()
    {
        AllAuthorizations = SalesAuthorizationsSeedData.GetSalesAuthorizations();
        base.OnInitialized();
    }

    // ============================================================
    // Data & Filtering
    // ============================================================
    private List<SalesAuth> AllAuthorizations = new();

    private List<SalesAuth> FilteredCustomers
    {
        get
        {
            var auths = AllAuthorizations.AsEnumerable();

            auths = Params.CustomerStatus switch
            {
                "TC Borrowers" => auths.Where(a => a.IsTCBorrower),
                "TC Past Due" => auths.Where(a => a.IsPastDue),
                _ => auths
            };

            return auths.ToList();
        }
    }

    private SalesAuth? SelectedAuthorization =>
        FilteredCustomers.FirstOrDefault(a => a.CustomerId == Params.SelectedCustomer);

    private List<AuthorizationHistory> GetAuthorizationHistory(string customerId)
    {
        return SalesAuthorizationsSeedData.GetAuthorizationHistory(customerId);
    }

    // ============================================================
    // Actions
    // ============================================================
    private void SelectCustomer(string customerId)
    {
        Params.SelectedCustomer = customerId;
        NavigateWithPageState();
    }

    private void SetHistoryView(string view)
    {
        Params.HistoryView = view;
        NavigateWithPageState();
    }

    private void PrintAuthorization()
    {
        Console.WriteLine($"Print authorization for: {SelectedAuthorization?.CustomerName}");
    }

    private void ReverseSale()
    {
        Console.WriteLine($"Reverse sale for: {SelectedAuthorization?.CustomerName}");
    }
}
