@page "/techcredit/salesauthorizations"
@attribute [Authorize(Policy = AppPolicies.TechCredit)]

@using Microsoft.AspNetCore.WebUtilities
@using Prototype.Components.Layout.Navigation.Sidebar
@using Prototype.Components.Pages.Collections.SalesAuthorizations
@using Prototype.Components.SharedComponents
@using Prototype.Pages.Collections
@using Telerik.Blazor
@using Telerik.Blazor.Components
@using static Prototype.Components.Pages.Collections.SalesAuthorizations.SalesAuthorizationsSeedData

@inherits PageWithSidebarBase

@inject IJSRuntime JS

<div class="wrap">
    <header class="header">
        <h3 class="title">Sales Authorizations</h3>
    </header>

    <section class="card sales-auth-layout">
        <!-- Use shared customer list component -->
        <TechCreditCustomerList TCustomer="SalesAuth"
                                Customers="@FilteredCustomers"
                                SelectedCustomerId="@Params.SelectedCustomer"
                                GetCustomerId="@(c => c.CustomerId)"
                                GetCustomerName="@(c => c.CustomerName)"
                                OnCustomerSelected="@SelectCustomer" />

        <div class="detail-panel">
            @if (SelectedAuthorization != null)
            {
                var auth = SelectedAuthorization;

                <!-- Customer Header -->
                <div class="customer-header">
                    <div class="header-field">
                        <label>Phone</label>
                        <input readonly value="@auth.Phone" />
                    </div>
                    <div class="header-field">
                        <label>Customer Profile</label>
                        <input readonly value="@auth.CustomerProfile" />
                    </div>
                    <div class="header-field">
                        <label>Borrower ID</label>
                        <input readonly value="@auth.CustomerId" />
                    </div>
                </div>

                <!-- Sales Authorization Recap -->
                <div class="recap-section">
                    <div class="recap-header">
                        <h4>Sales Authorization Recap</h4>
                    </div>

                    <div class="recap-layout">
                        <!-- Blue Ribbon Sale Column -->
                        <div class="blue-ribbon-column">
                            <div class="section-title">Blue Ribbon Sale</div>

                            <div class="form-field">
                                <label>A1. This Sale</label>
                                <input readonly value="@auth.ThisSale.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>A2. Rollover Amount</label>
                                <input readonly value="@auth.RolloverAmount.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>B. Less Trade In</label>
                                <input readonly value="@auth.LessTradeIn.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>C. Sales Tax</label>
                                <input readonly value="@auth.SalesTax.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>E. Admin Fee</label>
                                <input readonly value="@auth.AdminFee.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>F. Previous Balance</label>
                                <input readonly value="@auth.PreviousBalance.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>G. New CTC Balance</label>
                                <input readonly value="@auth.NewCTCBalance.ToString("C")" class="highlight-field" />
                            </div>
                        </div>

                        <!-- Auth Details Column -->
                        <div class="auth-details-column">
                            <div class="form-field">
                                <label>IBN Sales Auth #</label>
                                <input readonly value="@auth.IBNSalesAuthNumber" />
                            </div>

                            <div class="form-field">
                                <label>Date</label>
                                <input readonly value="@auth.IBNDate.ToString("MM/dd/yyyy")" />
                            </div>

                            <div class="spacer"></div>

                            <div class="form-field">
                                <label>CQT Sales Auth #</label>
                                <input readonly value="@auth.CQTSalesAuthNumber" />
                            </div>

                            <div class="form-field">
                                <label>D. Net Sale</label>
                                <input readonly value="@auth.NetSale.ToString("C")" />
                            </div>

                            <div class="form-field">
                                <label>Date</label>
                                <input readonly value="@auth.CQTDate.ToString("MM/dd/yyyy")" />
                            </div>
                        </div>
                    </div>

                    <!-- Payment Details Row -->
                    <div class="payment-details">
                        <div class="form-field">
                            <label>Weekly Pay Amt</label>
                            <input readonly value="@auth.WeeklyPayAmt.ToString("C")" />
                        </div>
                        <div class="form-field">
                            <label>Monthly Pay Amt</label>
                            <input readonly value="@auth.MonthlyPayAmt.ToString("C")" />
                        </div>
                        <div class="form-field">
                            <label>First Payment</label>
                            <input readonly value="@auth.FirstPayment.ToString("MM/dd/yyyy")" />
                        </div>
                        <div class="form-field">
                            <label>APR</label>
                            <input readonly value="@(auth.APR.ToString("F2") + "%")" />
                        </div>
                    </div>
                </div>

                <!-- Authorization History Grid -->
                <div class="history-section">
                    <div class="history-header">
                        <div class="history-tabs">
                            <button class="history-tab @(Params.HistoryView == "recap" ? "active" : "")"
                                    @onclick='() => SetHistoryView("recap")'>
                                Sales Authorization Recap
                            </button>
                            <button class="history-tab @(Params.HistoryView == "grid" ? "active" : "")"
                                    @onclick='() => SetHistoryView("grid")'>
                                Sales Authorizations
                            </button>
                        </div>
                        <div class="grid-controls">
                            <span class="status-badge status-@auth.Status.ToLower()">@auth.Status</span>
                            <div class="why-pmt-info">
                                <span class="label">Weekly Pmt</span>
                                <span class="value">@auth.WhyPmt</span>
                            </div>
                        </div>
                    </div>

                    @if (Params.HistoryView == "recap")
                    {
                        <!-- Items Grid -->
                        <TelerikGrid Data="@auth.Items"
                                     Pageable="false"
                                     Sortable="true"
                                     Height="300px">
                            <GridColumns>
                                <GridColumn Field="@nameof(SalesAuthItem.ItemId)" Title="Item ID" Width="150px" />
                                <GridColumn Field="@nameof(SalesAuthItem.Description)" Title="Description" />
                                <GridColumn Field="@nameof(SalesAuthItem.Qty)" Title="Qty" Width="100px" TextAlign="@ColumnTextAlign.Right" />
                                <GridColumn Field="@nameof(SalesAuthItem.Price)" Title="Price" Width="120px" TextAlign="@ColumnTextAlign.Right">
                                    <Template>
                                        @{
                                            var item = (SalesAuthItem)context;
                                            <span>@item.Price.ToString("C")</span>
                                        }
                                    </Template>
                                    <FooterTemplate>
                                        <strong>Total: @auth.Items.Sum(i => i.Price * i.Qty).ToString("C")</strong>
                                    </FooterTemplate>
                                </GridColumn>
                            </GridColumns>
                        </TelerikGrid>
                    }
                    else
                    {
                        <!-- Authorization History Grid -->
                        <TelerikGrid Data="@GetAuthorizationHistory(auth.CustomerId)"
                                     Pageable="true"
                                     PageSize="10"
                                     Sortable="true"
                                     Height="300px">
                            <GridColumns>
                                <GridColumn Field="@nameof(AuthorizationHistory.Date)" Title="Date" Width="130px" DisplayFormat="{0:MM/dd/yyyy}" />
                                <GridColumn Field="@nameof(AuthorizationHistory.Status)" Title="Status" Width="120px">
                                    <Template>
                                        @{
                                            var hist = (AuthorizationHistory)context;
                                            <span class="status-badge status-@hist.Status.ToLower()">@hist.Status</span>
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(AuthorizationHistory.IBNSalesAuthNumber)" Title="IBN Sales Auth #" Width="150px" />
                                <GridColumn Field="@nameof(AuthorizationHistory.SaleAmt)" Title="Sale Amt" Width="120px" TextAlign="@ColumnTextAlign.Right">
                                    <Template>
                                        @{
                                            var hist = (AuthorizationHistory)context;
                                            <span>@hist.SaleAmt.ToString("C")</span>
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(AuthorizationHistory.Rollover)" Title="Rollover" Width="120px" TextAlign="@ColumnTextAlign.Right">
                                    <Template>
                                        @{
                                            var hist = (AuthorizationHistory)context;
                                            <span>@hist.Rollover.ToString("C")</span>
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(AuthorizationHistory.Tax)" Title="Tax" Width="100px" TextAlign="@ColumnTextAlign.Right">
                                    <Template>
                                        @{
                                            var hist = (AuthorizationHistory)context;
                                            <span>@hist.Tax.ToString("C")</span>
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(AuthorizationHistory.Total)" Title="Total" Width="120px" TextAlign="@ColumnTextAlign.Right">
                                    <Template>
                                        @{
                                            var hist = (AuthorizationHistory)context;
                                            <span>@hist.Total.ToString("C")</span>
                                        }
                                    </Template>
                                </GridColumn>
                                <GridColumn Field="@nameof(AuthorizationHistory.WhyPmt)" Title="Weekly Pmt" Width="100px" TextAlign="@ColumnTextAlign.Right" />
                            </GridColumns>
                        </TelerikGrid>
                    }
                </div>

                <!-- Action Buttons -->
                <div class="form-actions">
                    <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Primary"
                                   OnClick="@PrintAuthorization">
                        Print
                    </TelerikButton>
                    <TelerikButton ThemeColor="@ThemeConstants.Button.ThemeColor.Secondary"
                                   OnClick="@ReverseSale"
                                   Enabled="@(auth.Status == "Processed")">
                        Reverse Sale
                    </TelerikButton>
                </div>
            }
            else
            {
                <div class="detail-empty">
                    <p>Select a customer to view sales authorizations</p>
                </div>
            }
        </div>
    </section>
</div>

@code {
    // Centralized parameters
    private SalesAuthorizationsParameters Params = new();

    // ============================================================
    // Page contract & URL bindings
    // ============================================================
    protected override string BasePath => "/techcredit/salesauthorizations";

    protected override IReadOnlyDictionary<string, string?> Scalars => Params.ToScalars();

    protected override IReadOnlyCollection<string> MultiValues => Array.Empty<string>();

    protected override void ReadFromUrl()
    {
        var rawParams = SalesAuthorizationsParameters.FromUrl(Url);

        // Validate option parameter - must be a valid TechCredit option
        var validOptions = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "Customer Information",
            "Credit Application",
            "Sales Authorizations",
            "WCS",
            "Payments"
        };

        // If the option from URL is not a valid TechCredit option, use default for this page
        if (!validOptions.Contains(rawParams.Option))
        {
            rawParams.Option = "Sales Authorizations"; // Default for this page
        }

        Params = rawParams;

        if (string.IsNullOrEmpty(Params.SelectedCustomer))
        {
            Params.SelectedCustomer = FilteredCustomers.FirstOrDefault()?.CustomerId;
        }

        if (string.IsNullOrEmpty(Params.HistoryView))
        {
            Params.HistoryView = "recap";
        }
    }

    // ============================================================
    // Sidebar facets
    // ============================================================
    protected override IEnumerable<Facet> Facets()
    {
        yield return new Facet(
            Key: "option",
            Title: "Option",
            Options: () => new[]
            {
        new FacetOption("Customer Information", "Customer Information",
            Href: Url.BuildHref("/techcredit/customerinformation",
                new Dictionary<string, string?> { ["status"] = "All", ["customer"] = Params.SelectedCustomer })),

        new FacetOption("Credit Application", "Credit Application",
            Href: Url.BuildHref("/techcredit/creditapplication",
                new Dictionary<string, string?> { ["status"] = "All", ["customer"] = Params.SelectedCustomer })),

        new FacetOption("Sales Authorizations", "Sales Authorizations",
            Href: Url.BuildHref("/techcredit/salesauthorizations",
                new Dictionary<string, string?> { ["status"] = "All", ["customer"] = Params.SelectedCustomer })),

        new FacetOption("WCS", "WCS",
            Href: Url.BuildHref("/techcredit/wcs",
                new Dictionary<string, string?>())),

        new FacetOption("Payments", "Payments",
            Href: Url.BuildHref("/techcredit/payments",
                new Dictionary<string, string?> { ["view"] = "PastDue" }))
            }
        );

        yield return new Facet(
            Key: "status",
            Title: "Customer Status",
            Options: () => new[]
            {
                new FacetOption("All", "All"),
                new FacetOption("TC Borrowers", "TC Borrowers"),
                new FacetOption("TC Past Due", "TC Past Due")
            }
        );
    }

    // ============================================================
    // Lifecycle
    // ============================================================
    protected override void OnInitialized()
    {
        AllAuthorizations = SalesAuthorizationsSeedData.GetSalesAuthorizations();
        base.OnInitialized();
    }

    // ============================================================
    // Data & Filtering
    // ============================================================
    private List<SalesAuth> AllAuthorizations = new();

    private List<SalesAuth> FilteredCustomers
    {
        get
        {
            var auths = AllAuthorizations.AsEnumerable();

            auths = Params.CustomerStatus switch
            {
                "TC Borrowers" => auths.Where(a => a.IsTCBorrower),
                "TC Past Due" => auths.Where(a => a.IsPastDue),
                _ => auths
            };

            return auths.ToList();
        }
    }

    private SalesAuth? SelectedAuthorization =>
        FilteredCustomers.FirstOrDefault(a => a.CustomerId == Params.SelectedCustomer);

    private List<AuthorizationHistory> GetAuthorizationHistory(string customerId)
    {
        return SalesAuthorizationsSeedData.GetAuthorizationHistory(customerId);
    }

    // ============================================================
    // Actions
    // ============================================================
    private void SelectCustomer(string customerId)
    {
        Params.SelectedCustomer = customerId;
        NavigateWithPageState();
    }

    private void SetHistoryView(string view)
    {
        Params.HistoryView = view;
        NavigateWithPageState();
    }

    private void PrintAuthorization()
    {
        Console.WriteLine($"Print authorization for: {SelectedAuthorization?.CustomerName}");
    }

    private void ReverseSale()
    {
        Console.WriteLine($"Reverse sale for: {SelectedAuthorization?.CustomerName}");
    }
}

<style>
    /* SalesAuthorizations.razor.css */
    /* Integrated with global appearance system - uses CSS variables from appearance-manager.js */

    /* ============================================================
       MAIN LAYOUT
       ============================================================ */
    .sales-auth-layout {
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 0;
        min-height: 600px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg, 12px);
        overflow: hidden;
        transition: background-color var(--transition-normal, 150ms) ease, border-color var(--transition-normal, 150ms) ease;
    }

    /* ============================================================
       DETAIL PANEL
       ============================================================ */
    .detail-panel {
        padding: var(--spacing-6, 1.5rem);
        overflow-y: auto;
        max-height: calc(100vh - 200px);
        background: var(--card-bg);
        transition: background-color var(--transition-normal, 150ms) ease;
    }

    .detail-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 400px;
        color: var(--muted);
        font-size: 1.1rem;
        font-family: var(--base-font-family, inherit);
    }

        .detail-empty p {
            margin: 0;
            padding: var(--spacing-4, 1rem);
            background: var(--hover-bg);
            border-radius: var(--radius-md, 8px);
            border: 1px dashed var(--border);
        }

    /* ============================================================
       CUSTOMER HEADER
       ============================================================ */
    .customer-header {
        display: flex;
        gap: var(--spacing-4, 1rem);
        padding: var(--spacing-4, 1rem);
        background: var(--hover-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg, 8px);
        margin-bottom: var(--spacing-6, 1.5rem);
        transition: background-color var(--transition-normal, 150ms) ease, border-color var(--transition-normal, 150ms) ease;
    }

    .header-field {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-1, 0.25rem);
    }

        .header-field label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: var(--base-font-family, inherit);
            transition: color var(--transition-normal, 150ms) ease;
        }

        .header-field input {
            padding: var(--spacing-2, 0.5rem);
            border: 1px solid var(--border);
            border-radius: var(--radius-md, 4px);
            font-size: var(--base-font-size, 0.875rem);
            font-family: var(--base-font-family, inherit);
            background: var(--card-bg);
            color: var(--text);
            transition: background-color var(--transition-normal, 150ms) ease, border-color var(--transition-normal, 150ms) ease, color var(--transition-normal, 150ms) ease;
        }

            .header-field input:read-only {
                background: var(--hover-bg);
                cursor: default;
            }

    /* ============================================================
       RECAP SECTION
       ============================================================ */
    .recap-section {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg, 8px);
        margin-bottom: var(--spacing-6, 1.5rem);
        overflow: hidden;
        transition: background-color var(--transition-normal, 150ms) ease, border-color var(--transition-normal, 150ms) ease;
    }

    .recap-header {
        background: var(--hover-bg);
        padding: var(--spacing-3, 0.75rem) var(--spacing-6, 1.5rem);
        border-bottom: 1px solid var(--border);
        transition: background-color var(--transition-normal, 150ms) ease, border-color var(--transition-normal, 150ms) ease;
    }

        .recap-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            font-family: var(--base-font-family, inherit);
            display: flex;
            align-items: center;
            gap: var(--spacing-2, 0.5rem);
            transition: color var(--transition-normal, 150ms) ease;
        }

            .recap-header h4::before {
                content: '';
                display: inline-block;
                width: 4px;
                height: 1em;
                background: var(--accent);
                border-radius: var(--radius-xs, 2px);
            }

    .recap-layout {
        background: var(--hover-bg);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-8, 2rem);
        padding: var(--spacing-6, 1.5rem);
        transition: background-color var(--transition-normal, 150ms) ease;
    }

    .section-title {
        font-weight: 600;
        color: var(--accent);
        margin-bottom: var(--spacing-4, 1rem);
        font-size: 0.95rem;
        font-family: var(--base-font-family, inherit);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: color var(--transition-normal, 150ms) ease;
    }

    /* ============================================================
       COLUMN LAYOUTS
       ============================================================ */
    .blue-ribbon-column,
    .auth-details-column {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-3, 0.75rem);
    }

    .blue-ribbon-column {
        padding: var(--spacing-4, 1rem);
        background: var(--accent-weak);
        border-radius: var(--radius-md, 8px);
        border: 1px solid var(--accent);
        border-left-width: 4px;
        transition: background-color var(--transition-normal, 150ms) ease, border-color var(--transition-normal, 150ms) ease;
    }

    /* ============================================================
       FORM FIELDS
       ============================================================ */
    .form-field {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-1, 0.25rem);
    }

        .form-field label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text);
            font-family: var(--base-font-family, inherit);
            transition: color var(--transition-normal, 150ms) ease;
        }

        .form-field input {
            color: var(--text);
            padding: var(--spacing-2, 0.5rem);
            border: 1px solid var(--border);
            border-radius: var(--radius-md, 4px);
            font-size: var(--base-font-size, 0.875rem);
            font-family: var(--base-font-family, inherit);
            background: var(--card-bg);
            transition: background-color var(--transition-normal, 150ms) ease, border-color var(--transition-normal, 150ms) ease, color var(--transition-normal, 150ms) ease, box-shadow var(--transition-fast, 100ms) ease;
        }

            .form-field input:focus {
                outline: none;
                border-color: var(--accent);
                box-shadow: 0 0 0 3px rgba(var(--accent-rgb, 12, 94, 168), 0.15);
            }

            .form-field input:read-only {
                cursor: default;
                background: transparent;
            }

                .form-field input:read-only:focus {
                    box-shadow: none;
                    border-color: var(--border);
                }

            .form-field input.highlight-field {
                background: var(--accent) !important;
                color: white !important;
                font-weight: 600;
                border-color: var(--accent-hover);
            }

    .spacer {
        height: var(--spacing-4, 1rem);
    }

    /* ============================================================
       PAYMENT DETAILS
       ============================================================ */
    .payment-details {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--spacing-4, 1rem);
        padding: var(--spacing-4, 1rem) var(--spacing-6, 1.5rem) var(--spacing-6, 1.5rem) var(--spacing-6, 1.5rem);
        background: var(--hover-bg);
        border-top: 1px solid var(--border);
        transition: background-color var(--transition-normal, 150ms) ease, border-color var(--transition-normal, 150ms) ease;
    }

        .payment-details .form-field {
            padding: var(--spacing-3, 0.75rem);
            background: var(--card-bg);
            border-radius: var(--radius-md, 6px);
            border: 1px solid var(--border);
            transition: background-color var(--transition-normal, 150ms) ease, border-color var(--transition-normal, 150ms) ease;
        }

            .payment-details .form-field:hover {
                border-color: var(--accent);
            }

    /* ============================================================
       HISTORY SECTION
       ============================================================ */
    .history-section {
        background: var(--hover-bg);
        border-radius: var(--radius-lg, 8px);
        margin-bottom: var(--spacing-6, 1.5rem);
        overflow: hidden;
        border: 1px solid var(--border);
        transition: background-color var(--transition-normal, 150ms) ease, border-color var(--transition-normal, 150ms) ease;
    }

    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-3, 0.75rem) var(--spacing-4, 1rem);
        background: var(--hover-bg);
        border-bottom: 1px solid var(--border);
        transition: background-color var(--transition-normal, 150ms) ease, border-color var(--transition-normal, 150ms) ease;
    }

    .history-tabs {
        display: flex;
        gap: var(--spacing-2, 0.5rem);
    }

    .history-tab {
        padding: var(--spacing-2, 0.5rem) var(--spacing-4, 1rem);
        border: 1px solid var(--border);
        background: var(--card-bg);
        color: var(--text);
        border-radius: var(--radius-md, 4px);
        cursor: pointer;
        font-size: var(--base-font-size, 0.875rem);
        font-family: var(--base-font-family, inherit);
        font-weight: 500;
        transition: all var(--transition-fast, 150ms) ease;
    }

        .history-tab:hover {
            background: var(--hover-bg);
            border-color: var(--border-strong);
        }

        .history-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            font-weight: 600;
        }

            .history-tab.active:hover {
                background: var(--accent-hover);
                border-color: var(--accent-hover);
            }

    .grid-controls {
        display: flex;
        align-items: center;
        gap: var(--spacing-4, 1rem);
    }

    /* ============================================================
       STATUS BADGES
       ============================================================ */
    .status-badge {
        padding: var(--spacing-1, 0.25rem) var(--spacing-3, 0.75rem);
        border-radius: var(--radius-full, 9999px);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-family: var(--base-font-family, inherit);
        transition: background-color var(--transition-normal, 150ms) ease, color var(--transition-normal, 150ms) ease;
    }

    .status-processed {
        background: color-mix(in srgb, var(--kendo-color-success, #22c55e) 15%, var(--card-bg));
        color: var(--kendo-color-success, #155724);
        border: 1px solid var(--kendo-color-success, #22c55e);
    }

    .status-pending {
        background: color-mix(in srgb, var(--kendo-color-warning, #f59e0b) 15%, var(--card-bg));
        color: var(--kendo-color-warning, #856404);
        border: 1px solid var(--kendo-color-warning, #f59e0b);
    }

    .status-reversed {
        background: color-mix(in srgb, var(--kendo-color-error, #ef4444) 15%, var(--card-bg));
        color: var(--kendo-color-error, #721c24);
        border: 1px solid var(--kendo-color-error, #ef4444);
    }

    /* ============================================================
       WHY PMT INFO
       ============================================================ */
    .why-pmt-info {
        display: flex;
        align-items: center;
        gap: var(--spacing-2, 0.5rem);
        padding: var(--spacing-1, 0.25rem) var(--spacing-3, 0.75rem);
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-md, 4px);
        transition: background-color var(--transition-normal, 150ms) ease, border-color var(--transition-normal, 150ms) ease;
    }

        .why-pmt-info .label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--muted);
            font-family: var(--base-font-family, inherit);
        }

        .why-pmt-info .value {
            font-size: var(--base-font-size, 0.875rem);
            font-weight: 600;
            color: var(--text);
            font-family: var(--base-font-family, inherit);
        }

    /* ============================================================
       FORM ACTIONS
       ============================================================ */
    .form-actions {
        display: flex;
        gap: var(--spacing-4, 1rem);
        padding-top: var(--spacing-6, 1.5rem);
        border-top: 1px solid var(--border);
        transition: border-color var(--transition-normal, 150ms) ease;
    }

    /* ============================================================
       GENERAL BADGES
       ============================================================ */
    .badge {
        padding: var(--spacing-1, 0.25rem) var(--spacing-2, 0.5rem);
        border-radius: var(--radius-md, 4px);
        font-size: 0.75rem;
        font-weight: 600;
        font-family: var(--base-font-family, inherit);
    }

    .badge-info {
        background: color-mix(in srgb, var(--kendo-color-info, #3b82f6) 15%, var(--card-bg));
        color: var(--kendo-color-info, #0c5460);
        border: 1px solid var(--kendo-color-info, #3b82f6);
    }

    .badge-warning {
        background: color-mix(in srgb, var(--kendo-color-warning, #f59e0b) 15%, var(--card-bg));
        color: var(--kendo-color-warning, #856404);
        border: 1px solid var(--kendo-color-warning, #f59e0b);
    }

    .badge-success {
        background: color-mix(in srgb, var(--kendo-color-success, #22c55e) 15%, var(--card-bg));
        color: var(--kendo-color-success, #155724);
        border: 1px solid var(--kendo-color-success, #22c55e);
    }

    .badge-danger {
        background: color-mix(in srgb, var(--kendo-color-error, #ef4444) 15%, var(--card-bg));
        color: var(--kendo-color-error, #721c24);
        border: 1px solid var(--kendo-color-error, #ef4444);
    }

    /* ============================================================
       HEADER STYLING
       ============================================================ */
    .wrap > .header {
        margin-bottom: var(--spacing-4, 1rem);
        padding-bottom: var(--spacing-3, 0.75rem);
        border-bottom: 2px solid var(--border);
        transition: border-color var(--transition-normal, 150ms) ease;
    }

        .wrap > .header .title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            font-family: var(--base-font-family, inherit);
            transition: color var(--transition-normal, 150ms) ease;
        }

    /* ============================================================
       DENSITY ADJUSTMENTS
       ============================================================ */
    [data-density="compact"] .detail-panel {
        padding: var(--spacing-4, 1rem);
    }

    [data-density="compact"] .customer-header {
        padding: var(--spacing-3, 0.75rem);
        gap: var(--spacing-3, 0.75rem);
    }

    [data-density="compact"] .recap-layout {
        padding: var(--spacing-4, 1rem);
        gap: var(--spacing-4, 1rem);
    }

    [data-density="compact"] .blue-ribbon-column,
    [data-density="compact"] .auth-details-column {
        gap: var(--spacing-2, 0.5rem);
    }

    [data-density="compact"] .form-field input {
        padding: var(--spacing-1, 0.25rem) var(--spacing-2, 0.5rem);
        font-size: 0.8rem;
    }

    [data-density="compact"] .form-field label {
        font-size: 0.7rem;
    }

    [data-density="compact"] .payment-details {
        gap: var(--spacing-2, 0.5rem);
        padding: var(--spacing-3, 0.75rem);
    }

    [data-density="compact"] .history-tab {
        padding: var(--spacing-1, 0.25rem) var(--spacing-3, 0.75rem);
        font-size: 0.8rem;
    }

    [data-density="spacious"] .detail-panel {
        padding: var(--spacing-8, 2rem);
    }

    [data-density="spacious"] .customer-header {
        padding: var(--spacing-5, 1.25rem);
        gap: var(--spacing-5, 1.25rem);
    }

    [data-density="spacious"] .recap-layout {
        padding: var(--spacing-8, 2rem);
        gap: var(--spacing-10, 2.5rem);
    }

    [data-density="spacious"] .blue-ribbon-column,
    [data-density="spacious"] .auth-details-column {
        gap: var(--spacing-4, 1rem);
    }

    [data-density="spacious"] .form-field input {
        padding: var(--spacing-3, 0.75rem) var(--spacing-4, 1rem);
        font-size: 1rem;
    }

    [data-density="spacious"] .form-field label {
        font-size: 0.85rem;
        margin-bottom: var(--spacing-1, 0.25rem);
    }

    [data-density="spacious"] .payment-details {
        gap: var(--spacing-5, 1.25rem);
        padding: var(--spacing-5, 1.25rem) var(--spacing-8, 2rem);
    }

    [data-density="spacious"] .history-tab {
        padding: var(--spacing-3, 0.75rem) var(--spacing-5, 1.25rem);
    }

    /* ============================================================
       BORDER RADIUS ADJUSTMENTS
       ============================================================ */
    [data-radius="none"] .sales-auth-layout,
    [data-radius="none"] .customer-header,
    [data-radius="none"] .recap-section,
    [data-radius="none"] .history-section,
    [data-radius="none"] .form-field input,
    [data-radius="none"] .history-tab,
    [data-radius="none"] .status-badge {
        border-radius: 0;
    }

    [data-radius="pill"] .status-badge {
        border-radius: 9999px;
    }

    [data-radius="pill"] .history-tab {
        border-radius: 9999px;
    }

    [data-radius="rounded"] .sales-auth-layout {
        border-radius: 16px;
    }

    [data-radius="rounded"] .customer-header,
    [data-radius="rounded"] .recap-section,
    [data-radius="rounded"] .history-section {
        border-radius: 12px;
    }

    [data-radius="rounded"] .form-field input {
        border-radius: 8px;
    }

    /* ============================================================
       HIGH CONTRAST MODE ADJUSTMENTS
       ============================================================ */
    .high-contrast .customer-header,
    .high-contrast .recap-section,
    .high-contrast .history-section {
        border-width: 2px;
    }

    .high-contrast .form-field input {
        border-width: 2px;
    }

    .high-contrast .blue-ribbon-column {
        border-width: 2px;
        border-left-width: 6px;
    }

    .high-contrast .history-tab {
        border-width: 2px;
    }

    .high-contrast .status-badge {
        border-width: 2px;
    }

    .high-contrast .status-processed {
        background: #d4edda;
        color: #000000;
    }

    .high-contrast .status-pending {
        background: #ffff00;
        color: #000000;
    }

    .high-contrast .status-reversed {
        background: #f8d7da;
        color: #000000;
    }

    /* ============================================================
       REDUCED MOTION
       ============================================================ */
    .reduce-motion .sales-auth-layout,
    .reduce-motion .customer-header,
    .reduce-motion .recap-section,
    .reduce-motion .history-section,
    .reduce-motion .form-field input,
    .reduce-motion .history-tab,
    .reduce-motion .detail-panel {
        transition: none !important;
    }

    /* ============================================================
       NO ANIMATIONS
       ============================================================ */
    .no-animations .sales-auth-layout,
    .no-animations .customer-header,
    .no-animations .recap-section,
    .no-animations .history-section,
    .no-animations .form-field input,
    .no-animations .history-tab,
    .no-animations .detail-panel {
        transition: none !important;
        animation: none !important;
    }

    /* ============================================================
       FOCUS INDICATORS (Enhanced Accessibility)
       ============================================================ */
    .enhanced-focus .form-field input:focus-visible {
        outline: 3px solid var(--accent);
        outline-offset: 2px;
    }

    .enhanced-focus .history-tab:focus-visible {
        outline: 3px solid var(--accent);
        outline-offset: 2px;
    }

    .enhanced-focus .recap-section:focus-within {
        box-shadow: 0 0 0 3px rgba(var(--accent-rgb, 12, 94, 168), 0.2);
    }

    /* ============================================================
       RESPONSIVE BREAKPOINTS
       ============================================================ */
    @@media (max-width: 1200px) {
        .sales-auth-layout {
            grid-template-columns: 1fr;
        }

        .detail-panel {
            max-height: none;
        }

        .recap-layout {
            grid-template-columns: 1fr;
        }

        .payment-details {
            grid-template-columns: repeat(2, 1fr);
        }

        .history-header {
            flex-direction: column;
            gap: var(--spacing-3, 0.75rem);
            align-items: flex-start;
        }

        .grid-controls {
            width: 100%;
            justify-content: space-between;
        }
    }

    @@media (max-width: 768px) {
        .detail-panel {
            padding: var(--spacing-4, 1rem);
        }

        .customer-header {
            flex-direction: column;
        }

        .payment-details {
            grid-template-columns: 1fr;
        }

        .history-tabs {
            flex-wrap: wrap;
        }

        .form-actions {
            flex-direction: column;
        }

            .form-actions .k-button {
                width: 100%;
            }
    }

    @@media (max-width: 480px) {
        .detail-panel {
            padding: var(--spacing-3, 0.75rem);
        }

        .customer-header {
            padding: var(--spacing-3, 0.75rem);
        }

        .recap-layout {
            padding: var(--spacing-3, 0.75rem);
        }

        .blue-ribbon-column {
            padding: var(--spacing-3, 0.75rem);
        }

        .history-tab {
            font-size: 0.8rem;
            padding: var(--spacing-2, 0.5rem) var(--spacing-3, 0.75rem);
        }
    }

    /* ============================================================
       PRINT STYLES
       ============================================================ */
    @@media print {
        .sales-auth-layout {
            display: block;
            border: none;
            box-shadow: none;
        }

        .detail-panel {
            max-height: none;
            padding: 0;
        }

        .customer-header {
            border: 1px solid #ccc;
            background: white;
        }

        .recap-section,
        .history-section {
            break-inside: avoid;
            border: 1px solid #ccc;
            background: white;
        }

        .form-field input {
            border: none;
            padding: 0;
            background: transparent;
        }

        .form-actions {
            display: none;
        }

        .history-tabs {
            display: none;
        }

        .status-processed {
            background: #d4edda !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .status-pending {
            background: #fff3cd !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .status-reversed {
            background: #f8d7da !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }
</style>