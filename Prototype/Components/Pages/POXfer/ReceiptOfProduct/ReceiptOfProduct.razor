@page "/po-transfer/receipt-of-product"
@attribute [Authorize(Policy = AppPolicies.CustomerService)]

@using System.Globalization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.WebUtilities
@using Prototype.Components.Layout
@using Prototype.Components.Layout.Navigation
@using Prototype.Components.Layout.Navigation.Sidebar
@using Prototype.Components.Pages.POXfer.ReceiptOfProduct
@using Prototype.Components.Pages.Product.Webcat
@using Prototype.Components.Services
@using Prototype.Components.SharedComponents.Sidepanel
@using Prototype.Pages.POTransfer
@using Telerik.Blazor
@using Telerik.Blazor.Components
@using static Prototype.Components.Pages.POXfer.ReceiptOfProduct.ReceiptOfProductSeedData
@using static Prototype.Pages.POTransfer.ReceiptOfProductParameters

@inherits PageWithSidebarBase
@inject SidePanelService SidePanelService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<div class="wrap">
    <header class="header">
        <h3 class="title">Receipt of Product</h3>

        <div class="rop-meta card table-wrap">
            <div class="field span-2">
                <label>ASN#:</label>
                <input readonly class="rop-asn" value="@SelectedAsnDisplay" />
            </div>

            <div class="field inline">
                <label>Print Needs Only:</label>
                <input type="checkbox" class="rop-pno" @bind="PrintNeedsOnly" />
            </div>

            <div class="field">
                <label>Total:</label>
                <input readonly class="rop-total" value="@SelectedAsnTotal.ToString("C")" />
            </div>

            <div class="field">
                <label>Received:</label>
                <input class="rop-received" type="number" step="0.01" inputmode="decimal"
                       @bind-value="ReceivedAmount" @bind-value:event="onchange" />
            </div>

            <div class="field">
                <label>Tracking#:</label>
                <input class="rop-tracking" @bind="TrackingNumber" />
            </div>

            <div class="field">
                <label>Carrier:</label>
                <select class="rop-carrier" @bind="SelectedCarrier">
                    @foreach (var c in Carriers)
                    {
                        <option value="@c">@c</option>
                    }
                </select>
            </div>

            <div class="field inline narrow align-end">
                <button class="btn"
                        @onclick="TrackPackageAsync"
                        disabled="@string.IsNullOrWhiteSpace(TrackingNumber)">
                    Track
                </button>
            </div>

            <div class="field">
                <label>Ship From:</label>
                <input readonly class="rop-shipfrom" value="@SelectedAsnShipFrom" />
            </div>

            <div class="field">
                <label>Ship Date:</label>
                <input readonly class="rop-shipdate" value="@SelectedAsnShipDate?.ToString("MM/dd/yyyy")" />
            </div>
        </div>
    </header>

    <section class="card rop-card">
        <header class="section-header panel" style="display: flex; align-items: center; padding: 1rem;">
            <h4 style="margin: 0;">Shipping Notifications</h4>
            <span class="badge" style="margin-left:auto;">Label Count: @LabelCountTotal</span>
        </header>

        <TelerikGrid Data="@CurrentLines"
                     SelectionMode="@GridSelectionMode.Multiple"
                     @bind-SelectedItems="@SelectedLinesCollection"
                     Pageable="true"
                     PageSize="20"
                     Sortable="true"
                     FilterMode="@GridFilterMode.FilterRow"
                     Resizable="true"
                     Reorderable="true"
                     Groupable="true"
                     ShowColumnMenu="true"
                     OnUpdate="@UpdateHandler"
                     EditMode="@GridEditMode.Incell">
            <GridToolBarTemplate>
                <GridCommandButton Command="ExcelExport" Icon="@SvgIcon.FileExcel">Export to Excel</GridCommandButton>
                <GridSearchBox />
                <span style="margin-left: auto; font-weight: bold;">
                    Total Lines: @CurrentLines.Count | Selected: @SelectedLineItems.Count
                </span>
            </GridToolBarTemplate>
            <GridExport>
                <GridExcelExport FileName="asn-lines" AllPages="true" />
                <GridCsvExport FileName="asn-lines" AllPages="true" />
            </GridExport>
            <GridColumns>
                <GridCheckboxColumn SelectAll="true" Width="60px" Locked="true" />
                <GridColumn Field="@nameof(AsnLine.Item)" Title="Item" Width="140px" Locked="true">
                    <Template>
                        @{
                            var row = (AsnLine)context;
                            <button class="link-button" @onclick="() => HandleItemClick(row.Item)" @onclick:stopPropagation="true">
                                @row.Item
                            </button>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.LabelCount)" Title="Label" Width="90px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.LabelCount);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.Description)" Title="Description" Width="300px" />
                <GridColumn Field="@nameof(AsnLine.UnitCost)" Title="Unit Cost" Width="120px" TextAlign="@ColumnTextAlign.Right" DisplayFormat="{0:C}">
                    <Template>
                        @{
                            var line = (AsnLine)context;
                            @line.UnitCost.ToString("C")
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.ExtCost)" Title="Ext. Cost" Width="130px" TextAlign="@ColumnTextAlign.Right">
                    <Template>
                        @{
                            var line = (AsnLine)context;
                            @line.ExtCost.ToString("C")
                        }
                    </Template>
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.ExtCost);
                            <strong>@total.ToString("C")</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.PONumber)" Title="PO #" Width="140px" />
                <GridColumn Field="@nameof(AsnLine.POLine)" Title="PO Line" Width="100px" TextAlign="@ColumnTextAlign.Right" />
                <GridColumn Field="@nameof(AsnLine.NeedFor)" Title="Need For" Width="120px" />
                <GridColumn Field="@nameof(AsnLine.QtyOnHand)" Title="Qty On Hand" Width="130px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.QtyOnHand);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.TotalQtyNeeds)" Title="Total Qty Needs" Width="150px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.TotalQtyNeeds);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.QtyShip)" Title="Qty Ship" Width="110px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.QtyShip);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.PreviouslyReceived)" Title="Prev Rcv Qty" Width="140px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.PreviouslyReceived);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.ReceiveQty)" Title="Rcv Qty" Width="110px" TextAlign="@ColumnTextAlign.Right" Editable="true">
                    <Template>
                        @{
                            var line = (AsnLine)context;
                            <span style="@(line.ReceiveQty > 0 ? "font-weight: bold; color: #28a745;" : "")">
                                @line.ReceiveQty
                            </span>
                        }
                    </Template>
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.ReceiveQty);
                            <strong class="text-success">@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.Status)" Title="Status" Width="120px">
                    <Template>
                        @{
                            var line = (AsnLine)context;
                            var statusClass = line.Status.ToLower() switch
                            {
                                "open" => "badge badge-success",
                                "closed" => "badge badge-secondary",
                                "partial" => "badge badge-warning",
                                _ => "badge badge-info"
                            };
                            <span class="@statusClass">@line.Status</span>
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
            <GridSettings>
                <GridPagerSettings InputType="PagerInputType.Input"
                                   PageSizes="@(new List<int?> { 10, 20, 50, 100, null })" />
            </GridSettings>
        </TelerikGrid>

        <footer class="actions" style="padding: 1rem; background-color: transparent; border: 1px solid var(--nav-border);">
            <button class="btn outline" @onclick="SelectAll">Select All (@CurrentLines.Count)</button>
            <button class="btn outline" @onclick="UnselectAll">Un-Select All</button>
            <button class="btn primary" @onclick="PrintPriceLabels" disabled="@(!CanPrintLabels)">
                Print Price Labels @(SelectedLineItems.Any() ? $"({SelectedLineItems.Count})" : "")
            </button>
            <button class="btn success" @onclick="Receive" disabled="@(!CanReceive)">
                Receive @(TotalReceiveQty > 0 ? $"({TotalReceiveQty} items)" : "")
            </button>
        </footer>
    </section>
</div>


<!-- Side Panel for Item Preview -->
<SidePanel IsOpen="@SidePanelService.IsOpen"
           IsOpenChanged="@((value) => { if (!value) SidePanelService.Close(); })"
           Title="@GetSidePanelTitle()"
           NavigateUrl="@GetWebcatUrl()"
           OnNavigate="@NavigateToWebcat">
    <WebcatItemPreviewPanel ItemNumber="@SidePanelService.CurrentItemNumber"
                            Item="@SidePanelService.CurrentItem"
                            ErrorMessage="@SidePanelService.ErrorMessage" />
</SidePanel>

@code {
    // ============================================================
    // Centralized parameters - single source of truth
    // ============================================================
    private ReceiptOfProductParameters Params = new();

    // ============================================================
    // Page contract & URL bindings
    // ============================================================
    protected override string BasePath => "/po-transfer/receipt-of-product";
    protected override string MultiKeyName => "asnlines";

    // Grid selection tracking (not in params because it's synced from grid component)
    private readonly HashSet<string> SelectedLineItems = new(StringComparer.OrdinalIgnoreCase);
    private IEnumerable<AsnLine> _selectedLinesCollection = new List<AsnLine>();
    private IEnumerable<AsnLine> SelectedLinesCollection
    {
        get => _selectedLinesCollection;
        set
        {
            _selectedLinesCollection = value;
            SyncSelectedLines();
        }
    }

    // Data
    private List<AsnSummary> AsnList = new();

    // Derived collections based on Params
    private List<AsnSummary> DisplayedAsns =>
        Params.Class == "All" ? AsnList : AsnList.Where(a => a.Class == Params.Class).ToList();

    private List<AsnSummary> FilteredAsns =>
        (Params.Status == ReceiptStatusKind.All ? DisplayedAsns : DisplayedAsns.Where(a => a.Status == Params.Status))
        .OrderByDescending(a => a.ShipDate)
        .ToList();

    // Derived header fields
    private string SelectedAsnDisplay => FilteredAsns.FirstOrDefault(a => a.AsnId == Params.SelectedAsn)?.Display ?? "";
    private decimal SelectedAsnTotal => FilteredAsns.FirstOrDefault(a => a.AsnId == Params.SelectedAsn)?.Total ?? 0m;
    private string SelectedAsnShipFrom => FilteredAsns.FirstOrDefault(a => a.AsnId == Params.SelectedAsn)?.ShipFrom ?? "";
    private DateTime? SelectedAsnShipDate => FilteredAsns.FirstOrDefault(a => a.AsnId == Params.SelectedAsn)?.ShipDate;

    // Top-row local/editable state (not in URL)
    private bool PrintNeedsOnly;
    private decimal ReceivedAmount;
    private string TrackingNumber = "";
    private string SelectedCarrier = "UPS";
    private readonly string[] Carriers = new[] { "UPS", "USPS", "FedEx", "DHL", "OnTrac", "Other" };

    // Lines
    private List<AsnLine> CurrentLines = new();

    private int LabelCountTotal => CurrentLines.Sum(x => x.LabelCount);
    private int TotalReceiveQty => CurrentLines.Sum(x => x.ReceiveQty);
    private bool CanPrintLabels => PrintNeedsOnly && SelectedLineItems.Any();
    private bool CanReceive => TotalReceiveQty > 0;

    // ====== PageWithSidebarBase contract ======
    protected override IReadOnlyDictionary<string, string?> Scalars => Params.ToScalars();
    protected override IReadOnlyCollection<string> MultiValues => SelectedLineItems;

    protected override void ReadFromUrl()
    {
        // Step 1: Read raw values from URL (excluding ASN for now)
        var rawScalars = new Dictionary<string, string?>(StringComparer.OrdinalIgnoreCase)
        {
            ["dealer"] = Url.Get("dealer"),
            ["option"] = "Receipt of Product",
            ["status"] = Url.Get("status"),
            ["class"] = Url.Get("class")
        };

        // Step 2: Validate facet dependencies
        var validated = ValidateFacetDependencies(rawScalars);

        // Step 3: Create params from validated values (without ASN yet)
        Params = ReceiptOfProductParameters.FromScalars(validated);

        // Step 4: Now that Status is set, we can filter ASNs and validate the ASN parameter
        var urlAsn = Url.Get("asn");
        var availableAsns = FilteredAsns;

        if (string.IsNullOrWhiteSpace(urlAsn) || !availableAsns.Any(x => x.AsnId.Equals(urlAsn, StringComparison.OrdinalIgnoreCase)))
        {
            Params.SelectedAsn = availableAsns.FirstOrDefault()?.AsnId;
        }
        else
        {
            Params.SelectedAsn = urlAsn;
        }

        // Step 5: Load data for the selected ASN
        LoadHeaderFor(Params.SelectedAsn);
        LoadLinesFor(Params.SelectedAsn);

        // Step 6: Restore grid selection from URL
        SelectedLineItems.Clear();
        var lineItems = Url.GetMulti(MultiKeyName);
        foreach (var item in lineItems)
        {
            SelectedLineItems.Add(item);
        }

        _selectedLinesCollection = CurrentLines
            .Where(l => SelectedLineItems.Contains(l.Item))
            .ToList();

        // Step 7: Ensure URL reflects current selection (replace mode to avoid history spam)
        if (Params.SelectedAsn != urlAsn)
        {
            NavigateWithPageState(replace: true);
        }
    }

    protected override IEnumerable<Facet> Facets()
    {
        yield return new Facet(
            Key: "option",
            Title: "Option",
            Options: () => new[]
            {
                new FacetOption("Items On Order", "Items On Order",
                    Href: AppendPreserved(Url.BuildHref("/po-transfer/items-on-order",
                        new Dictionary<string, string?> { ["status"] = "All" }))),

                new FacetOption("Purchase Orders", "Purchase Orders",
                    Href: AppendPreserved(Url.BuildHref("/po-transfer/purchase-orders",
                        new Dictionary<string, string?> { ["status"] = "All" }))),

                new FacetOption("Receipt of Product", "Receipt of Product",
                    Href: AppendPreserved(Url.BuildHref("/po-transfer/receipt-of-product",
                        new Dictionary<string, string?> { ["status"] = "All" })))
            }
        );

        yield return new Facet(
            Key: "status",
            Title: "Status",
            DependsOn: "option",
            IsValidForParent: (parentVal) => string.Equals(parentVal, "Receipt of Product", StringComparison.OrdinalIgnoreCase),
            Options: () => new[]
            {
                new FacetOption("All", "All"),
                new FacetOption("Open", "Open"),
                new FacetOption("Closed", "Closed")
            }
        );

        yield return new Facet(
            Key: "asn",
            Title: "ASN",
            DependsOn: "status",
            IsValidForParent: (parentVal) => !string.IsNullOrEmpty(parentVal),
            Options: () => FilteredAsns.Select(a =>
                new FacetOption(
                    $"{a.AsnId} - {a.ShipDate:MM/dd/yyyy}",
                    a.AsnId
                ))
        );
    }

    // ===== Lifecycle =====
    protected override void OnInitialized()
    {
        // Load seed data
        AsnList = ReceiptOfProductSeedData.GetAsnSummaries()
            .OrderByDescending(a => a.ShipDate)
            .ToList();

        // Base wires Nav/Sidebar and builds initial sections from current URL
        base.OnInitialized();
    }

    // ===== Data loaders =====
    private void LoadHeaderFor(string? asnId)
    {
        // Defaults
        PrintNeedsOnly = false;
        ReceivedAmount = 0m;
        TrackingNumber = "";
        SelectedCarrier = "UPS";

        var asn = AsnList.FirstOrDefault(x => x.AsnId == asnId);
        if (asn is null) return;

        PrintNeedsOnly = asn.PrintNeedsOnly;
        ReceivedAmount = asn.ReceivedAmount;
        TrackingNumber = asn.TrackingNumber ?? "";
        SelectedCarrier = string.IsNullOrWhiteSpace(asn.Carrier) ? "UPS" : asn.Carrier;
    }

    private void LoadLinesFor(string? asnId)
    {
        CurrentLines.Clear();

        if (string.IsNullOrWhiteSpace(asnId)) return;

        CurrentLines.AddRange(ReceiptOfProductSeedData.GetAsnLines(asnId));

        // Only clear selection if not restoring from URL
        if (!SelectedLineItems.Any())
        {
            _selectedLinesCollection = new List<AsnLine>();
        }
    }

    // ============================================================
    // Selection sync
    // ============================================================
    private void SyncSelectedLines()
    {
        var newItems = _selectedLinesCollection.Select(l => l.Item).ToHashSet(StringComparer.OrdinalIgnoreCase);
        var changed = !SelectedLineItems.SetEquals(newItems);

        if (changed)
        {
            SelectedLineItems.Clear();
            foreach (var item in newItems)
            {
                SelectedLineItems.Add(item);
            }

            NavigateWithPageState();
        }
    }

    // ===== Grid event handlers =====
    private async Task UpdateHandler(GridCommandEventArgs args)
    {
        var line = (AsnLine)args.Item;

        var existingLine = CurrentLines.FirstOrDefault(l => l.Item == line.Item);
        if (existingLine != null)
        {
            existingLine.ReceiveQty = line.ReceiveQty;
            ReceivedAmount = CurrentLines.Sum(l => l.ReceiveQty * l.UnitCost);
        }

        await InvokeAsync(StateHasChanged);
    }

    // ===== Actions =====
    private void SelectAll()
    {
        _selectedLinesCollection = CurrentLines.ToList();
        SelectedLineItems.Clear();
        foreach (var line in CurrentLines)
        {
            SelectedLineItems.Add(line.Item);
        }
        NavigateWithPageState();
        StateHasChanged();
    }

    private void UnselectAll()
    {
        _selectedLinesCollection = new List<AsnLine>();
        SelectedLineItems.Clear();
        NavigateWithPageState();
        StateHasChanged();
    }

    private async Task PrintPriceLabels()
    {
        if (!CanPrintLabels) return;

        var items = string.Join(", ", SelectedLineItems);
        await JS.InvokeVoidAsync("console.log", $"Printing price labels for: {items}");

        // TODO: Implement actual label printing
    }

    private async Task Receive()
    {
        if (!CanReceive) return;

        var itemsToReceive = CurrentLines.Where(l => l.ReceiveQty > 0).ToList();
        var summary = string.Join(", ", itemsToReceive.Select(l => $"{l.Item} ({l.ReceiveQty})"));

        await JS.InvokeVoidAsync("console.log", $"Receiving items: {summary}");
        await JS.InvokeVoidAsync("console.log", $"Total amount: {ReceivedAmount:C}");

        // TODO: Implement actual receiving logic
    }

    private async Task TrackPackageAsync()
    {
        var url = BuildTrackingUrl(SelectedCarrier, TrackingNumber);
        if (string.IsNullOrWhiteSpace(url)) return;

        await JS.InvokeVoidAsync("open", url, "_blank", "noopener,noreferrer");
    }

    private static string BuildTrackingUrl(string carrier, string tracking)
    {
        if (string.IsNullOrWhiteSpace(tracking)) return "";
        var enc = Uri.EscapeDataString(tracking.Trim());
        return carrier?.ToUpperInvariant() switch
        {
            "UPS" => $"https://www.ups.com/track?loc=en_US&tracknum={enc}",
            "USPS" => $"https://tools.usps.com/go/TrackConfirmAction?tLabels={enc}",
            "FEDEX" => $"https://www.fedex.com/fedextrack/?trknbr={enc}",
            "DHL" => $"https://www.dhl.com/global-en/home/tracking.html?tracking-id={enc}",
            "ONTRAC" => $"https://www.ontrac.com/trackingres.asp?tracking_number={enc}",
            _ => $"https://www.google.com/search?q={Uri.EscapeDataString($"{carrier} {tracking}")}"
        };
    }

    // ============================================================
    // Side Panel Helpers
    // ============================================================
    private void HandleItemClick(string item)
    {
        // Open side panel instead of just selecting
        SidePanelService.OpenItemPreview(item);
    }

    private string GetSidePanelTitle()
    {
        if (SidePanelService.CurrentItem != null)
        {
            return $"Item Details - {SidePanelService.CurrentItemNumber}";
        }
        return "Item Details";
    }

    private string? GetWebcatUrl()
    {
        if (string.IsNullOrEmpty(SidePanelService.CurrentItemNumber))
        {
            return null;
        }
        return $"/product/webcat?item={Uri.EscapeDataString(SidePanelService.CurrentItemNumber)}";
    }

    private void NavigateToWebcat()
    {
        var url = GetWebcatUrl();
        if (!string.IsNullOrEmpty(url))
        {
            NavigationManager.NavigateTo(url);
        }
    }
}