@page "/po-transfer/receipt-of-product"

@using System.Globalization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.WebUtilities
@using Prototype.Components.Layout
@using Prototype.Components.Layout.Navigation
@using Prototype.Components.Layout.Navigation.Sidebar
@using Prototype.Pages.POTransfer.SeedData
@using Telerik.Blazor
@using Telerik.Blazor.Components
@using static Prototype.Pages.POTransfer.SeedData.ReceiptOfProductSeedData

@inherits PageWithSidebarBase

@inject IJSRuntime JS

<div class="wrap">
    <header class="header">
        <h3 class="title">Receipt of Product</h3>

        <div class="rop-meta card table-wrap">
            <div class="field span-2">
                <label>ASN#:</label>
                <input readonly class="rop-asn" value="@SelectedAsnDisplay" />
            </div>

            <div class="field inline">
                <label>Print Needs Only:</label>
                <input type="checkbox" class="rop-pno" @bind="PrintNeedsOnly" />
            </div>

            <div class="field">
                <label>Total:</label>
                <input readonly class="rop-total" value="@SelectedAsnTotal.ToString("C")" />
            </div>

            <div class="field">
                <label>Received:</label>
                <input class="rop-received" type="number" step="0.01" inputmode="decimal"
                       @bind-value="ReceivedAmount" @bind-value:event="onchange" />
            </div>

            <div class="field">
                <label>Tracking#:</label>
                <input class="rop-tracking" @bind="TrackingNumber" />
            </div>

            <div class="field">
                <label>Carrier:</label>
                <select class="rop-carrier" @bind="SelectedCarrier">
                    @foreach (var c in Carriers)
                    {
                        <option value="@c">@c</option>
                    }
                </select>
            </div>

            <div class="field inline narrow align-end">
                <button class="btn"
                        @onclick="TrackPackageAsync"
                        disabled="@string.IsNullOrWhiteSpace(TrackingNumber)">
                    Track
                </button>
            </div>

            <div class="field">
                <label>Ship From:</label>
                <input readonly class="rop-shipfrom" value="@SelectedAsnShipFrom" />
            </div>

            <div class="field">
                <label>Ship Date:</label>
                <input readonly class="rop-shipdate" value="@SelectedAsnShipDate?.ToString("MM/dd/yyyy")" />
            </div>
        </div>
    </header>

    <section class="card rop-card">
        <header class="section-header panel" style="display: flex; align-items: center; padding: 1rem;">
            <h4 style="margin: 0;">Shipping Notifications</h4>
            <span class="badge" style="margin-left:auto;">Label Count: @LabelCountTotal</span>
        </header>

        <TelerikGrid Data="@CurrentLines"
                     SelectionMode="@GridSelectionMode.Multiple"
                     @bind-SelectedItems="@SelectedLinesCollection"
                     Pageable="true"
                     PageSize="20"
                     Sortable="true"
                     FilterMode="@GridFilterMode.FilterRow"
                     Resizable="true"
                     Reorderable="true"
                     Groupable="true"
                     ShowColumnMenu="true"
                     OnUpdate="@UpdateHandler"
                     EditMode="@GridEditMode.Incell">
            <GridToolBarTemplate>
                <GridCommandButton Command="ExcelExport" Icon="@SvgIcon.FileExcel">Export to Excel</GridCommandButton>
                <GridSearchBox />
                <span style="margin-left: auto; font-weight: bold;">
                    Total Lines: @CurrentLines.Count | Selected: @SelectedLineItems.Count
                </span>
            </GridToolBarTemplate>
            <GridExport>
                <GridExcelExport FileName="asn-lines" AllPages="true" />
                <GridCsvExport FileName="asn-lines" AllPages="true" />
            </GridExport>
            <GridColumns>
                <GridCheckboxColumn SelectAll="true" Width="60px" Locked="true" />
                <GridColumn Field="@nameof(AsnLine.Item)" Title="Item" Width="140px" Locked="true" />
                <GridColumn Field="@nameof(AsnLine.LabelCount)" Title="Label" Width="90px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.LabelCount);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.Description)" Title="Description" Width="300px" />
                <GridColumn Field="@nameof(AsnLine.UnitCost)" Title="Unit Cost" Width="120px" TextAlign="@ColumnTextAlign.Right" DisplayFormat="{0:C}">
                    <Template>
                        @{
                            var line = (AsnLine)context;
                            @line.UnitCost.ToString("C")
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.ExtCost)" Title="Ext. Cost" Width="130px" TextAlign="@ColumnTextAlign.Right">
                    <Template>
                        @{
                            var line = (AsnLine)context;
                            @line.ExtCost.ToString("C")
                        }
                    </Template>
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.ExtCost);
                            <strong>@total.ToString("C")</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.PONumber)" Title="PO #" Width="140px" />
                <GridColumn Field="@nameof(AsnLine.POLine)" Title="PO Line" Width="100px" TextAlign="@ColumnTextAlign.Right" />
                <GridColumn Field="@nameof(AsnLine.NeedFor)" Title="Need For" Width="120px" />
                <GridColumn Field="@nameof(AsnLine.QtyOnHand)" Title="Qty On Hand" Width="130px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.QtyOnHand);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.TotalQtyNeeds)" Title="Total Qty Needs" Width="150px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.TotalQtyNeeds);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.QtyShip)" Title="Qty Ship" Width="110px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.QtyShip);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.PreviouslyReceived)" Title="Prev Rcv Qty" Width="140px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.PreviouslyReceived);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.ReceiveQty)" Title="Rcv Qty" Width="110px" TextAlign="@ColumnTextAlign.Right" Editable="true">
                    <Template>
                        @{
                            var line = (AsnLine)context;
                            <span style="@(line.ReceiveQty > 0 ? "font-weight: bold; color: #28a745;" : "")">
                                @line.ReceiveQty
                            </span>
                        }
                    </Template>
                    <FooterTemplate>
                        @{
                            var total = CurrentLines.Sum(x => x.ReceiveQty);
                            <strong style="color: #28a745;">@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(AsnLine.Status)" Title="Status" Width="120px">
                    <Template>
                        @{
                            var line = (AsnLine)context;
                            var statusClass = line.Status.ToLower() switch
                            {
                                "open" => "badge badge-success",
                                "closed" => "badge badge-secondary",
                                "partial" => "badge badge-warning",
                                _ => "badge badge-info"
                            };
                            <span class="@statusClass">@line.Status</span>
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
            <GridSettings>
                <GridPagerSettings InputType="PagerInputType.Input"
                                   PageSizes="@(new List<int?> { 10, 20, 50, 100, null })" />
            </GridSettings>
        </TelerikGrid>

        <footer class="actions" style="margin-top: 1rem; padding: 1rem;">
            <button class="btn outline" @onclick="SelectAll">Select All (@CurrentLines.Count)</button>
            <button class="btn outline" @onclick="UnselectAll">Un-Select All</button>
            <button class="btn primary" @onclick="PrintPriceLabels" disabled="@(!CanPrintLabels)">
                Print Price Labels @(SelectedLineItems.Any() ? $"({SelectedLineItems.Count})" : "")
            </button>
            <button class="btn success" @onclick="Receive" disabled="@(!CanReceive)">
                Receive @(TotalReceiveQty > 0 ? $"({TotalReceiveQty} items)" : "")
            </button>
        </footer>
    </section>
</div>

@code {
    // Enable franchise selector in sidebar
    protected override bool ShowFranchiseSelector => true;

    // ============================================================
    // Page contract & URL bindings
    // ============================================================
    protected override string BasePath => "/po-transfer/receipt-of-product";

    // MultiKey name for grid selections
    protected override string MultiKeyName => "asnlines";

    // ===== URL-bound state (singletons) =====
    private ReceiptStatus Status = ReceiptStatus.Open;
    private string Class = "All";
    private string? SelectedAsnId;
    private string? DealerId;

    // Grid selection tracking
    private readonly HashSet<string> SelectedLineItems = new(StringComparer.OrdinalIgnoreCase);
    private IEnumerable<AsnLine> _selectedLinesCollection = new List<AsnLine>();
    private IEnumerable<AsnLine> SelectedLinesCollection
    {
        get => _selectedLinesCollection;
        set
        {
            _selectedLinesCollection = value;
            SyncSelectedLines();
        }
    }

    // Data
    private List<AsnSummary> AsnList = new();

    private List<AsnSummary> DisplayedAsns =>
        Class == "All" ? AsnList : AsnList.Where(a => a.Class == Class).ToList();

    private List<AsnSummary> FilteredAsns =>
        (Status == ReceiptStatus.All ? DisplayedAsns : DisplayedAsns.Where(a => a.Status == Status))
        .OrderByDescending(a => a.ShipDate)
        .ToList();

    // Derived header fields
    private string SelectedAsnDisplay => FilteredAsns.FirstOrDefault(a => a.AsnId == SelectedAsnId)?.Display ?? "";
    private decimal SelectedAsnTotal => FilteredAsns.FirstOrDefault(a => a.AsnId == SelectedAsnId)?.Total ?? 0m;
    private string SelectedAsnShipFrom => FilteredAsns.FirstOrDefault(a => a.AsnId == SelectedAsnId)?.ShipFrom ?? "";
    private DateTime? SelectedAsnShipDate => FilteredAsns.FirstOrDefault(a => a.AsnId == SelectedAsnId)?.ShipDate;

    // Top-row local/editable
    private bool PrintNeedsOnly;
    private decimal ReceivedAmount;
    private string TrackingNumber = "";
    private string SelectedCarrier = "UPS";
    private readonly string[] Carriers = new[] { "UPS", "USPS", "FedEx", "DHL", "OnTrac", "Other" };

    // Lines
    private List<AsnLine> CurrentLines = new();

    private int LabelCountTotal => CurrentLines.Sum(x => x.LabelCount);
    private int TotalReceiveQty => CurrentLines.Sum(x => x.ReceiveQty);
    private bool CanPrintLabels => PrintNeedsOnly && SelectedLineItems.Any();
    private bool CanReceive => TotalReceiveQty > 0;

    // ====== PageWithSidebarBase contract ======
    protected override IReadOnlyDictionary<string, string?> Scalars =>
        new Dictionary<string, string?>(StringComparer.OrdinalIgnoreCase)
        {
            ["dealer"] = DealerId,
            ["option"] = "Receipt of Product",
            ["status"] = Status.ToString(),
            ["class"] = Class,
            ["asn"] = SelectedAsnId
        };

    // Expose selected line items as MultiValues
    protected override IReadOnlyCollection<string> MultiValues => SelectedLineItems;

    protected override void ReadFromUrl()
    {
        // Read parameters using UrlState
        DealerId = Url.Get("dealer");

        // Read and parse status enum
        var statusVal = Url.Get("status");
        Status = (!string.IsNullOrWhiteSpace(statusVal) && Enum.TryParse<ReceiptStatus>(statusVal, true, out var parsedStatus))
            ? parsedStatus
            : ReceiptStatus.Open;

        // Read class from URL
        Class = Url.Get("class") ?? "All";

        // Read ASN selection
        SelectedAsnId = Url.Get("asn");

        // Keep selection valid against current filter
        var list = FilteredAsns;
        if (SelectedAsnId is null || !list.Any(x => x.AsnId.Equals(SelectedAsnId, StringComparison.OrdinalIgnoreCase)))
            SelectedAsnId = list.FirstOrDefault()?.AsnId;

        LoadHeaderFor(SelectedAsnId);
        LoadLinesFor(SelectedAsnId);

        // Read selected lines from URL
        SelectedLineItems.Clear();
        var lineItems = Url.GetMulti(MultiKeyName);
        foreach (var item in lineItems)
        {
            SelectedLineItems.Add(item);
        }

        // Restore grid selection
        _selectedLinesCollection = CurrentLines.Where(l => SelectedLineItems.Contains(l.Item)).ToList();
    }

    // ============================================================
    // Sidebar facets
    // ============================================================
    protected override IEnumerable<Facet> Facets()
    {
        yield return new Facet(
            Key: "option",
            Title: "Option",
            Options: () => new[]
            {
                new FacetOption("Items On Order",    "Items On Order",    Href: AppendPreserved("/po-transfer/items-on-order?status=All")),
                new FacetOption("Purchase Orders",   "Purchase Orders",   Href: AppendPreserved("/po-transfer/purchase-orders?status=All")),
                new FacetOption("Receipt of Product","Receipt of Product",Href: AppendPreserved("/po-transfer/receipt-of-product?status=All"))
            }
        );

        yield return new Facet(
            Key: "status",
            Title: "Status",
            Options: () => new[]
            {
                new FacetOption("All","All",       Href: AppendPreserved($"{BasePath}?status=All")),
                new FacetOption("Open","Open",     Href: AppendPreserved($"{BasePath}?status=Open")),
                new FacetOption("Closed","Closed", Href: AppendPreserved($"{BasePath}?status=Closed"))
            }
        );

        yield return new Facet(
            Key: "asn",
            Title: "ASN",
            Options: () => FilteredAsns.Select(a =>
                new FacetOption(
                    $"{a.AsnId} - {a.ShipDate:MM/dd/yyyy}",
                    a.AsnId,
                    Href: AppendPreserved($"{BasePath}?asn={Uri.EscapeDataString(a.AsnId)}")
                ))
        );
    }

    protected override void OnSidebarClick(SidebarItem item)
    {
        if (!string.IsNullOrWhiteSpace(item.Url))
            Nav.NavigateTo(item.Url);
    }

    // ===== Lifecycle =====
    protected override void OnInitialized()
    {
        // Load seed data
        AsnList = ReceiptOfProductSeedData.GetAsnSummaries()
            .OrderByDescending(a => a.ShipDate)
            .ToList();

        // Important: base wires Nav/Sidebar and builds initial sections from current URL
        base.OnInitialized();
    }

    // ===== Data loaders =====
    private void LoadHeaderFor(string? asnId)
    {
        // defaults
        PrintNeedsOnly = false;
        ReceivedAmount = 0m;
        TrackingNumber = "";
        SelectedCarrier = "UPS";

        var a = AsnList.FirstOrDefault(x => x.AsnId == asnId);
        if (a is null) return;

        PrintNeedsOnly = a.PrintNeedsOnly;
        ReceivedAmount = a.ReceivedAmount;
        TrackingNumber = a.TrackingNumber ?? "";
        SelectedCarrier = string.IsNullOrWhiteSpace(a.Carrier) ? "UPS" : a.Carrier;
    }

    private void LoadLinesFor(string? asnId)
    {
        CurrentLines.Clear();

        if (string.IsNullOrWhiteSpace(asnId)) return;

        // Load lines from seed data
        CurrentLines.AddRange(ReceiptOfProductSeedData.GetAsnLines(asnId));

        // Only clear selection if not restoring from URL
        if (!SelectedLineItems.Any())
        {
            _selectedLinesCollection = new List<AsnLine>();
        }
    }

    // ============================================================
    // Selection sync
    // ============================================================
    private void SyncSelectedLines()
    {
        var newItems = _selectedLinesCollection.Select(l => l.Item).ToHashSet(StringComparer.OrdinalIgnoreCase);
        var changed = !SelectedLineItems.SetEquals(newItems);

        if (changed)
        {
            SelectedLineItems.Clear();
            foreach (var item in newItems)
            {
                SelectedLineItems.Add(item);
            }

            NavigateWithPageState();
        }
    }

    // ===== Grid event handlers =====
    private async Task UpdateHandler(GridCommandEventArgs args)
    {
        var line = (AsnLine)args.Item;

        // Find and update the line in the list
        var existingLine = CurrentLines.FirstOrDefault(l => l.Item == line.Item);
        if (existingLine != null)
        {
            existingLine.ReceiveQty = line.ReceiveQty;

            // Recalculate received amount
            ReceivedAmount = CurrentLines.Sum(l => l.ReceiveQty * l.UnitCost);
        }

        await InvokeAsync(StateHasChanged);
    }

    // ===== Actions =====
    private void SelectAll()
    {
        _selectedLinesCollection = CurrentLines.ToList();
        SelectedLineItems.Clear();
        foreach (var line in CurrentLines)
        {
            SelectedLineItems.Add(line.Item);
        }
        NavigateWithPageState();
        StateHasChanged();
    }

    private void UnselectAll()
    {
        _selectedLinesCollection = new List<AsnLine>();
        SelectedLineItems.Clear();
        NavigateWithPageState();
        StateHasChanged();
    }

    private async Task PrintPriceLabels()
    {
        if (!CanPrintLabels) return;

        var items = string.Join(", ", SelectedLineItems);
        await JS.InvokeVoidAsync("console.log", $"Printing price labels for: {items}");

        // TODO: Implement actual label printing
    }

    private async Task Receive()
    {
        if (!CanReceive) return;

        var itemsToReceive = CurrentLines.Where(l => l.ReceiveQty > 0).ToList();
        var summary = string.Join(", ", itemsToReceive.Select(l => $"{l.Item} ({l.ReceiveQty})"));

        await JS.InvokeVoidAsync("console.log", $"Receiving items: {summary}");
        await JS.InvokeVoidAsync("console.log", $"Total amount: {ReceivedAmount:C}");

        // TODO: Implement actual receiving logic
        // After successful receive:
        // - Update line statuses
        // - Clear receive quantities
        // - Reload data
    }

    private async Task TrackPackageAsync()
    {
        var url = BuildTrackingUrl(SelectedCarrier, TrackingNumber);
        if (string.IsNullOrWhiteSpace(url)) return;

        await JS.InvokeVoidAsync("open", url, "_blank", "noopener,noreferrer");
    }

    private static string BuildTrackingUrl(string carrier, string tracking)
    {
        if (string.IsNullOrWhiteSpace(tracking)) return "";
        var enc = Uri.EscapeDataString(tracking.Trim());
        return carrier?.ToUpperInvariant() switch
        {
            "UPS" => $"https://www.ups.com/track?loc=en_US&tracknum={enc}",
            "USPS" => $"https://tools.usps.com/go/TrackConfirmAction?tLabels={enc}",
            "FEDEX" => $"https://www.fedex.com/fedextrack/?trknbr={enc}",
            "DHL" => $"https://www.dhl.com/global-en/home/tracking.html?tracking-id={enc}",
            "ONTRAC" => $"https://www.ontrac.com/trackingres.asp?tracking_number={enc}",
            _ => $"https://www.google.com/search?q={Uri.EscapeDataString($"{carrier} {tracking}")}"
        };
    }
}

<style>
    .badge {
        display: inline-block;
        padding: 0.35em 0.65em;
        font-size: 0.875em;
        font-weight: 600;
        line-height: 1;
        color: #fff;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
    }

    .badge-success {
        background-color: #28a745;
    }

    .badge-secondary {
        background-color: #6c757d;
    }

    .badge-warning {
        background-color: #ffc107;
        color: #212529;
    }

    .badge-info {
        background-color: #17a2b8;
    }

    .btn.outline {
        background-color: transparent;
        border: 1px solid #6c757d;
        color: #6c757d;
    }

        .btn.outline:hover {
            background-color: #6c757d;
            color: #fff;
        }

    .btn.primary {
        background-color: #007bff;
        color: #fff;
        border: none;
    }

        .btn.primary:hover {
            background-color: #0056b3;
        }

    .btn.success {
        background-color: #28a745;
        color: #fff;
        border: none;
    }

        .btn.success:hover {
            background-color: #1e7e34;
        }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
