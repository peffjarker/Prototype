@page "/po-transfer/items-on-order"

@using System.Globalization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.WebUtilities
@using Prototype.Components.Layout
@using Prototype.Components.Layout.Navigation
@using Prototype.Components.Layout.Navigation.Sidebar
@using Prototype.Components.Services
@using Prototype.Components.Services.Reports
@using Utils

@inherits PageWithSidebarBase

@inject IJSRuntime JS
@inject IItemsOnOrderPdfService ReportService

<div class="ioo-wrap">
    <header class="ioo-header">
        <h3 class="ioo-title">Items On Order</h3>
    </header>

    <!-- Items table -->
    <section class="card">
        <div class="table-wrap">
            <table class="tbl tbl-items panel" role="grid" aria-label="Items on order">
                <thead>
                    <tr>
                        <th class="w-item">Item</th>
                        <th>Description</th>
                        <th class="num">On Order Open</th>
                        <th class="num">In Transit</th>
                        <th class="num">Alloc</th>
                        <th class="num">BKO</th>
                        <th class="num">Total Open Cost</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < FilteredRows.Count; i++)
                    {
                        var r = FilteredRows[i];
                        var isSelected = SelectedItems.Contains(r.Item);
                        <tr class="row-clickable @(isSelected ? "row-selected" : null)"
                            @onclick="(MouseEventArgs e) => HandleRowClick(r.Item, e)"
                            title="Select item (Ctrl/Cmd for multi, Shift for range)">
                            <td>
                                <button class="link-button"
                                        @onclick:stopPropagation="true"
                                        @onclick="(MouseEventArgs e) => HandleRowClick(r.Item, e)">
                                    @r.Item
                                </button>
                            </td>
                            <td>@r.Description</td>
                            <td class="num">@r.OnOrderOpen</td>
                            <td class="num">@r.InTransit</td>
                            <td class="num">@r.Alloc</td>
                            <td class="num @HighlightIf(r.BKO > 0)">@r.BKO</td>
                            <td class="num">@r.TotalOpenCost.ToString("C")</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="totals">
                        <td colspan="2">
                            <div class="chips-row">
                                @if (SelectedItems.Count > 0)
                                {
                                    <div class="chips">
                                        <span class="chips-label">Filtering by</span>
                                        @foreach (var it in SelectedItems.OrderBy(x => x))
                                        {
                                            <span class="chip" title="Remove filter">
                                                <strong>@it</strong>
                                                <button class="chip-x" @onclick="() => RemoveItem(it)" aria-label="Remove">×</button>
                                            </span>
                                        }
                                        <button class="chip-clear" @onclick="ClearItemFilter" aria-label="Clear all">Clear all</button>
                                    </div>
                                }
                            </div>
                        </td>
                        <td class="num">@FilteredRows.Sum(x => x.OnOrderOpen)</td>
                        <td class="num">@FilteredRows.Sum(x => x.InTransit)</td>
                        <td class="num">@FilteredRows.Sum(x => x.Alloc)</td>
                        <td class="num">@FilteredRows.Sum(x => x.BKO)</td>
                        <td class="num">@FilteredRows.Sum(x => x.TotalOpenCost).ToString("C")</td>
                    </tr>
                    <tr class="totals-sub">
                        <td colspan="7">
                            In Transit: <strong>@FilteredRows.Sum(x => x.InTransitCost).ToString("C")</strong>
                            &nbsp; | &nbsp; Backorders Awaiting Release: <strong>@FilteredRows.Sum(x => x.BackorderCost).ToString("C")</strong>
                            &nbsp; | &nbsp; Backordered: <strong>@FilteredRows.Sum(x => x.BackorderCost).ToString("C")</strong>
                            &nbsp; | &nbsp; Unacknowledged: <strong>@FilteredRows.Sum(x => x.UnacknowledgedCost).ToString("C")</strong>
                            &nbsp; | &nbsp; Open Items: <strong>@FilteredRows.Sum(x => x.TotalOpenCost).ToString("C")</strong>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </section>

    <!-- PO lines -->
    <section class="panel" id="oplines" @ref="_oplinesSection">
        <header class="section-header">
            <h4>Open PO Lines</h4>
            @if (SelectedItems.Count > 0)
            {
                <div class="chips compact">
                    <span class="chips-label">Showing PO lines for:</span>
                    @foreach (var it in SelectedItems.OrderBy(x => x))
                    {
                        <span class="chip" title="Remove filter">
                            <strong>@it</strong>
                            <button class="chip-x" @onclick="() => RemoveItem(it)" aria-label="Remove">×</button>
                        </span>
                    }
                    <button class="chip-clear" @onclick="ClearItemFilter" aria-label="Clear all">Clear</button>
                </div>
            }
        </header>

        <div class="table-wrap">
            <table class="tbl tbl-lines" role="grid" aria-label="Open PO lines">
                <thead>
                    <tr>
                        <th class="w-po">PO#</th>
                        <th class="w-ln">Ln</th>
                        <th class="w-so">SO#</th>
                        <th>Vendor</th>
                        <th class="w-date">Date</th>
                        <th class="num">Qty Ord</th>
                        <th class="num">Open</th>
                        <th class="num">In Transit</th>
                        <th class="num">Alloc</th>
                        <th class="num">BKO</th>
                        <th class="num">Unit Cost</th>
                        <th class="num">Total Open Cost</th>
                        <th class="num">Rcv</th>
                        <th class="w-status">Status</th>
                    </tr>
                </thead>
                <tbody>
                    @if (VisibleOpenLines.Count == 0)
                    {
                        <tr><td colspan="15" class="muted">No open PO lines @(SelectedItems.Count == 0 ? "" : $"for {string.Join(", ", SelectedItems.OrderBy(x => x))}").</td></tr>
                    }
                    else
                    {
                        @foreach (var p in VisibleOpenLines)
                        {
                            <tr>
                                <td>
                                    <button class="link-button" title="Open PO details"
                                            @onclick="() => OpenPODetails(p.PONumber)">
                                        @p.PONumber
                                    </button>
                                </td>
                                <td class="num">@p.Line</td>
                                <td>@p.SONumber</td>
                                <td>@p.Vendor</td>
                                <td>@p.Date.ToString("MM/dd/yyyy")</td>
                                <td class="num">@p.QtyOrdered</td>
                                <td class="num">@p.Open</td>
                                <td class="num">@p.InTransit</td>
                                <td class="num">@p.Alloc</td>
                                <td class="num">@p.BKO</td>
                                <td class="num">@p.UnitCost.ToString("C")</td>
                                <td class="num">@p.TotalOpenCost.ToString("C")</td>
                                <td class="num">@p.Rcv</td>
                                <td>@p.Status</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <footer class="actions">
            <button style="border: 1px solid black;" class="btn" @onclick="Print">Print</button>
        </footer>
    </section>
</div>

@code {
    // ======= Base wiring =======
    protected override string BasePath => "/po-transfer/items-on-order";

    // URL-bound state (via Scalars)
    public enum StatusKind { All, Backorders, InTransit, Unacknowledged }
    private static StatusKind MapStatus(string s) => s switch
    {
        "Backorders" => StatusKind.Backorders,
        "In Transit" => StatusKind.InTransit,
        "Unacknowledged" => StatusKind.Unacknowledged,
        _ => StatusKind.All
    };

    private StatusKind Status = StatusKind.All;

    // Multi-select (grid-driven)
    private readonly HashSet<string> SelectedItems = new(StringComparer.OrdinalIgnoreCase);
    private int? _anchorIndex; // for shift-range

    private ElementReference _oplinesSection;

    // Page data
    private readonly List<Row> Rows = new();
    private List<Row> FilteredRows => ApplyStatusFilter(Rows, Status);
    private readonly List<OpenPOLine> OpenLines = new();
    private List<OpenPOLine> VisibleOpenLines =>
        SelectedItems.Count == 0 ? OpenLines : OpenLines.Where(x => SelectedItems.Contains(x.Item)).ToList();

    // Scalars → what goes into URL as singletons (besides multi 'items')
    protected override IReadOnlyDictionary<string, string?> Scalars =>
        new Dictionary<string, string?>(StringComparer.OrdinalIgnoreCase)
        {
            ["dealer"] = DealerId,
            ["option"] = "Items On Order",
            ["status"] = Status.ToString()
        };

    // Multi facet values (we still encode items=… in the URL for deep links)
    protected override IReadOnlyCollection<string> MultiValues => SelectedItems;

    // URL-bound state
    private string? DealerId;

    // Decode URL → local state
    protected override void ReadFromUrl()
    {
        var abs = Nav.ToAbsoluteUri(Nav.Uri);
        var q = QueryHelpers.ParseQuery(abs.Query);

        // dealer
        DealerId = q.TryGetValue("dealer", out var dVal) && !string.IsNullOrWhiteSpace(dVal)
            ? dVal.ToString()
            : null;

        // status
        if (q.TryGetValue("status", out var sVal) && !string.IsNullOrWhiteSpace(sVal))
            Status = MapStatus(sVal!);
        else
            Status = StatusKind.All;

        // items …
        SelectedItems.Clear();
        if (q.TryGetValue("items", out var itemsVals))
        {
            foreach (var raw in itemsVals)
            {
                if (string.IsNullOrWhiteSpace(raw)) continue;
                foreach (var part in raw.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
                    SelectedItems.Add(part);
            }
        }
    }

    private string AppendDealer(string href)
    {
        var abs = href.StartsWith("http", StringComparison.OrdinalIgnoreCase)
            ? href
            : Nav.ToAbsoluteUri(href).ToString();

        var uri = new Uri(abs);
        var dict = QueryHelpers.ParseQuery(uri.Query)
            .ToDictionary(kv => kv.Key, kv => kv.Value.ToString(), StringComparer.OrdinalIgnoreCase);

        if (!string.IsNullOrWhiteSpace(DealerId))
            dict["dealer"] = DealerId!;
        else
            dict.Remove("dealer");

        var withDealer = QueryHelpers.AddQueryString(uri.GetLeftPart(UriPartial.Path), dict);
        var rel = Nav.ToBaseRelativePath(withDealer);
        return "/" + rel.TrimStart('/');
    }

    // Declare the sidebar facets this page wants (Option/Status/Legend)
    protected override IEnumerable<Facet> Facets()
    {
        yield return new Facet(
            Key: "option",
            Title: "Option",
            Options: () => new[]
            {
            new FacetOption("Items On Order",   "Items On Order", Href: AppendDealer("/po-transfer/items-on-order?status=All")),
            new FacetOption("Purchase Orders",  "Purchase Orders", Href: AppendDealer("/po-transfer/purchase-orders")),
            new FacetOption("Receipt of Product","Receipt of Product", Href: AppendDealer("/po-transfer/receipt-of-product?status=All"))
            }
        );

        yield return new Facet(
            Key: "status",
            Title: "Status",
            Options: () => new[]
            {
            new FacetOption("All","All",                 Href: AppendDealer($"{BasePath}?status=All")),
            new FacetOption("Backorders","Backorders",   Href: AppendDealer($"{BasePath}?status=Backorders")),
            new FacetOption("In Transit","In Transit",   Href: AppendDealer($"{BasePath}?status=In Transit")),
            new FacetOption("Unacknowledged","Unacknowledged", Href: AppendDealer($"{BasePath}?status=Unacknowledged"))
            }
        );

        yield return new Facet(
            Key: "legend",
            Title: "Item Legend",
            Options: () => new[]
            {
            new FacetOption("Discontinued","disc", ColorHex:"#e11d48"),
            new FacetOption("Price Confirm","price", ColorHex:"#111827"),
            new FacetOption("CSI","csi", ColorHex:"#2563eb"),
            new FacetOption("Drop Ship","ds", ColorHex:"#f59e0b"),
            new FacetOption("Special Orders","so", ColorHex:"#eab308")
            },
            IsLegend: true
        );
    }

    // No custom sidebar click handling needed for this page;
    // we only use grid clicks for the multi "items" selection.
    protected override void OnSidebarClick(SidebarItem item)
    {
        if (!string.IsNullOrWhiteSpace(item.Url))
            Nav.NavigateTo(AppendDealer(item.Url));
    }

    protected override void OnInitialized()
    {
        // Seed demo data (replace with your data source)
        Rows.AddRange(new[]
        {
            new Row("A02", "1/4\" Drive (F) x 3/8\" (M) Adapter", 1, 0, 0, 1, 23.50m),
            new Row("A20", "3/8\" Drive (F) x 1/2\" (M) Adapter", 2, 2, 0, 0, 45.00m),
            new Row("A23", "3/8\" Drive (F) x 1/2\" (M) Adapter", 1, 1, 0, 1, 22.10m),
            new Row("A35", "1/2\" Drive (F) x 3/4\" (M) Adapter", 1, 0, 0, 0, 18.75m),
            new Row("AF12201", "1220-1 AIR TOOL OIL PINT", 18, 18, 0, 0, 180.00m),
            new Row("AP328", "1/2\"Dr.(F) x 1/2\"(M) Imp Adapt,Ball Type", 1, 1, 0, 0, 19.30m),
            new Row("AS6SB", "Stubby Air Slide Hammer", 1, 1, 0, 0, 159.99m),
            new Row("CAT3160", "3/16\" Orbital Sander 6\"", 1, 2, 0, 1, 299.00m)
        });

        OpenLines.AddRange(new[]
        {
            new OpenPOLine
            {
                Item = "CAT3160",
                PONumber = "PO-0000100807", Line = 1, SONumber = "0002916666",
                Vendor = "CQT", Date = new DateTime(2025, 09, 30),
                QtyOrdered = 2, Open = 2, InTransit = 0, Alloc = 0, BKO = 1,
                UnitCost = 299.00m, Rcv = 0, Status = "Open"
            },
            new OpenPOLine
            {
                Item = "A20",
                PONumber = "PO-0000100821", Line = 3, SONumber = "0002917777",
                Vendor = "CQT", Date = new DateTime(2025, 09, 28),
                QtyOrdered = 5, Open = 2, InTransit = 2, Alloc = 0, BKO = 0,
                UnitCost = 45.00m, Rcv = 3, Status = "Partial"
            },
            new OpenPOLine
            {
                Item = "A02",
                PONumber = "PO-0000100821", Line = 4, SONumber = "0002917777",
                Vendor = "CQT", Date = new DateTime(2025, 09, 28),
                QtyOrdered = 1, Open = 1, InTransit = 0, Alloc = 0, BKO = 1,
                UnitCost = 23.50m, Rcv = 0, Status = "Open"
            }
        });

        base.OnInitialized(); // wires URL <-> Sidebar once and builds sections
    }

    // ===== Grid click handling with Ctrl/Cmd + Shift =====
    private async Task HandleRowClick(string item, MouseEventArgs e)
    {
        var list = FilteredRows;
        var idx = FindIndex(list, item);
        if (idx < 0) idx = 0;

        bool scrolled = false;

        if (e.ShiftKey && _anchorIndex is int anchor && anchor >= 0 && anchor < list.Count)
        {
            var start = Math.Min(anchor, idx);
            var end = Math.Max(anchor, idx);
            for (int i = start; i <= end; i++)
                SelectedItems.Add(list[i].Item);
            scrolled = true;
        }
        else if (e.CtrlKey || e.MetaKey)
        {
            if (!SelectedItems.Add(item))
                SelectedItems.Remove(item);
            _anchorIndex = idx;
        }
        else
        {
            SelectedItems.Clear();
            SelectedItems.Add(item);
            _anchorIndex = idx;
            scrolled = true;
        }

        // Update URL with current scalars + multi items
        Utils.QueryStringMap.Write(Nav, Scalars, SelectedItems.Select(v => ("items", v)));

        if (scrolled)
            await ScrollToPOLinesAsync();

        StateHasChanged();
    }

    private static int FindIndex(List<Row> list, string item)
    {
        for (int i = 0; i < list.Count; i++)
            if (string.Equals(list[i].Item, item, StringComparison.OrdinalIgnoreCase))
                return i;
        return -1;
    }

    private void RemoveItem(string item)
    {
        if (!SelectedItems.Remove(item)) return;
        QueryStringMap.Write(Nav, Scalars, SelectedItems.Select(v => ("items", v)), replace: SelectedItems.Count == 0);
        StateHasChanged();
    }

    private async Task ScrollToPOLinesAsync()
    {
        try { await JS.InvokeVoidAsync("blazorIoO.scrollIntoView", _oplinesSection); }
        catch { /* best effort */ }
    }

    private void ClearItemFilter()
    {
        if (SelectedItems.Count == 0) return;
        SelectedItems.Clear();
        _anchorIndex = null;
        QueryStringMap.Write(Nav, Scalars, Array.Empty<(string key, string val)>(), replace: true);
        StateHasChanged();
    }

    private void OpenPODetails(string poNumber) => Console.WriteLine($"Open PO details: {poNumber}");

    private async Task Print()
    {
        var report = new ItemsOnOrderReport
        {
            Title = "Items on Order",
            Subtitle = null,
            Company = "IBN Dealer Suite",
            ReportDate = DateTime.Today,
            ShowTotals = true,
            Culture = CultureInfo.CurrentCulture,
            Rows = FilteredRows.Select(r => new ItemsOnOrderRow
            {
                Item = r.Item,
                Description = r.Description,
                OnOrder = r.OnOrderOpen,
                Open = r.OnOrderOpen,
                InTransit = r.InTransit,
                Alloc = r.Alloc,
                Bko = r.BKO,
                TotalOpenCost = r.TotalOpenCost,
                InTransitCost = r.InTransitCost,
                BackorderedCost = r.BackorderCost,
                UnacknowledgedCost = r.UnacknowledgedCost
            }).ToList()
        };

        var pdfBytes = await ReportService.GenerateAsync(report);
        var fileName = $"ItemsOnOrder_{DateTime.Now:yyyyMMdd_HHmm}.pdf";
        await JS.InvokeVoidAsync("files.save", fileName, Convert.ToBase64String(pdfBytes));
    }

    private static List<Row> ApplyStatusFilter(List<Row> source, StatusKind status) =>
        status switch
        {
            StatusKind.All => source,
            StatusKind.Backorders => source.Where(r => r.BKO > 0).ToList(),
            StatusKind.InTransit => source.Where(r => r.InTransit > 0).ToList(),
            StatusKind.Unacknowledged => source.Where(r => r.IsUnacknowledged).ToList(),
            _ => source
        };

    private string HighlightIf(bool cond) => cond ? "hl" : "";

    private sealed class Row
    {
        public Row(string item, string desc, int onOrderOpen, int inTransit, int alloc, int bko, decimal unitCost)
        { Item = item; Description = desc; OnOrderOpen = onOrderOpen; InTransit = inTransit; Alloc = alloc; BKO = bko; UnitCost = unitCost; }
        public string Item { get; set; }
        public string Description { get; set; }
        public int OnOrderOpen { get; set; }
        public int InTransit { get; set; }
        public int Alloc { get; set; }
        public int BKO { get; set; }
        public decimal UnitCost { get; set; }
        public decimal TotalOpenCost => UnitCost * Math.Max(OnOrderOpen, 0);
        public decimal InTransitCost => UnitCost * InTransit;
        public decimal BackorderCost => UnitCost * BKO;
        public bool IsUnacknowledged => OnOrderOpen > 0 && InTransit == 0 && BKO == 0 && Alloc == 0;
        public decimal UnacknowledgedCost => IsUnacknowledged ? TotalOpenCost : 0m;
    }

    private sealed class OpenPOLine
    {
        public string Item { get; set; } = "";
        public string PONumber { get; set; } = "";
        public int Line { get; set; }
        public string SONumber { get; set; } = "";
        public string Vendor { get; set; } = "";
        public DateTime Date { get; set; }
        public int QtyOrdered { get; set; }
        public int Open { get; set; }
        public int InTransit { get; set; }
        public int Alloc { get; set; }
        public int BKO { get; set; }
        public decimal UnitCost { get; set; }
        public decimal TotalOpenCost => UnitCost * Math.Max(Open, 0);
        public int Rcv { get; set; }
        public string Status { get; set; } = "Open";
    }
}

<script>
    window.blazorIoO = window.blazorIoO || {};
    window.blazorIoO.scrollIntoView = function (el) {
        if (!el) return;
        el.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
    };
</script>
