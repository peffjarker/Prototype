@page "/po-transfer/items-on-order"
@attribute [Authorize(Policy = AppPolicies.CustomerService)]

@using System.Globalization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.WebUtilities
@using Prototype.Components.Layout
@using Prototype.Components.Layout.Navigation
@using Prototype.Components.Layout.Navigation.Sidebar
@using Prototype.Components.Pages.POXfer.ItemsOnOrder
@using Prototype.Components.Pages.POXfer.PO
@using Prototype.Components.Pages.Product.Webcat
@using Prototype.Components.Services
@using Prototype.Components.Services.Reports
@using Prototype.Components.SharedComponents
@using Prototype.Components.SharedComponents.Sidepanel
@using Prototype.Pages.POTransfer
@using Telerik.Blazor
@using Telerik.Blazor.Components
@using global::Services
@using static Prototype.Components.Pages.POXfer.ItemsOnOrder.ItemsOnOrderSeedData
@using static Prototype.Pages.POTransfer.ItemsOnOrderParameters

@inherits PageWithSidebarBase

@inject IJSRuntime JS
@inject IItemsOnOrderPdfService ReportService
@inject NavigationManager NavigationManager
@inject SidePanelService SidePanelService

<div class="wrap">
    <header class="header">
        <h3 class="title">Items On Order</h3>
    </header>

    <!-- Items Grid -->
    <section class="card">
        <TelerikGrid Data="@FilteredRows"
                     SelectionMode="@GridSelectionMode.Multiple"
                     @bind-SelectedItems="@SelectedItemsCollection"
                     Pageable="true"
                     PageSize="20"
                     Sortable="true"
                     FilterMode="@GridFilterMode.FilterRow"
                     Resizable="true"
                     Reorderable="true"
                     Groupable="true"
                     ShowColumnMenu="true"
                     OnRowClick="@OnRowClickHandler"
                     @ref="@ItemsGridRef">
            <GridToolBarTemplate>
                <GridCommandButton Command="ExcelExport" Icon="@SvgIcon.FileExcel">Export to Excel</GridCommandButton>
                <GridCommandButton Command="CsvExport" Icon="@SvgIcon.FileCsv">Export to CSV</GridCommandButton>
                <GridSearchBox DebounceDelay="300" />
                <TelerikButton OnClick="@ClearAllFilters" Icon="@SvgIcon.FilterClear">Clear Filters</TelerikButton>
                <span style="margin-left: auto; display: flex; gap: 1rem; align-items: center;">
                    <span style="font-weight: bold;">Total Items: @FilteredRows.Count</span>
                    <span class="text-accent" style="font-weight: bold;">Selected: @Params.SelectedItems.Count</span>
                    @if (Params.SelectedItems.Count > 0)
                    {
                        <TelerikButton OnClick="@(() => { SelectedItemsCollection = new List<Row>(); })"
                                       Icon="@SvgIcon.X"
                                       FillMode="@ThemeConstants.Button.FillMode.Flat">
                            Clear Selection
                        </TelerikButton>
                    }
                </span>
            </GridToolBarTemplate>
            <GridExport>
                <GridExcelExport FileName="items-on-order" AllPages="true" />
                <GridCsvExport FileName="items-on-order" AllPages="true" />
            </GridExport>
            <GridColumns>
                <GridCheckboxColumn SelectAll="true" Width="60px" Locked="true" Title="Select" />
                <GridColumn Field="@nameof(Row.Item)" Title="Item" Width="140px" Locked="true">
                    <Template>
                        @{
                            var row = (Row)context;
                            <button class="link-button" @onclick="() => HandleItemClick(row.Item)" @onclick:stopPropagation="true">
                                @row.Item
                            </button>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(Row.Description)" Title="Description" Width="350px" />
                <GridColumn Field="@nameof(Row.OnOrderOpen)" Title="On Order Open" Width="160px" TextAlign="@ColumnTextAlign.Right">
                    <Template>
                        @{
                            var row = (Row)context;
                            <span class="@(row.OnOrderOpen > 10 ? "badge badge-warning" : "")">@row.OnOrderOpen</span>
                        }
                    </Template>
                    <FooterTemplate>
                        @{
                            var total = FilteredRows.Sum(x => x.OnOrderOpen);
                            <strong class="text-accent">@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(Row.InTransit)" Title="In Transit" Width="140px" TextAlign="@ColumnTextAlign.Right">
                    <Template>
                        @{
                            var row = (Row)context;
                            @if (row.InTransit > 0)
                            {
                                <span class="badge badge-info">@row.InTransit</span>
                            }
                            else
                            {
                                <span>@row.InTransit</span>
                            }
                        }
                    </Template>
                    <FooterTemplate>
                        @{
                            var total = FilteredRows.Sum(x => x.InTransit);
                            <strong class="text-info">@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(Row.Alloc)" Title="Alloc" Width="120px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = FilteredRows.Sum(x => x.Alloc);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(Row.BKO)" Title="BKO" Width="120px" TextAlign="@ColumnTextAlign.Right">
                    <Template>
                        @{
                            var row = (Row)context;
                            @if (row.BKO > 0)
                            {
                                <span class="badge badge-danger">@row.BKO</span>
                            }
                            else
                            {
                                <span>@row.BKO</span>
                            }
                        }
                    </Template>
                    <FooterTemplate>
                        @{
                            var total = FilteredRows.Sum(x => x.BKO);
                            <strong class="text-danger">@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(Row.UnitCost)" Title="Unit Cost" Width="140px" TextAlign="@ColumnTextAlign.Right" DisplayFormat="{0:C}" />
                <GridColumn Field="@nameof(Row.TotalOpenCost)" Title="Total Open Cost" Width="170px" TextAlign="@ColumnTextAlign.Right">
                    <Template>
                        @{
                            var row = (Row)context;
                            @row.TotalOpenCost.ToString("C")
                        }
                    </Template>
                    <FooterTemplate>
                        @{
                            var total = FilteredRows.Sum(x => x.TotalOpenCost);
                            <strong class="text-success" style="font-size: 1.1em;">@total.ToString("C")</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
            </GridColumns>
            <GridSettings>
                <GridPagerSettings InputType="PagerInputType.Input"
                                   PageSizes="@(new List<int?> { 10, 20, 50, 100, null })" />
            </GridSettings>
        </TelerikGrid>

        @if (Params.SelectedItems.Count > 0)
        {
            <div style="padding: 1rem; background: var(--app-bg); border: 1px solid var(--nav-border);">
                <div class="chips-row">
                    <div class="chips">
                        <span class="chips-label" style="font-weight: 600;">Filtering PO Lines by Selected Items: </span>
                        @foreach (var it in Params.SelectedItems.OrderBy(x => x))
                        {
                            <span class="chip" title="Remove filter">
                                <strong>@it</strong>
                                <button class="chip-x" @onclick="() => RemoveItem(it)" aria-label="Remove">×</button>
                            </span>
                        }
                        <button class="chip-clear" @onclick="ClearItemFilter" aria-label="Clear all">Clear all</button>
                    </div>
                </div>
            </div>
        }

        <div style="padding: 1rem; background: transparent; border: 1px solid var(--nav-border); display: flex; gap: 2rem; flex-wrap: wrap; font-size: 0.875rem;">
            <div>
                <span class="text-muted">In Transit:</span>
                <strong class="text-info">@FilteredRows.Sum(x => x.InTransitCost).ToString("C")</strong>
            </div>
            <div>
                <span class="text-muted">Backorders Awaiting Release:</span>
                <strong class="text-warning">@FilteredRows.Sum(x => x.BackorderCost).ToString("C")</strong>
            </div>
            <div>
                <span class="text-muted">Backordered:</span>
                <strong class="text-danger">@FilteredRows.Sum(x => x.BackorderCost).ToString("C")</strong>
            </div>
            <div>
                <span class="text-muted">Unacknowledged:</span>
                <strong>@FilteredRows.Sum(x => x.UnacknowledgedCost).ToString("C")</strong>
            </div>
            <div>
                <span class="text-muted">Open Items:</span>
                <strong class="text-success" style="font-size: 1.1em;">@FilteredRows.Sum(x => x.TotalOpenCost).ToString("C")</strong>
            </div>
        </div>
    </section>

    <!-- PO Lines Grid -->
    <section class="panel" id="oplines" @ref="_oplinesSection" style="margin-top: 2rem;">
        <header class="section-header" style="background: transparent; padding: 1rem; border: 1px solid var(--nav-border);">
            <h4 style="margin: 0; display: flex; align-items: center; gap: 1rem;">
                Open PO Lines
                <span class="badge badge-primary" style="padding: 0.35em 0.65em;">
                    @VisibleOpenLines.Count Lines
                </span>
            </h4>
            @if (Params.SelectedItems.Count > 0)
            {
                <div class="chips compact" style="margin-top: 0.5rem;">
                    <span class="chips-label">Showing PO lines for: </span>
                    @foreach (var it in Params.SelectedItems.OrderBy(x => x))
                    {
                        <span class="chip" title="Remove filter">
                            <strong>@it</strong>
                            <button class="chip-x" @onclick="() => RemoveItem(it)" aria-label="Remove">×</button>
                        </span>
                    }
                    <button class="chip-clear" @onclick="ClearItemFilter" aria-label="Clear all">Clear</button>
                </div>
            }
        </header>

        <TelerikGrid Data="@VisibleOpenLines"
                     Pageable="true"
                     PageSize="20"
                     Sortable="true"
                     FilterMode="@GridFilterMode.FilterRow"
                     Resizable="true"
                     Reorderable="true"
                     Groupable="true"
                     ShowColumnMenu="true"
                     @ref="@POLinesGridRef">
            <GridToolBarTemplate>
                <GridCommandButton Command="ExcelExport" Icon="@SvgIcon.FileExcel">Export to Excel</GridCommandButton>
                <GridCommandButton Command="CsvExport" Icon="@SvgIcon.FileCsv">Export to CSV</GridCommandButton>
                <GridSearchBox DebounceDelay="300" />
                <TelerikButton OnClick="@ClearPOLinesFilters" Icon="@SvgIcon.FilterClear">Clear Filters</TelerikButton>
                <span style="margin-left: auto; font-weight: bold;">
                    Total PO Lines: @VisibleOpenLines.Count
                </span>
            </GridToolBarTemplate>
            <GridExport>
                <GridExcelExport FileName="open-po-lines" AllPages="true" />
                <GridCsvExport FileName="open-po-lines" AllPages="true" />
            </GridExport>
            <GridColumns>
                <GridColumn Field="@nameof(OpenPOLine.Item)" Title="Item" Width="140px" Locked="true">
                    <Template>
                        @{
                            var line = (OpenPOLine)context;
                            <button class="link-button" @onclick="() => HandleItemClick(line.Item)" @onclick:stopPropagation="true">
                                @line.Item
                            </button>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(OpenPOLine.PONumber)" Title="PO#" Width="160px">
                    <Template>
                        @{
                            var line = (OpenPOLine)context;
                            <button class="link-button" title="Open PO details" @onclick="() => HandlePoClick(line.PONumber)" @onclick:stopPropagation="true">
                                @line.PONumber
                            </button>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(OpenPOLine.Line)" Title="Ln" Width="80px" TextAlign="@ColumnTextAlign.Right" />
                <GridColumn Field="@nameof(OpenPOLine.SONumber)" Title="SO#" Width="140px" />
                <GridColumn Field="@nameof(OpenPOLine.Vendor)" Title="Vendor" Width="140px" />
                <GridColumn Field="@nameof(OpenPOLine.Date)" Title="Date" Width="130px" DisplayFormat="{0:MM/dd/yyyy}">
                    <Template>
                        @{
                            var line = (OpenPOLine)context;
                            var daysDiff = (DateTime.Today - line.Date).Days;
                            var dateClass = daysDiff > 30 ? "text-danger" : daysDiff > 14 ? "text-warning" : "";
                            <span class="@dateClass">@line.Date.ToString("MM/dd/yyyy")</span>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(OpenPOLine.QtyOrdered)" Title="Qty Ord" Width="110px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = VisibleOpenLines.Sum(x => x.QtyOrdered);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(OpenPOLine.Open)" Title="Open" Width="110px" TextAlign="@ColumnTextAlign.Right">
                    <Template>
                        @{
                            var line = (OpenPOLine)context;
                            @if (line.Open > 0)
                            {
                                <span class="text-accent" style="font-weight: 600;">@line.Open</span>
                            }
                            else
                            {
                                <span>@line.Open</span>
                            }
                        }
                    </Template>
                    <FooterTemplate>
                        @{
                            var total = VisibleOpenLines.Sum(x => x.Open);
                            <strong class="text-accent">@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(OpenPOLine.InTransit)" Title="In Transit" Width="130px" TextAlign="@ColumnTextAlign.Right">
                    <Template>
                        @{
                            var line = (OpenPOLine)context;
                            @if (line.InTransit > 0)
                            {
                                <span class="badge badge-info">@line.InTransit</span>
                            }
                            else
                            {
                                <span>@line.InTransit</span>
                            }
                        }
                    </Template>
                    <FooterTemplate>
                        @{
                            var total = VisibleOpenLines.Sum(x => x.InTransit);
                            <strong class="text-info">@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(OpenPOLine.Alloc)" Title="Alloc" Width="110px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = VisibleOpenLines.Sum(x => x.Alloc);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(OpenPOLine.BKO)" Title="BKO" Width="110px" TextAlign="@ColumnTextAlign.Right">
                    <Template>
                        @{
                            var line = (OpenPOLine)context;
                            @if (line.BKO > 0)
                            {
                                <span class="badge badge-danger">@line.BKO</span>
                            }
                            else
                            {
                                <span>@line.BKO</span>
                            }
                        }
                    </Template>
                    <FooterTemplate>
                        @{
                            var total = VisibleOpenLines.Sum(x => x.BKO);
                            <strong class="text-danger">@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(OpenPOLine.UnitCost)" Title="Unit Cost" Width="140px" TextAlign="@ColumnTextAlign.Right" DisplayFormat="{0:C}">
                    <Template>
                        @{
                            var line = (OpenPOLine)context;
                            @line.UnitCost.ToString("C")
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="@nameof(OpenPOLine.TotalOpenCost)" Title="Total Open Cost" Width="170px" TextAlign="@ColumnTextAlign.Right">
                    <Template>
                        @{
                            var line = (OpenPOLine)context;
                            @line.TotalOpenCost.ToString("C")
                        }
                    </Template>
                    <FooterTemplate>
                        @{
                            var total = VisibleOpenLines.Sum(x => x.TotalOpenCost);
                            <strong class="text-success" style="font-size: 1.1em;">@total.ToString("C")</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(OpenPOLine.Rcv)" Title="Rcv" Width="100px" TextAlign="@ColumnTextAlign.Right">
                    <FooterTemplate>
                        @{
                            var total = VisibleOpenLines.Sum(x => x.Rcv);
                            <strong>@total</strong>
                        }
                    </FooterTemplate>
                </GridColumn>
                <GridColumn Field="@nameof(OpenPOLine.Status)" Title="Status" Width="130px">
                    <Template>
                        @{
                            var line = (OpenPOLine)context;
                            var statusClass = line.Status.ToLower() switch
                            {
                                "open" => "badge badge-success",
                                "partial" => "badge badge-warning",
                                "closed" => "badge badge-secondary",
                                _ => "badge badge-info"
                            };
                            <span class="@statusClass">@line.Status</span>
                        }
                    </Template>
                </GridColumn>
            </GridColumns>
            <GridSettings>
                <GridPagerSettings InputType="PagerInputType.Input"
                                   PageSizes="@(new List<int?> { 10, 20, 50, 100, null })" />
            </GridSettings>
        </TelerikGrid>

        <footer class="actions" style="padding: 1rem; border: 1px solid var(--nav-border); border-top: 0px; background-color: transparent; margin-bottom: 4vh;">
            <button class="btn btn-primary" @onclick="Print">
                <span class="k-icon k-i-print"></span> Print Report
            </button>
        </footer>
    </section>
</div>

<!-- Side Panel for Item and PO Preview -->
<SidePanel IsOpen="@SidePanelService.IsOpen"
           IsOpenChanged="@((value) => { if (!value) SidePanelService.Close(); })"
           Title="@GetSidePanelTitle()"
           NavigateUrl="@GetSidePanelNavigateUrl()"
           OnNavigate="@NavigateFromSidePanel">
    @if (SidePanelService.ContentType == Prototype.Components.Services.SidePanelContentType.Item)
    {
        <WebcatItemPreviewPanel ItemNumber="@SidePanelService.CurrentItemNumber"
                                Item="@SidePanelService.CurrentItem"
                                ErrorMessage="@SidePanelService.ErrorMessage" />
    }
    else if (SidePanelService.ContentType == Prototype.Components.Services.SidePanelContentType.PurchaseOrder)
    {
        <POPreviewPanel PoNumber="@SidePanelService.CurrentPoNumber"
                        Po="@SidePanelService.CurrentPo"
                        ErrorMessage="@SidePanelService.ErrorMessage" />
    }
</SidePanel>

@code {
    // Centralized parameters
    private ItemsOnOrderParameters Params = new();

    // Grid references for programmatic control
    private TelerikGrid<Row>? ItemsGridRef;
    private TelerikGrid<OpenPOLine>? POLinesGridRef;

    // ============================================================
    // Page contract & URL bindings
    // ============================================================
    protected override string BasePath => "/po-transfer/items-on-order";

    protected override IReadOnlyDictionary<string, string?> Scalars => Params.ToScalars();

    protected override IReadOnlyCollection<string> MultiValues => Params.SelectedItems;

    protected override void ReadFromUrl()
    {
        // Read raw values from URL
        var rawParams = ItemsOnOrderParameters.FromUrl(Url);

        // Validate dependencies - auto-clear status if coming from wrong page
        var validated = ValidateFacetDependencies(rawParams.ToScalars());

        // Rebuild from validated scalars
        Params = ItemsOnOrderParameters.FromScalars(validated, rawParams.SelectedItems);
    }

    // ============================================================
    // Sidebar facets
    // ============================================================
    protected override IEnumerable<Facet> Facets()
    {
        yield return new Facet(
            Key: "option",
            Title: "Option",
            Options: () => new[]
            {
                new FacetOption("Items On Order", "Items On Order",
                    Href: AppendPreserved(Url.BuildHref("/po-transfer/items-on-order",
                        new Dictionary<string, string?> { ["status"] = "All" }))),

                new FacetOption("Purchase Orders", "Purchase Orders",
                    Href: AppendPreserved(Url.BuildHref("/po-transfer/purchase-orders",
                        new Dictionary<string, string?> { ["status"] = "All" }))),

                new FacetOption("Receipt of Product", "Receipt of Product",
                    Href: AppendPreserved(Url.BuildHref("/po-transfer/receipt-of-product",
                        new Dictionary<string, string?> { ["status"] = "All" })))
            }
        );

        yield return new Facet(
            Key: "status",
            Title: "Status",
            DependsOn: "option",
            IsValidForParent: (parentVal) => string.Equals(parentVal, "Items On Order", StringComparison.OrdinalIgnoreCase),
            Options: () => new[]
            {
                new FacetOption("All", "All"),
                new FacetOption("Backorders", "Backorders"),
                new FacetOption("In Transit", "In Transit"),
                new FacetOption("Unacknowledged", "Unacknowledged")
            }
        );

        yield return CommonFacets.ItemLegend;
    }

    // ============================================================
    // Lifecycle & URL-change wiring
    // ============================================================
    protected override void OnInitialized()
    {
        // Load seed data
        AllRows.AddRange(ItemsOnOrderSeedData.GetItems());
        OpenLines.AddRange(ItemsOnOrderSeedData.GetPOLines());

        // Subscribe to side panel changes - ADD LOGGING HERE
        SidePanelService.OnChange += () =>
        {
            Console.WriteLine("=== SidePanelService.OnChange fired! ===");
            StateHasChanged();
        };

        // Call base AFTER setting up data
        base.OnInitialized();

        // Initialize selected items from URL AFTER base.OnInitialized()
        _selectedItemsCollection = FilteredRows.Where(r => Params.SelectedItems.Contains(r.Item)).ToList();
    }

    public new void Dispose()
    {
        SidePanelService.OnChange -= StateHasChanged;
        base.Dispose();
    }

    // ============================================================
    // Page state, data & computed views
    // ============================================================
    private IEnumerable<Row> _selectedItemsCollection = new List<Row>();
    private IEnumerable<Row> SelectedItemsCollection
    {
        get => _selectedItemsCollection;
        set
        {
            _selectedItemsCollection = value;
            SyncSelectedItems();
        }
    }

    private ElementReference _oplinesSection;

    private readonly List<Row> AllRows = new();
    private readonly List<OpenPOLine> OpenLines = new();

    private List<Row> FilteredRows => ApplyStatusFilter(AllRows, Params.Status);

    private List<OpenPOLine> VisibleOpenLines =>
        Params.SelectedItems.Count == 0
            ? OpenLines
            : OpenLines.Where(x => Params.SelectedItems.Contains(x.Item)).ToList();

    // ============================================================
    // UI event handlers
    // ============================================================
    private void SyncSelectedItems()
    {
        var newItems = _selectedItemsCollection.Select(r => r.Item).ToHashSet(StringComparer.OrdinalIgnoreCase);
        var changed = !Params.SelectedItems.ToHashSet(StringComparer.OrdinalIgnoreCase).SetEquals(newItems);

        if (changed)
        {
            Params.SelectedItems.Clear();
            Params.SelectedItems.AddRange(newItems);

            NavigateWithPageState();

            if (Params.SelectedItems.Count > 0)
            {
                InvokeAsync(async () => await ScrollToPOLinesAsync());
            }
        }
    }

    private async Task OnRowClickHandler(GridRowClickEventArgs args)
    {
        // Grid handles selection automatically, we just need to scroll
        if (Params.SelectedItems.Count > 0)
        {
            await ScrollToPOLinesAsync();
        }
    }

    private void HandleItemClick(string item)
    {
        // Open side panel for item preview
        SidePanelService.OpenItemPreview(item);
    }

    private void HandlePoClick(string poNumber)
    {
        Console.WriteLine($"Clicked PO: {poNumber}");
        Console.WriteLine($"Service IsOpen before: {SidePanelService.IsOpen}");

        // Open side panel for PO preview
        SidePanelService.OpenPoPreview(poNumber);

        Console.WriteLine($"Service IsOpen after: {SidePanelService.IsOpen}");
        Console.WriteLine($"Service ContentType: {SidePanelService.ContentType}");
        Console.WriteLine($"Service CurrentPo: {SidePanelService.CurrentPo?.PoNumber ?? "null"}");
        Console.WriteLine($"Service ErrorMessage: {SidePanelService.ErrorMessage ?? "none"}");
    }

    private void RemoveItem(string item)
    {
        if (!Params.SelectedItems.Remove(item)) return;

        // Update the grid selection
        _selectedItemsCollection = FilteredRows.Where(r => Params.SelectedItems.Contains(r.Item)).ToList();

        NavigateWithPageState(replace: Params.SelectedItems.Count == 0);
        StateHasChanged();
    }

    private void ClearItemFilter()
    {
        if (Params.SelectedItems.Count == 0) return;
        Params.SelectedItems.Clear();
        _selectedItemsCollection = new List<Row>();
        NavigateWithPageState(replace: true);
        StateHasChanged();
    }

    private async Task ClearAllFilters()
    {
        if (ItemsGridRef != null)
        {
            var state = ItemsGridRef.GetState();
            state.FilterDescriptors.Clear();
            state.SearchFilter = null;
            await ItemsGridRef.SetStateAsync(state);
        }
    }

    private async Task ClearPOLinesFilters()
    {
        if (POLinesGridRef != null)
        {
            var state = POLinesGridRef.GetState();
            state.FilterDescriptors.Clear();
            state.SearchFilter = null;
            await POLinesGridRef.SetStateAsync(state);
        }
    }

    private async Task ScrollToPOLinesAsync()
    {
        try { await JS.InvokeVoidAsync("blazorIoO.scrollIntoView", _oplinesSection); }
        catch { /* best effort */ }
    }

    private async Task Print()
    {
        var report = new ItemsOnOrderReport
        {
            Title = "Items on Order",
            Subtitle = null,
            Company = "IBN Dealer Suite",
            ReportDate = DateTime.Today,
            ShowTotals = true,
            Culture = CultureInfo.CurrentCulture,
            Rows = FilteredRows.Select(r => new ItemsOnOrderRow
            {
                Item = r.Item,
                Description = r.Description,
                OnOrder = r.OnOrderOpen,
                Open = r.OnOrderOpen,
                InTransit = r.InTransit,
                Alloc = r.Alloc,
                Bko = r.BKO,
                TotalOpenCost = r.TotalOpenCost,
                InTransitCost = r.InTransitCost,
                BackorderedCost = r.BackorderCost,
                UnacknowledgedCost = r.UnacknowledgedCost
            }).ToList()
        };

        var pdfBytes = await ReportService.GenerateAsync(report);
        var fileName = $"ItemsOnOrder_{DateTime.Now:yyyyMMdd_HHmm}.pdf";
        await JS.InvokeVoidAsync("files.save", fileName, Convert.ToBase64String(pdfBytes));
    }

    // ============================================================
    // Side Panel Helpers
    // ============================================================
    private string GetSidePanelTitle()
    {
        return SidePanelService.ContentType switch
        {
            Prototype.Components.Services.SidePanelContentType.Item when SidePanelService.CurrentItem != null 
                => $"Item Details - {SidePanelService.CurrentItemNumber}",
            Prototype.Components.Services.SidePanelContentType.Item 
                => "Item Details",
            Prototype.Components.Services.SidePanelContentType.PurchaseOrder when SidePanelService.CurrentPo != null 
                => $"PO Details - {SidePanelService.CurrentPoNumber}",
            Prototype.Components.Services.SidePanelContentType.PurchaseOrder 
                => "PO Details",
            _ => "Details"
        };
    }

    private string? GetSidePanelNavigateUrl()
    {
        return SidePanelService.ContentType switch
        {
            Prototype.Components.Services.SidePanelContentType.Item when !string.IsNullOrEmpty(SidePanelService.CurrentItemNumber)
                => $"/product/webcat?item={Uri.EscapeDataString(SidePanelService.CurrentItemNumber)}",
            Prototype.Components.Services.SidePanelContentType.PurchaseOrder when !string.IsNullOrEmpty(SidePanelService.CurrentPoNumber)
                => $"/po-transfer/purchase-orders?po={Uri.EscapeDataString(SidePanelService.CurrentPoNumber)}",
            _ => null
        };
    }

    private void NavigateFromSidePanel()
    {
        var url = GetSidePanelNavigateUrl();
        if (!string.IsNullOrEmpty(url))
        {
            NavigationManager.NavigateTo(url);
        }
    }

    // ============================================================
    // Helpers
    // ============================================================
    private static List<Row> ApplyStatusFilter(List<Row> source, StatusKind status) =>
        status switch
        {
            StatusKind.All => source,
            StatusKind.Backorders => source.Where(r => r.BKO > 0).ToList(),
            StatusKind.InTransit => source.Where(r => r.InTransit > 0).ToList(),
            StatusKind.Unacknowledged => source.Where(r => r.IsUnacknowledged).ToList(),
            _ => source
        };
}

<script>
    window.blazorIoO = window.blazorIoO || {};
    window.blazorIoO.scrollIntoView = function (el) {
        if (!el) return;
        el.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
    };
</script>