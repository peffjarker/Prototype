@page "/"
@using Telerik.Blazor
@using Telerik.Blazor.Components
@using Prototype.Components.Layout.Navigation.Sidebar
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject ISidebarState Sidebar

<PageTitle>Home - IBN Dealer Suite</PageTitle>

<main class="main-content home-page">
    @if (FavoritePages.Any())
    {
        <section class="favorites-section">
            <div class="section-header">
                <TelerikSvgIcon Icon="@SvgIcon.Star" />
                <h2>Favorites</h2>
            </div>
            <div class="page-grid">
                @foreach (var Page in FavoritePages)
                {
                    <div class="page-card favorite" @onclick="@(() => NavigateToPage(Page.Url))">
                        <div class="card-header">
                            <div class="card-icon-wrapper">
                                <TelerikSvgIcon Icon="@Page.IconValue" />
                            </div>
                            <button class="favorite-btn active"
                                    @onclick="@(() => ToggleFavoriteAsync(Page.Id))"
                                    @onclick:stopPropagation="true"
                                    title="Remove from favorites">
                                <TelerikSvgIcon Icon="@SvgIcon.Star" />
                            </button>
                        </div>
                        <h3>@Page.Title</h3>
                        <p class="card-description">@Page.Description</p>
                        <div class="card-meta">
                            <span class="badge">@Page.Category</span>
                        </div>
                    </div>
                }
            </div>
        </section>
    }

    <section class="modules-section">
        <div class="section-header">
            <TelerikSvgIcon Icon="@SvgIcon.Grid" />
            <h2>All Modules</h2>
        </div>

        @foreach (var module in GetModules())
        {
            <div class="module-group">
                <div class="module-title">
                    <TelerikSvgIcon Icon="@module.IconValue" />
                    <h3>@module.Name</h3>
                </div>
                <div class="page-grid">
                    @foreach (var Page in module.Pages)
                    {
                        var isFav = IsFavorite(Page.Id);
                        <div class="page-card" @onclick="@(() => NavigateToPage(Page.Url))">
                            <div class="card-header">
                                <div class="card-icon-wrapper @(isFav ? "favorite" : "")">
                                    <TelerikSvgIcon Icon="@Page.IconValue" />
                                </div>
                                <button class="favorite-btn @(isFav ? "active" : "")"
                                        @onclick="@(() => ToggleFavoriteAsync(Page.Id))"
                                        @onclick:stopPropagation="true"
                                        title="@(isFav ? "Remove from favorites" : "Add to favorites")">
                                    <TelerikSvgIcon Icon="@SvgIcon.Star" />
                                </button>
                            </div>
                            <h3>@Page.Title</h3>
                            <p class="card-description">@Page.Description</p>
                            <div class="card-meta">
                                <span class="badge">@Page.Category</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </section>
</main>

@code {
    private HashSet<string> FavoritePageIds = new();

    private List<PageLink> FavoritePages
    {
        get
        {
            var allPages = GetModules().SelectMany(m => m.Pages).ToList();
            return allPages.Where(p => FavoritePageIds.Contains(p.Id)).ToList();
        }
    }

    protected override void OnInitialized()
    {
        Sidebar.ItemSelectedHandler = async (item) =>
        {
            if (!string.IsNullOrWhiteSpace(item.Url))
            {
                Nav.NavigateTo(item.Url);
            }
            await Task.CompletedTask;
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadFavoritesAsync();
            BuildFavoritesSidebar();
            StateHasChanged();
        }
    }

    private async Task LoadFavoritesAsync()
    {
        try
        {
            var favoritesJson = await JS.InvokeAsync<string>("localStorage.getItem", "ibn-favorites");
            if (!string.IsNullOrEmpty(favoritesJson))
            {
                var list = System.Text.Json.JsonSerializer.Deserialize<List<string>>(favoritesJson);
                if (list != null)
                {
                    FavoritePageIds = new HashSet<string>(list);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading favorites: {ex.Message}");
        }
    }

    private async Task SaveFavoritesAsync()
    {
        try
        {
            var list = FavoritePageIds.ToList();
            var favoritesJson = System.Text.Json.JsonSerializer.Serialize(list);
            await JS.InvokeVoidAsync("localStorage.setItem", "ibn-favorites", favoritesJson);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving favorites: {ex.Message}");
        }
    }

    private bool IsFavorite(string pageId) => FavoritePageIds.Contains(pageId);

    private async Task ToggleFavoriteAsync(string pageId)
    {
        if (IsFavorite(pageId))
        {
            FavoritePageIds.Remove(pageId);
        }
        else
        {
            FavoritePageIds.Add(pageId);
        }

        await SaveFavoritesAsync();
        BuildFavoritesSidebar();
        StateHasChanged();
    }

    private void BuildFavoritesSidebar()
    {
        if (!FavoritePages.Any())
        {
            Sidebar.ResetAll(hide: true);
            return;
        }

        var favoritesByCategory = FavoritePages
            .GroupBy(p => p.Category)
            .OrderBy(g => g.Key)
            .ToList();

        var sections = new List<SidebarSection>();

        foreach (var categoryGroup in favoritesByCategory)
        {
            var section = new SidebarSection
            {
                SectionKey = categoryGroup.Key,
                Title = categoryGroup.Key,
                Items = categoryGroup.Select(page => new SidebarItem
                {
                    Text = page.Title,
                    Key = page.Id,
                    Url = page.Url,
                    Icon = GetIconSvg(page.IconValue)
                }).ToList()
            };

            sections.Add(section);
        }

        Sidebar.SetSections(sections);
    }

    private string GetIconSvg(ISvgIcon icon)
    {
        if (icon == SvgIcon.Star) return "⭐";
        if (icon == SvgIcon.ListUnordered) return "📋";
        if (icon == SvgIcon.FileAdd) return "📄";
        if (icon == SvgIcon.Inbox) return "📥";
        if (icon == SvgIcon.Search) return "🔍";
        if (icon == SvgIcon.Wrench) return "🔧";
        if (icon == SvgIcon.Dollar) return "💵";
        if (icon == SvgIcon.User) return "👤";
        if (icon == SvgIcon.CheckCircle) return "✅";
        return "";
    }

    private void NavigateToPage(string url)
    {
        Nav.NavigateTo(url);
    }

    private List<Module> GetModules()
    {
        return new List<Module>
        {
            new Module
            {
                Name = "PO / Transfer",
                IconValue = SvgIcon.ArrowsSwap,
                Pages = new List<PageLink>
                {
                    new PageLink
                    {
                        Id = "items-on-order",
                        Title = "Items On Order",
                        Description = "View and manage items on order, track inventory, and monitor PO lines",
                        Category = "PO / Transfer",
                        IconValue = SvgIcon.ListUnordered,
                        Url = "/po-transfer/items-on-order?status=All"
                    },
                    new PageLink
                    {
                        Id = "purchase-orders",
                        Title = "Purchase Orders",
                        Description = "Create, view, and manage purchase orders with vendors",
                        Category = "PO / Transfer",
                        IconValue = SvgIcon.FileAdd,
                        Url = "/po-transfer/purchase-orders?status=All"
                    },
                    new PageLink
                    {
                        Id = "receipt-of-product",
                        Title = "Receipt of Product",
                        Description = "Process incoming shipments and receive products into inventory",
                        Category = "PO / Transfer",
                        IconValue = SvgIcon.Inbox,
                        Url = "/po-transfer/receipt-of-product?status=Open"
                    }
                }
            },
            new Module
            {
                Name = "Product Management",
                IconValue = SvgIcon.Cart,
                Pages = new List<PageLink>
                {
                    new PageLink
                    {
                        Id = "webcat",
                        Title = "Webcat - Item Availability",
                        Description = "Browse catalog items, check availability, and view inventory details",
                        Category = "Product",
                        IconValue = SvgIcon.Search,
                        Url = "/product/webcat?class=All Items"
                    },
                    new PageLink
                    {
                        Id = "set-maintenance",
                        Title = "Set Maintenance",
                        Description = "Manage product sets and their components",
                        Category = "Product",
                        IconValue = SvgIcon.Wrench,
                        Url = "/product/set-maintenance?class=All Items"
                    },
                    new PageLink
                    {
                        Id = "prices",
                        Title = "View/Change Prices",
                        Description = "View pricing history, promotions, and manage product prices",
                        Category = "Product",
                        IconValue = SvgIcon.Dollar,
                        Url = "/product/prices?class=All Items"
                    }
                }
            },
            new Module
            {
                Name = "TechCredit",
                IconValue = SvgIcon.Dollar,
                Pages = new List<PageLink>
                {
                    new PageLink
                    {
                        Id = "customer-information",
                        Title = "Customer Information",
                        Description = "View TechCredit customer details, balances, and transaction history",
                        Category = "TechCredit",
                        IconValue = SvgIcon.User,
                        Url = "/techcredit/customerinformation?option=Information&status=All"
                    },
                    new PageLink
                    {
                        Id = "credit-application",
                        Title = "Credit Application",
                        Description = "Review and manage customer credit applications",
                        Category = "TechCredit",
                        IconValue = SvgIcon.FileAdd,
                        Url = "/techcredit/creditapplication?status=All"
                    },
                    new PageLink
                    {
                        Id = "sales-authorizations",
                        Title = "Sales Authorizations",
                        Description = "Process and review TechCredit sales authorizations",
                        Category = "TechCredit",
                        IconValue = SvgIcon.CheckCircle,
                        Url = "/techcredit/salesauthorizations?status=All"
                    }
                }
            }
        };
    }

    public class Module
    {
        public string Name { get; set; } = "";
        public ISvgIcon IconValue { get; set; } = SvgIcon.Grid;
        public List<PageLink> Pages { get; set; } = new();
    }

    public class PageLink
    {
        public string Id { get; set; } = "";
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string Category { get; set; } = "";
        public ISvgIcon IconValue { get; set; } = SvgIcon.FileAdd;
        public string Url { get; set; } = "";
    }
}

<style>
    /* ===== Color Tokens ===== */
    :root {
        --bg-primary: #070b13;
        --bg-secondary: #0f1419;
        --text-primary: #ffffff;
        --text-secondary: #d5d7db;
        --text-muted: #9ca3af;
        --card-bg: #f7f8fa;
        --card-bg-dark: #1a2332;
        --border-color: #2c3240;
        --accent-primary: #0c5ea8;
        --accent-warning: #ffc107;
        --accent-hover: #0a4d8a;
        --shadow-sm: 0 2px 6px rgba(0, 0, 0, 0.4);
        --shadow-md: 0 8px 16px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.4);
    }

    .home-page {
        margin: 0 auto;
        padding: 2rem;
        max-width: 1600px;
        background-color: var(--app-bg, #ffffff);
        color: var(--text, #212529);
    }

    /* Section Headers */
    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color, #e5e7eb);
        letter-spacing: 0.3px;
    }

        .section-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary, #495057);
            letter-spacing: 0.2px;
            line-height: 1.3;
        }

        .section-header .k-svg-icon {
            color: var(--accent);
            font-size: 1.5rem;
        }

    /* Favorites Section with Gradient */
    .favorites-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: linear-gradient(180deg, #fffbdb 0%, #fff9c4 100%);
        border-radius: 12px;
        border: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        animation: fadeIn 0.3s ease-in-out;
    }

        .favorites-section .section-header {
            border-bottom-color: #ffd966;
            margin-bottom: 1.5rem;
        }

            .favorites-section .section-header h2 {
                color: #856404;
            }

            .favorites-section .section-header .k-svg-icon {
                color: var(--accent-warning, #ffc107);
            }

    /* Modules Section */
    .modules-section {
        margin-bottom: 2rem;
    }

    .module-group {
        margin-bottom: 2rem;
        animation: fadeIn 0.4s ease-in-out;
    }

        .module-group:last-child {
            margin-bottom: 0;
        }

    .module-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding: 1rem 1rem;
        background: rgba(12, 94, 168, 0.08);
        border-radius: 8px;
        border-left: 4px solid var(--accent);
        transition: all 0.2s ease-in-out;
    }

        .module-title h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent);
            letter-spacing: 0.3px;
            line-height: 1.3;
        }

        .module-title .k-svg-icon {
            color: var(--accent);
        }

    /* Card Grid */
    .page-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1rem;
    }

    /* Page Cards */
    .page-card {
        position: relative;
        padding: 1.5rem;
        background: var(--card-bg, #ffffff);
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.02);
        animation: slideUp 0.3s ease-in-out backwards;
    }

        .page-card:nth-child(1) {
            animation-delay: 0.05s;
        }

        .page-card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .page-card:nth-child(3) {
            animation-delay: 0.15s;
        }

        .page-card:nth-child(n+4) {
            animation-delay: 0.2s;
        }

        .page-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
            background: rgba(255, 255, 255, 0.98);
        }

        .page-card.favorite {
            border: 1px solid rgba(255, 193, 7, 0.15);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), inset 0 0 1px rgba(255, 193, 7, 0.1);
        }

            .page-card.favorite:hover {
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12), inset 0 0 1px rgba(255, 193, 7, 0.15);
            }

    /* Card Header */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        gap: 0.75rem;
    }

    /* Icon Wrapper */
    .card-icon-wrapper {
        flex-shrink: 0;
        width: 48px;
        height: 48px;
        padding: 12px;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 12px;
        color: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease-in-out;
        font-size: 1.25rem;
    }

        .card-icon-wrapper.favorite {
            background: linear-gradient(135deg, #fff9e6 0%, #ffe082 100%);
            color: #f57c00;
        }

    /* Favorite Button */
    .favorite-btn {
        flex-shrink: 0;
        padding: 0.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
        color: #ccc;
        transition: all 0.2s ease-in-out;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .favorite-btn:hover {
            background: rgba(255, 193, 7, 0.1);
            color: var(--accent-warning, #ffc107);
        }

        .favorite-btn.active {
            color: var(--accent-warning, #ffc107);
        }

            .favorite-btn.active:hover {
                background: rgba(255, 193, 7, 0.15);
            }

        .favorite-btn .k-svg-icon {
            width: 20px;
            height: 20px;
        }

    /* Card Content */
    .page-card h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary, #212529);
        letter-spacing: 0.2px;
        line-height: 1.3;
    }

    .card-description {
        margin: 0 0 1rem 0;
        font-size: 0.9rem;
        color: var(--text-secondary, #6c757d);
        line-height: 1.6;
        letter-spacing: 0.3px;
    }

    .card-meta {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    /* Badge */
    .badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        background: rgba(0, 0, 0, 0.05);
        color: var(--text-primary, #495057);
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s ease-in-out;
    }

    /* Animations */
    @@keyframes fadeIn {
        from

    {
        opacity: 0;
    }

    to {
        opacity: 1;
    }

    }

    @@keyframes slideUp {
        from

    {
        opacity: 0;
        transform: translateY(8px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    /* Smooth transitions for all interactive elements */
    .page-card,
    .favorite-btn,
    .card-icon-wrapper,
    .module-title {
        transition: all 0.2s ease-in-out;
    }

    /* Dark Mode Support */
    @@media (prefers-color-scheme: dark) {
        .home-page

    {
        background-color: var(--app-bg, #0f172a);
        color: var(--text, #f1f5f9);
    }

    .section-header {
        border-bottom-color: var(--border, #2d3748);
    }

        .section-header h2 {
            color: var(--text, #f1f5f9);
        }

    .page-card {
        background: var(--card-bg, #1a2332);
        color: var(--text, #f1f5f9);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.8);
    }

        .page-card:hover {
            background: var(--card-bg, #222d3d);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
        }

        .page-card h3 {
            color: var(--text, #f1f5f9);
        }

    .card-description {
        color: var(--text, #cbd5e0);
    }

    .badge {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text, #e2e8f0);
    }

    .favorite-btn {
        color: var(--border, #4b5563);
    }

        .favorite-btn:hover {
            background: rgba(255, 193, 7, 0.15);
            color: var(--accent-warning, #ffc107);
        }

    }

    /* Responsive Design */
    @@media (max-width: 1200px) {
        .home-page

    {
        padding: 1.5rem;
    }

    .page-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.25rem;
    }

    }

    @@media (max-width: 768px) {
        .home-page

    {
        padding: 1rem;
    }

    .page-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .section-header h2 {
        font-size: 1.25rem;
    }

    .module-title h3 {
        font-size: 1.1rem;
    }

    .page-card {
        padding: 1.25rem;
    }

    .card-icon-wrapper {
        width: 44px;
        height: 44px;
    }

    }

    @@media (max-width: 480px) {
        .home-page

    {
        padding: 0.75rem;
    }

    .section-header {
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

        .section-header h2 {
            font-size: 1.1rem;
        }

    .page-grid {
        gap: 0.75rem;
    }

    .page-card {
        padding: 1rem;
    }

    .card-header {
        margin-bottom: 0.75rem;
    }

    .card-description {
        font-size: 0.85rem;
    }

    }
</style>
