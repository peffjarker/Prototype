@page "/"
@using Telerik.Blazor
@using Telerik.Blazor.Components
@using Prototype.Components.Layout.Navigation.Sidebar
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject ISidebarState Sidebar

<PageTitle>Home - IBN Dealer Suite</PageTitle>

<main class="main-content home-page" data-density="@currentDensity">
    @if (FavoritePages.Any())
    {
        <section class="favorites-section">
            <div class="section-header">
                <TelerikSvgIcon Icon="@SvgIcon.Star" />
                <h2>Favorites</h2>
            </div>

            @if (currentDensity == "compact")
            {
                <!-- Compact: Simple list view -->
                <div class="compact-list">
                    @foreach (var Page in FavoritePages)
                    {
                        <div class="compact-item" @onclick="@(() => NavigateToPage(Page.Url))">
                            <div class="compact-icon">
                                <TelerikSvgIcon Icon="@Page.IconValue" />
                            </div>
                            <div class="compact-content">
                                <h3>@Page.Title</h3>
                                <span class="compact-category">@Page.Category</span>
                            </div>
                            <button class="favorite-btn active"
                                    @onclick="@(() => ToggleFavoriteAsync(Page.Id))"
                                    @onclick:stopPropagation="true"
                                    title="Remove from favorites">
                                <TelerikSvgIcon Icon="@SvgIcon.Star" />
                            </button>
                        </div>
                    }
                </div>
            }
            else
            {
                <!-- Comfortable & Spacious: Card grid -->
                <div class="page-grid">
                    @foreach (var Page in FavoritePages)
                    {
                        <div class="page-card favorite" @onclick="@(() => NavigateToPage(Page.Url))">
                            <div class="card-header">
                                <div class="card-icon-wrapper">
                                    <TelerikSvgIcon Icon="@Page.IconValue" />
                                </div>
                                <button class="favorite-btn active"
                                        @onclick="@(() => ToggleFavoriteAsync(Page.Id))"
                                        @onclick:stopPropagation="true"
                                        title="Remove from favorites">
                                    <TelerikSvgIcon Icon="@SvgIcon.Star" />
                                </button>
                            </div>
                            <h3>@Page.Title</h3>
                            <p class="card-description">@Page.Description</p>
                            <div class="card-meta">
                                <span class="badge">@Page.Category</span>
                            </div>
                        </div>
                    }
                </div>
            }
        </section>
    }

    <section class="modules-section">
        <div class="section-header">
            <TelerikSvgIcon Icon="@SvgIcon.Grid" />
            <h2>All Modules</h2>
        </div>

        @foreach (var module in GetModules())
        {
            <div class="module-group">
                <div class="module-title">
                    <TelerikSvgIcon Icon="@module.IconValue" />
                    <h3>@module.Name</h3>
                </div>

                @if (currentDensity == "compact")
                {
                    <!-- Compact: Simple list view -->
                    <div class="compact-list">
                        @foreach (var Page in module.Pages)
                        {
                            var isFav = IsFavorite(Page.Id);
                            <div class="compact-item" @onclick="@(() => NavigateToPage(Page.Url))">
                                <div class="compact-icon @(isFav ? "favorite" : "")">
                                    <TelerikSvgIcon Icon="@Page.IconValue" />
                                </div>
                                <div class="compact-content">
                                    <h3>@Page.Title</h3>
                                    <span class="compact-category">@Page.Category</span>
                                </div>
                                <button class="favorite-btn @(isFav ? "active" : "")"
                                        @onclick="@(() => ToggleFavoriteAsync(Page.Id))"
                                        @onclick:stopPropagation="true"
                                        title="@(isFav ? "Remove from favorites" : "Add to favorites")">
                                    <TelerikSvgIcon Icon="@SvgIcon.Star" />
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <!-- Comfortable & Spacious: Card grid -->
                    <div class="page-grid">
                        @foreach (var Page in module.Pages)
                        {
                            var isFav = IsFavorite(Page.Id);
                            <div class="page-card" @onclick="@(() => NavigateToPage(Page.Url))">
                                <div class="card-header">
                                    <div class="card-icon-wrapper @(isFav ? "favorite" : "")">
                                        <TelerikSvgIcon Icon="@Page.IconValue" />
                                    </div>
                                    <button class="favorite-btn @(isFav ? "active" : "")"
                                            @onclick="@(() => ToggleFavoriteAsync(Page.Id))"
                                            @onclick:stopPropagation="true"
                                            title="@(isFav ? "Remove from favorites" : "Add to favorites")">
                                        <TelerikSvgIcon Icon="@SvgIcon.Star" />
                                    </button>
                                </div>
                                <h3>@Page.Title</h3>
                                <p class="card-description">@Page.Description</p>
                                <div class="card-meta">
                                    <span class="badge">@Page.Category</span>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </section>
</main>

@code {
    private HashSet<string> FavoritePageIds = new();
    private string currentDensity = "comfortable";

    private List<PageLink> FavoritePages
    {
        get
        {
            var allPages = GetModules().SelectMany(m => m.Pages).ToList();
            return allPages.Where(p => FavoritePageIds.Contains(p.Id)).ToList();
        }
    }

    protected override void OnInitialized()
    {
        Sidebar.ItemSelectedHandler = async (item) =>
        {
            if (!string.IsNullOrWhiteSpace(item.Url))
            {
                Nav.NavigateTo(item.Url);
            }
            await Task.CompletedTask;
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadFavoritesAsync();
            await LoadDensityAsync();
            BuildFavoritesSidebar();
            StateHasChanged();
        }
    }

    private async Task LoadDensityAsync()
    {
        try
        {
            var densityJson = await JS.InvokeAsync<string>("localStorage.getItem", "ibn-density");
            if (!string.IsNullOrEmpty(densityJson))
            {
                currentDensity = System.Text.Json.JsonSerializer.Deserialize<string>(densityJson) ?? "comfortable";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading density: {ex.Message}");
            currentDensity = "comfortable";
        }
    }

    private async Task LoadFavoritesAsync()
    {
        try
        {
            var favoritesJson = await JS.InvokeAsync<string>("localStorage.getItem", "ibn-favorites");
            if (!string.IsNullOrEmpty(favoritesJson))
            {
                var list = System.Text.Json.JsonSerializer.Deserialize<List<string>>(favoritesJson);
                if (list != null)
                {
                    FavoritePageIds = new HashSet<string>(list);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading favorites: {ex.Message}");
        }
    }

    private async Task SaveFavoritesAsync()
    {
        try
        {
            var list = FavoritePageIds.ToList();
            var favoritesJson = System.Text.Json.JsonSerializer.Serialize(list);
            await JS.InvokeVoidAsync("localStorage.setItem", "ibn-favorites", favoritesJson);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving favorites: {ex.Message}");
        }
    }

    private bool IsFavorite(string pageId) => FavoritePageIds.Contains(pageId);

    private async Task ToggleFavoriteAsync(string pageId)
    {
        if (IsFavorite(pageId))
        {
            FavoritePageIds.Remove(pageId);
        }
        else
        {
            FavoritePageIds.Add(pageId);
        }

        await SaveFavoritesAsync();
        BuildFavoritesSidebar();
        StateHasChanged();
    }

    private void BuildFavoritesSidebar()
    {
        if (!FavoritePages.Any())
        {
            Sidebar.ResetAll(hide: true);
            return;
        }

        var favoritesByCategory = FavoritePages
            .GroupBy(p => p.Category)
            .OrderBy(g => g.Key)
            .ToList();

        var sections = new List<SidebarSection>();

        foreach (var categoryGroup in favoritesByCategory)
        {
            var section = new SidebarSection
            {
                SectionKey = categoryGroup.Key,
                Title = categoryGroup.Key,
                Items = categoryGroup.Select(page => new SidebarItem
                {
                    Text = page.Title,
                    Key = page.Id,
                    Url = page.Url,
                    Icon = GetIconSvg(page.IconValue)
                }).ToList()
            };

            sections.Add(section);
        }

        Sidebar.SetSections(sections);
    }

    private string GetIconSvg(ISvgIcon icon)
    {
        if (icon == SvgIcon.Star) return "⭐";
        if (icon == SvgIcon.ListUnordered) return "📋";
        if (icon == SvgIcon.FileAdd) return "📄";
        if (icon == SvgIcon.Inbox) return "📥";
        if (icon == SvgIcon.Search) return "🔍";
        if (icon == SvgIcon.Wrench) return "🔧";
        if (icon == SvgIcon.Dollar) return "💵";
        if (icon == SvgIcon.User) return "👤";
        if (icon == SvgIcon.CheckCircle) return "✅";
        return "";
    }

    private void NavigateToPage(string url)
    {
        Nav.NavigateTo(url);
    }

    private List<Module> GetModules()
    {
        return new List<Module>
        {
            new Module
            {
                Name = "PO / Transfer",
                IconValue = SvgIcon.ArrowsSwap,
                Pages = new List<PageLink>
                {
                    new PageLink
                    {
                        Id = "items-on-order",
                        Title = "Items On Order",
                        Description = "View and manage items on order, track inventory, and monitor PO lines",
                        Category = "PO / Transfer",
                        IconValue = SvgIcon.ListUnordered,
                        Url = "/po-transfer/items-on-order?status=All"
                    },
                    new PageLink
                    {
                        Id = "purchase-orders",
                        Title = "Purchase Orders",
                        Description = "Create, view, and manage purchase orders with vendors",
                        Category = "PO / Transfer",
                        IconValue = SvgIcon.FileAdd,
                        Url = "/po-transfer/purchase-orders?status=All"
                    },
                    new PageLink
                    {
                        Id = "receipt-of-product",
                        Title = "Receipt of Product",
                        Description = "Process incoming shipments and receive products into inventory",
                        Category = "PO / Transfer",
                        IconValue = SvgIcon.Inbox,
                        Url = "/po-transfer/receipt-of-product?status=Open"
                    }
                }
            },
            new Module
            {
                Name = "Product Management",
                IconValue = SvgIcon.Cart,
                Pages = new List<PageLink>
                {
                    new PageLink
                    {
                        Id = "webcat",
                        Title = "Webcat - Item Availability",
                        Description = "Browse catalog items, check availability, and view inventory details",
                        Category = "Product",
                        IconValue = SvgIcon.Search,
                        Url = "/product/webcat?class=All Items"
                    },
                    new PageLink
                    {
                        Id = "set-maintenance",
                        Title = "Set Maintenance",
                        Description = "Manage product sets and their components",
                        Category = "Product",
                        IconValue = SvgIcon.Wrench,
                        Url = "/product/set-maintenance?class=All Items"
                    },
                    new PageLink
                    {
                        Id = "prices",
                        Title = "View/Change Prices",
                        Description = "View pricing history, promotions, and manage product prices",
                        Category = "Product",
                        IconValue = SvgIcon.Dollar,
                        Url = "/product/prices?class=All Items"
                    }
                }
            },
            new Module
            {
                Name = "TechCredit",
                IconValue = SvgIcon.Dollar,
                Pages = new List<PageLink>
                {
                    new PageLink
                    {
                        Id = "customer-information",
                        Title = "Customer Information",
                        Description = "View TechCredit customer details, balances, and transaction history",
                        Category = "TechCredit",
                        IconValue = SvgIcon.User,
                        Url = "/techcredit/customerinformation?option=Information&status=All"
                    },
                    new PageLink
                    {
                        Id = "credit-application",
                        Title = "Credit Application",
                        Description = "Review and manage customer credit applications",
                        Category = "TechCredit",
                        IconValue = SvgIcon.FileAdd,
                        Url = "/techcredit/creditapplication?status=All"
                    },
                    new PageLink
                    {
                        Id = "sales-authorizations",
                        Title = "Sales Authorizations",
                        Description = "Process and review TechCredit sales authorizations",
                        Category = "TechCredit",
                        IconValue = SvgIcon.CheckCircle,
                        Url = "/techcredit/salesauthorizations?status=All"
                    },
                    new PageLink
                    {
                        Id = "wcs",
                        Title = "WCS",
                        Description = "Review TechCredit borrowers and statistics",
                        Category = "TechCredit",
                        IconValue = SvgIcon.CheckCircle,
                        Url = "/techcredit/wcs?status=All"
                    },
                    new PageLink
                    {
                        Id = "payments",
                        Title = "Payments",
                        Description = "Review TechCredit upcoming payments, past due and history",
                        Category = "TechCredit",
                        IconValue = SvgIcon.MoneyExchange,
                        Url = "/techcredit/payments"
                    }
                }
            }
        };
    }

    public class Module
    {
        public string Name { get; set; } = "";
        public ISvgIcon IconValue { get; set; } = SvgIcon.Grid;
        public List<PageLink> Pages { get; set; } = new();
    }

    public class PageLink
    {
        public string Id { get; set; } = "";
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string Category { get; set; } = "";
        public ISvgIcon IconValue { get; set; } = SvgIcon.FileAdd;
        public string Url { get; set; } = "";
    }
}

<style>
    /* ===== Base CSS Variables ===== */
    /* Note: Main theme variables are set by appearance-manager.js */
    /* We only define home-page-specific variables here */

    :root {
        /* Light mode favorites (gold) */
        --home-favorite-bg-light-start: #fffbdb;
        --home-favorite-bg-light-end: #fff9c4;
        --home-favorite-border-light: #ffd966;
        --home-favorite-text-light: #856404;
        /* Dark mode favorites (gray) */
        --home-favorite-bg-dark: var(--nav-bg);
        --home-favorite-border-dark: var(--border);
        --home-favorite-text-dark: var(--muted);
        /* Shadows - will be overridden by appearance manager based on theme */
        --home-shadow-sm: 0 0.5px 1px rgba(0, 0, 0, 0.02);
        --home-shadow-md: 0 1px 3px rgba(0, 0, 0, 0.08);
        --home-shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.12);
    }

    /* ===== Theme-Aware Shadows ===== */
    [data-theme="dark"] {
        --home-shadow-sm: 0 2px 6px rgba(0, 0, 0, 0.4);
        --home-shadow-md: 0 4px 12px rgba(0, 0, 0, 0.5);
        --home-shadow-lg: 0 8px 20px rgba(0, 0, 0, 0.6);
    }

    /* ===== Base Layout ===== */
    .home-page {
        margin: 0 auto;
        max-width: var(--content-max-width, 1600px);
        color: var(--text);
        font-family: var(--base-font-family, inherit);
        font-size: var(--base-font-size, 14px);
        line-height: var(--base-line-height, 1.5);
        transition: all var(--transition-normal, 0.2s) ease;
    }

        /* ===== Density-Specific Padding ===== */
        .home-page[data-density="compact"] {
            padding: 1rem;
        }

        .home-page[data-density="comfortable"] {
            padding: 2rem;
        }

        .home-page[data-density="spacious"] {
            padding: 2.5rem 3rem;
        }

    /* ===== Section Headers ===== */
    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
        letter-spacing: 0.3px;
    }

        .section-header h2 {
            margin: 0;
            font-weight: 600;
            color: var(--text);
            letter-spacing: 0.2px;
            line-height: var(--base-line-height, 1.3);
        }

        .section-header .k-svg-icon {
            color: var(--accent);
        }

    /* Density-specific section header spacing */
    .home-page[data-density="compact"] .section-header {
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
    }

        .home-page[data-density="compact"] .section-header h2 {
            font-size: 1.25rem;
        }

        .home-page[data-density="compact"] .section-header .k-svg-icon {
            font-size: 1.25rem;
        }

    .home-page[data-density="comfortable"] .section-header {
        margin-bottom: 2rem;
    }

        .home-page[data-density="comfortable"] .section-header h2 {
            font-size: 1.5rem;
        }

        .home-page[data-density="comfortable"] .section-header .k-svg-icon {
            font-size: 1.5rem;
        }

    .home-page[data-density="spacious"] .section-header {
        margin-bottom: 2.5rem;
        padding-bottom: 1.25rem;
    }

        .home-page[data-density="spacious"] .section-header h2 {
            font-size: 1.75rem;
        }

        .home-page[data-density="spacious"] .section-header .k-svg-icon {
            font-size: 1.75rem;
        }

    /* ===== Favorites Section ===== */
    .favorites-section {
        padding: 1.5rem;
        background: linear-gradient(180deg, var(--home-favorite-bg-light-start) 0%, var(--home-favorite-bg-light-end) 100%);
        border-radius: var(--radius-lg, 12px);
        border: none;
        box-shadow: var(--home-shadow-sm);
        animation: fadeIn var(--animation-duration, 0.3s) ease-in-out;
    }

    /* Dark mode: gray background */
    [data-theme="dark"] .favorites-section {
        background: var(--home-favorite-bg-dark);
    }

    .home-page[data-density="compact"] .favorites-section {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: var(--radius-md, 8px);
    }

    .home-page[data-density="comfortable"] .favorites-section {
        margin-bottom: 2rem;
    }

    .home-page[data-density="spacious"] .favorites-section {
        margin-bottom: 3rem;
        padding: 2rem;
    }

    .favorites-section .section-header {
        border-bottom-color: var(--home-favorite-border-light);
    }

        .favorites-section .section-header h2 {
            color: var(--home-favorite-text-light);
        }

        .favorites-section .section-header .k-svg-icon {
            color: var(--home-favorite-text-light);
        }

    /* Dark mode: gray border and text */
    [data-theme="dark"] .favorites-section .section-header {
        border-bottom-color: var(--home-favorite-border-dark);
    }

        [data-theme="dark"] .favorites-section .section-header h2 {
            color: var(--home-favorite-text-dark);
        }

        [data-theme="dark"] .favorites-section .section-header .k-svg-icon {
            color: var(--home-favorite-text-dark);
        }

    /* ===== Modules Section ===== */
    .modules-section {
        margin-bottom: 2rem;
    }

    .module-group {
        animation: fadeIn var(--animation-duration, 0.4s) ease-in-out;
    }

    .home-page[data-density="compact"] .module-group {
        margin-bottom: 1.25rem;
    }

        .home-page[data-density="compact"] .module-group:last-child {
            margin-bottom: 0;
        }

    .home-page[data-density="comfortable"] .module-group {
        margin-bottom: 2rem;
    }

        .home-page[data-density="comfortable"] .module-group:last-child {
            margin-bottom: 0;
        }

    .home-page[data-density="spacious"] .module-group {
        margin-bottom: 3rem;
    }

        .home-page[data-density="spacious"] .module-group:last-child {
            margin-bottom: 0;
        }

    /* ===== Module Title ===== */
    .module-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: var(--accent-weak);
        border-radius: var(--radius-md, 8px);
        border-left: 4px solid var(--accent);
        transition: all var(--transition-normal, 0.2s) ease-in-out;
    }

        .module-title h3 {
            margin: 0;
            font-weight: 600;
            color: var(--accent);
            letter-spacing: 0.3px;
            line-height: var(--base-line-height, 1.3);
        }

        .module-title .k-svg-icon {
            color: var(--accent);
        }

    .home-page[data-density="compact"] .module-title {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        border-radius: var(--radius-sm, 6px);
    }

        .home-page[data-density="compact"] .module-title h3 {
            font-size: 1rem;
        }

        .home-page[data-density="compact"] .module-title .k-svg-icon {
            font-size: 1.125rem;
        }

    .home-page[data-density="comfortable"] .module-title {
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

        .home-page[data-density="comfortable"] .module-title h3 {
            font-size: 1.25rem;
        }

        .home-page[data-density="comfortable"] .module-title .k-svg-icon {
            font-size: 1.25rem;
        }

    .home-page[data-density="spacious"] .module-title {
        padding: 1.5rem;
        margin-bottom: 2rem;
        border-radius: var(--radius-md, 10px);
    }

        .home-page[data-density="spacious"] .module-title h3 {
            font-size: 1.5rem;
        }

        .home-page[data-density="spacious"] .module-title .k-svg-icon {
            font-size: 1.5rem;
        }

    /* ===== COMPACT MODE: List View ===== */
    .compact-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .compact-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-md, 8px);
        cursor: pointer;
        transition: all var(--transition-fast, 0.15s) ease;
    }

        .compact-item:hover {
            background: var(--hover-bg);
            border-color: var(--accent);
            box-shadow: var(--home-shadow-sm);
        }

    .compact-icon {
        flex-shrink: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--accent-weak);
        color: var(--accent);
        border-radius: var(--radius-sm, 6px);
        font-size: 1rem;
        transition: all var(--transition-fast, 0.15s) ease;
    }

        .compact-icon.favorite {
            background: rgba(251, 191, 36, 0.15);
            color: #f59e0b;
        }

    .compact-content {
        flex: 1;
        min-width: 0;
    }

        .compact-content h3 {
            margin: 0;
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text);
            letter-spacing: 0.2px;
            line-height: var(--base-line-height, 1.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    .compact-category {
        display: inline-block;
        font-size: 0.75rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    /* ===== CARD GRID (Comfortable & Spacious) ===== */
    .page-grid {
        display: grid;
        margin-bottom: 1rem;
    }

    /* Comfortable density */
    .home-page[data-density="comfortable"] .page-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    /* Spacious density */
    .home-page[data-density="spacious"] .page-grid {
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 2rem;
    }

    /* ===== Page Cards ===== */
    .page-card {
        position: relative;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg, 12px);
        cursor: pointer;
        transition: all var(--transition-normal, 0.2s) ease-in-out;
        box-shadow: var(--home-shadow-sm);
        animation: slideUp var(--animation-duration, 0.3s) ease-in-out backwards;
    }

        .page-card:nth-child(1) {
            animation-delay: 0.05s;
        }

        .page-card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .page-card:nth-child(3) {
            animation-delay: 0.15s;
        }

        .page-card:nth-child(n+4) {
            animation-delay: 0.2s;
        }

        .page-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--home-shadow-lg);
            background: var(--hover-bg);
            border-color: var(--accent);
        }

        .page-card.favorite {
            border-color: rgba(251, 191, 36, 0.3);
            box-shadow: var(--home-shadow-md), inset 0 0 0 1px rgba(251, 191, 36, 0.1);
        }

            .page-card.favorite:hover {
                box-shadow: var(--home-shadow-lg), inset 0 0 0 1px rgba(251, 191, 36, 0.2);
            }

    /* Comfortable card padding */
    .home-page[data-density="comfortable"] .page-card {
        padding: 1.5rem;
    }

    /* Spacious card padding */
    .home-page[data-density="spacious"] .page-card {
        padding: 2rem;
    }

    /* ===== Card Header ===== */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .home-page[data-density="comfortable"] .card-header {
        margin-bottom: 1rem;
    }

    .home-page[data-density="spacious"] .card-header {
        margin-bottom: 1.5rem;
    }

    /* ===== Card Icon Wrapper ===== */
    .card-icon-wrapper {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--accent-weak);
        border-radius: var(--radius-lg, 12px);
        color: var(--accent);
        transition: all var(--transition-normal, 0.2s) ease-in-out;
    }

    .home-page[data-density="comfortable"] .card-icon-wrapper {
        width: 48px;
        height: 48px;
        padding: 12px;
        font-size: 1.25rem;
    }

    .home-page[data-density="spacious"] .card-icon-wrapper {
        width: 56px;
        height: 56px;
        padding: 14px;
        font-size: 1.5rem;
    }

    .card-icon-wrapper.favorite {
        background: rgba(251, 191, 36, 0.15);
        color: #f59e0b;
    }

    /* ===== Favorite Button ===== */
    .favorite-btn {
        flex-shrink: 0;
        padding: 0.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
        color: var(--muted);
        transition: all var(--transition-normal, 0.2s) ease-in-out;
        border-radius: var(--radius-sm, 6px);
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .favorite-btn:hover {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
        }

        .favorite-btn.active {
            color: #fbbf24;
        }

            .favorite-btn.active:hover {
                background: rgba(251, 191, 36, 0.15);
            }

        .favorite-btn .k-svg-icon {
            width: 20px;
            height: 20px;
        }

    /* ===== Card Content ===== */
    .page-card h3 {
        margin: 0;
        font-weight: 600;
        color: var(--text);
        letter-spacing: 0.2px;
        line-height: var(--base-line-height, 1.3);
    }

    .home-page[data-density="comfortable"] .page-card h3 {
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .home-page[data-density="spacious"] .page-card h3 {
        margin-bottom: 0.75rem;
        font-size: 1.25rem;
    }

    .card-description {
        margin: 0;
        color: var(--muted);
        line-height: 1.6;
        letter-spacing: 0.3px;
    }

    .home-page[data-density="comfortable"] .card-description {
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }

    .home-page[data-density="spacious"] .card-description {
        margin-bottom: 1.5rem;
        font-size: 1rem;
    }

    /* ===== Card Meta (Badge) ===== */
    .card-meta {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        background: rgba(0, 0, 0, 0.05);
        color: var(--text);
        border-radius: var(--radius-sm, 6px);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all var(--transition-normal, 0.2s) ease-in-out;
    }

    [data-theme="dark"] .badge {
        background: rgba(255, 255, 255, 0.08);
    }

    /* ===== Animations ===== */
    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(8px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ===== Respect Reduced Motion / No Animations ===== */
    .no-animations .page-card,
    .no-animations .favorites-section,
    .no-animations .module-group,
    .no-animations .compact-item,
    .no-animations .card-icon-wrapper,
    .no-animations .favorite-btn,
    .no-animations .badge {
        animation: none !important;
        transition: none !important;
    }

        .no-animations .page-card:hover {
            transform: none;
        }

    .reduce-motion .page-card,
    .reduce-motion .favorites-section,
    .reduce-motion .module-group,
    .reduce-motion .compact-item,
    .reduce-motion .card-icon-wrapper,
    .reduce-motion .favorite-btn,
    .reduce-motion .badge {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
    }

        .reduce-motion .page-card:hover {
            transform: none;
        }

    /* Also respect system reduced motion preference */
    @@media (prefers-reduced-motion: reduce) {
        .page-card,
        .favorites-section,
        .module-group,
        .compact-item,
        .card-icon-wrapper,
        .favorite-btn,
        .badge {
            animation-duration: 0.01ms !important;
            transition-duration: 0.01ms !important;
        }

            .page-card:hover {
                transform: none;
            }
    }

    /* ===== Border Radius Variations ===== */
    /* None */
    [data-radius="none"] .page-card,
    [data-radius="none"] .favorites-section,
    [data-radius="none"] .compact-item,
    [data-radius="none"] .compact-icon,
    [data-radius="none"] .card-icon-wrapper,
    [data-radius="none"] .favorite-btn,
    [data-radius="none"] .badge,
    [data-radius="none"] .module-title {
        border-radius: 0 !important;
    }

    /* Subtle */
    [data-radius="subtle"] .page-card {
        border-radius: 6px;
    }

    [data-radius="subtle"] .favorites-section {
        border-radius: 6px;
    }

    [data-radius="subtle"] .compact-item,
    [data-radius="subtle"] .module-title {
        border-radius: 4px;
    }

    [data-radius="subtle"] .compact-icon,
    [data-radius="subtle"] .favorite-btn,
    [data-radius="subtle"] .badge {
        border-radius: 3px;
    }

    [data-radius="subtle"] .card-icon-wrapper {
        border-radius: 6px;
    }

    /* Rounded */
    [data-radius="rounded"] .page-card {
        border-radius: 16px;
    }

    [data-radius="rounded"] .favorites-section {
        border-radius: 16px;
    }

    [data-radius="rounded"] .compact-item,
    [data-radius="rounded"] .module-title {
        border-radius: 12px;
    }

    [data-radius="rounded"] .compact-icon,
    [data-radius="rounded"] .favorite-btn,
    [data-radius="rounded"] .badge {
        border-radius: 8px;
    }

    [data-radius="rounded"] .card-icon-wrapper {
        border-radius: 16px;
    }

    /* Extra */
    [data-radius="extra"] .page-card {
        border-radius: 24px;
    }

    [data-radius="extra"] .favorites-section {
        border-radius: 24px;
    }

    [data-radius="extra"] .compact-item,
    [data-radius="extra"] .module-title {
        border-radius: 16px;
    }

    [data-radius="extra"] .compact-icon,
    [data-radius="extra"] .favorite-btn,
    [data-radius="extra"] .badge {
        border-radius: 12px;
    }

    [data-radius="extra"] .card-icon-wrapper {
        border-radius: 24px;
    }

    /* Pill */
    [data-radius="pill"] .page-card {
        border-radius: 32px;
    }

    [data-radius="pill"] .favorites-section {
        border-radius: 32px;
    }

    [data-radius="pill"] .compact-item,
    [data-radius="pill"] .module-title {
        border-radius: 9999px;
    }

    [data-radius="pill"] .compact-icon,
    [data-radius="pill"] .favorite-btn,
    [data-radius="pill"] .badge {
        border-radius: 9999px;
    }

    [data-radius="pill"] .card-icon-wrapper {
        border-radius: 9999px;
    }

    /* ===== Responsive Design ===== */

    /* Tablets and smaller desktops */
    @@media (max-width: 1200px) {
        .home-page[data-density="comfortable"] {
            padding: 1.5rem;
        }

        .home-page[data-density="spacious"] {
            padding: 2rem;
        }

            .home-page[data-density="comfortable"] .page-grid,
            .home-page[data-density="spacious"] .page-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }

        .home-page[data-density="comfortable"] .page-grid {
            gap: 1.25rem;
        }

        .home-page[data-density="spacious"] .page-grid {
            gap: 1.75rem;
        }
    }

    /* Mobile devices */
    @@media (max-width: 768px) {
        .home-page[data-density="comfortable"],
        .home-page[data-density="spacious"] {
            padding: 1rem;
        }

            .home-page[data-density="comfortable"] .page-grid,
            .home-page[data-density="spacious"] .page-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .home-page[data-density="comfortable"] .section-header h2,
            .home-page[data-density="spacious"] .section-header h2 {
                font-size: 1.25rem;
            }

            .home-page[data-density="comfortable"] .module-title h3,
            .home-page[data-density="spacious"] .module-title h3 {
                font-size: 1.1rem;
            }

            .home-page[data-density="comfortable"] .page-card,
            .home-page[data-density="spacious"] .page-card {
                padding: 1.25rem;
            }

            .home-page[data-density="comfortable"] .card-icon-wrapper,
            .home-page[data-density="spacious"] .card-icon-wrapper {
                width: 44px;
                height: 44px;
            }
    }

    /* Small mobile devices */
    @@media (max-width: 480px) {
        .home-page[data-density="compact"],
        .home-page[data-density="comfortable"],
        .home-page[data-density="spacious"] {
            padding: 0.75rem;
        }

        .section-header {
            gap: 0.5rem;
        }

        .home-page[data-density="compact"] .section-header {
            margin-bottom: 0.75rem;
        }

        .home-page[data-density="comfortable"] .section-header,
        .home-page[data-density="spacious"] .section-header {
            margin-bottom: 1.5rem;
        }

        .home-page[data-density="compact"] .section-header h2 {
            font-size: 1.1rem;
        }

        .home-page[data-density="comfortable"] .section-header h2,
        .home-page[data-density="spacious"] .section-header h2 {
            font-size: 1.15rem;
        }

        .compact-list {
            gap: 0.375rem;
        }

        .compact-item {
            padding: 0.625rem 0.75rem;
        }

        .page-grid {
            gap: 0.75rem;
        }

        .page-card {
            padding: 1rem;
        }

        .card-header {
            margin-bottom: 0.75rem;
        }

        .card-description {
            font-size: 0.85rem;
        }
    }
</style>

<script>
    (function() {
        function updateAppearanceAttributes() {
            try {
                // Theme
                const themeJson = localStorage.getItem('ibn-theme');
                let theme = themeJson ? JSON.parse(themeJson) : 'light';
                if (theme === 'auto') {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    theme = prefersDark ? 'dark' : 'light';
                }
                document.documentElement.setAttribute('data-theme', theme);

                // Border radius
                const radiusJson = localStorage.getItem('ibn-borderRadius');
                const radius = radiusJson ? JSON.parse(radiusJson) : 'default';
                document.documentElement.setAttribute('data-radius', radius);

                // Animations
                const animationsJson = localStorage.getItem('ibn-animations');
                const animations = animationsJson ? JSON.parse(animationsJson) : true;
                if (!animations) {
                    document.documentElement.classList.add('no-animations');
                } else {
                    document.documentElement.classList.remove('no-animations');
                }

                // Reduced motion
                const reducedMotionJson = localStorage.getItem('ibn-reducedMotion');
                const reducedMotion = reducedMotionJson ? JSON.parse(reducedMotionJson) : false;
                if (reducedMotion) {
                    document.documentElement.classList.add('reduce-motion');
                } else {
                    document.documentElement.classList.remove('reduce-motion');
                }

            } catch (e) {
                console.error('Error setting appearance attributes:', e);
            }
        }

        // Update immediately
        updateAppearanceAttributes();

        // Listen for storage changes
        window.addEventListener('storage', (e) => {
            if (e.key && e.key.startsWith('ibn-')) {
                updateAppearanceAttributes();
            }
        });

        // Listen for system theme changes when using 'auto'
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateAppearanceAttributes);

        // Also refresh when appearance manager updates
        if (window.refreshAppearance) {
            const originalRefresh = window.refreshAppearance;
            window.refreshAppearance = function() {
                originalRefresh();
                updateAppearanceAttributes();
            };
        }
    })();
</script>
